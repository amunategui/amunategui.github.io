---
---
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="Machine Learning, R Programming, Statistics, Artificial Intelligence">
    <meta name="author" content="Manuel Amunategui">
    <link rel="icon" href="../favicon.ico">

    <title>Data Exploration & Machine Learning, Hands-on</title>

    {% include externals.html %}
  
</head>

<body>

<main role="main">

{% include header.html %}
   
{% include signup.html %}

<div class="container">
  <div class="blog-header">
    <h1 class="blog-title">Predicting Multiple Discrete Values with Multinomials, Neural Networks and the {nnet} Package</h1>
    <p class="lead blog-description">Practical walkthroughs on machine learning, data exploration and finding insight.</p>
  </div>
   
<p><strong>Resources</strong></p>
<ul>
<li type="square"><a href="https://www.youtube.com/watch?v=zTlbMHw9CeY&amp;list=UUq4pm1i_VZqxKVVOz5qRBIA" target="_blank">YouTube Companion Video</a></li>
<li type="square"><a href="#sourcecode">Full Source Code</a></li>
</ul>
<p><br />
<strong>Packages Used in this Walkthrough</strong></p>

<ul>
        <li type="square"><b>{nnet}</b> - neural network multinomial modeling</li>
        <li type="square"><b>{RCurl}</b> - downloads https data</li>
        <li type="square"><b>{caret}</b> - dummyVars and postResample function</li>
</ul>

<p><br /><br /></p>

<p>So, what is a <b>multionmial model</b>?</p>

<p>From <a href="http://en.wikipedia.org/wiki/Multinomial_logistic_regression" target="_blank">Wikipedia</a>:</p>

<blockquote>Multinomial logistic regression is a simple extension of binary logistic regression that allows for more than two categories of the dependent or outcome variable.</blockquote>

<p>And from the <code class="highlighter-rouge">multinom</code> <b>{nnet}</b> help file:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">nnet</span><span class="p">)</span><span class="w">
</span><span class="o">?</span><span class="n">multinom</span><span class="w">
</span></code></pre>
</div>

<blockquote>Fits multinomial log-linear models via neural networks.</blockquote>
<p><br />
In a nutshell, this allows you to predict a factor of multiple levels (more than two) in one shot with the power of neural networks. <b>Neural networks</b> are great at working through multiple combinations and also great with linear models, so it’s an ideal combination.
<br /><br /></p>

<p>If your data is linear in nature, then instead of using multiple models and doing <code class="highlighter-rouge">A</code> versus <code class="highlighter-rouge">B</code>, <code class="highlighter-rouge">B</code> versus <code class="highlighter-rouge">C</code>, and <code class="highlighter-rouge">C</code> versus <code class="highlighter-rouge">A</code>, and finally going through the hassle of concatenating the resulting probabilities, you can let <b>nnet</b> do it all in one shot. And this becomes exponentialy more difficult as you predict more than 3 outcome levels!!
<br /><br /></p>

<p>The <code class="highlighter-rouge">multinom</code> function will do all that for you in one shot and allow you to observe the probabilities of each subset to interpret things (now that’s really cool).
<br /><br /></p>

<p><strong>Let’s code!</strong></p>

<p>We’re going to use a <a href="http://had.co.nz/" target="_blank">Hadley Wickham</a> data set to predict how many cylinders a vehicle has. We download the data from <a href="https://github.com/hadley" target="_blank">Github</a>:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">RCurl</span><span class="p">)</span><span class="w">
</span><span class="n">urlfile</span><span class="w"> </span><span class="o">&lt;-</span><span class="s1">'https://raw.githubusercontent.com/hadley/fueleconomy/master/data-raw/vehicles.csv'</span><span class="w">
</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">getURL</span><span class="p">(</span><span class="n">urlfile</span><span class="p">,</span><span class="w"> </span><span class="n">ssl.verifypeer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">
</span><span class="n">vehicles</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="n">textConnection</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="w">
</span></code></pre>
</div>
<p><br /><br />
Only use the first 24 columns of the data for simplicities sake. Cast all variables to numerics and impute any NAs with <code class="highlighter-rouge">0</code>.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">vehicles</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">vehicles</span><span class="p">[</span><span class="nf">names</span><span class="p">(</span><span class="n">vehicles</span><span class="p">)[</span><span class="m">1</span><span class="o">:</span><span class="m">24</span><span class="p">]]</span><span class="w">
</span><span class="n">vehicles</span><span class="p">[</span><span class="nf">is.na</span><span class="p">(</span><span class="n">vehicles</span><span class="p">)]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0</span><span class="w">
</span><span class="nf">names</span><span class="p">(</span><span class="n">vehicles</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>##  [1] "barrels08"       "barrelsA08"      "charge120"      
##  [4] "charge240"       "city08"          "city08U"        
##  [7] "cityA08"         "cityA08U"        "cityCD"         
## [10] "cityE"           "cityUF"          "co2"            
## [13] "co2A"            "co2TailpipeAGpm" "co2TailpipeGpm" 
## [16] "comb08"          "comb08U"         "combA08"        
## [19] "combA08U"        "combE"           "combinedCD"     
## [22] "combinedUF"      "cylinders"       "displ"
</code></pre>
</div>
<p><br /><br />
Use the <code class="highlighter-rouge">cyclinder</code> column as the model’s outcome and cast it to a factor. Use the <code class="highlighter-rouge">table</code> function to see how many types of cylinders we are dealing with (BTW a <code class="highlighter-rouge">0</code> cylinder vehicle is an electric vehicle):</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">vehicles</span><span class="o">$</span><span class="n">cylinders</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.factor</span><span class="p">(</span><span class="n">vehicles</span><span class="o">$</span><span class="n">cylinders</span><span class="p">)</span><span class="w">
</span><span class="n">table</span><span class="p">(</span><span class="n">vehicles</span><span class="o">$</span><span class="n">cylinders</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## 
##     0     2     3     4     5     6     8    10    12    16 
##    66    51   182 13133   757 12101  7715   138   481     7
</code></pre>
</div>
<p>We see that the 4 and 6 cylinder vehicles are the most numerous.
<br /><br /></p>

<p>Shuffle the data and split it into two equal data frames so we can have a training and a testing data set:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">set.seed</span><span class="p">(</span><span class="m">1234</span><span class="p">)</span><span class="w">
</span><span class="n">vehicles</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">vehicles</span><span class="p">[</span><span class="n">sample</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">vehicles</span><span class="p">)),]</span><span class="w">
</span><span class="n">split</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">floor</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">vehicles</span><span class="p">)</span><span class="o">/</span><span class="m">2</span><span class="p">)</span><span class="w">
</span><span class="n">vehiclesTrain</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">vehicles</span><span class="p">[</span><span class="m">0</span><span class="o">:</span><span class="n">split</span><span class="p">,]</span><span class="w">
</span><span class="n">vehiclesTest</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">vehicles</span><span class="p">[(</span><span class="n">split</span><span class="m">+1</span><span class="p">)</span><span class="o">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">vehicles</span><span class="p">),]</span><span class="w">
</span></code></pre>
</div>

<p><br /><br />
Let’s put <b>nnet</b> to work and predict cyclinders. The <code class="highlighter-rouge">maxiter</code> variable defaults to 100 when omitted so let’s start with a large number during the first round to make sure we find the lowest possible error level (i.e. global minimum - solution with the lowest error possible):</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">nnet</span><span class="p">)</span><span class="w">
</span><span class="n">cylModel</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">multinom</span><span class="p">(</span><span class="n">cylinders</span><span class="o">~</span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">vehiclesTrain</span><span class="p">,</span><span class="w"> </span><span class="n">maxit</span><span class="o">=</span><span class="m">500</span><span class="p">,</span><span class="w"> </span><span class="n">trace</span><span class="o">=</span><span class="nb">T</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## # weights:  250 (216 variable)
## initial  value 39869.260885 
## iter  10 value 18697.133750
...
## iter 420 value 5217.401201
## final  value 5217.398483 
## converged
</code></pre>
</div>
<p>When you see the word <b>converged</b> in the log output, you know the model went as far as it could.
<br /><br />
Let’s find the most influential variables by using <b>caret’s</b> <code class="highlighter-rouge">varImp</code> function:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">caret</span><span class="p">)</span><span class="w">
</span><span class="n">mostImportantVariables</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">varImp</span><span class="p">(</span><span class="n">cylModel</span><span class="p">)</span><span class="w">
</span><span class="n">mostImportantVariables</span><span class="o">$</span><span class="n">Variables</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">row.names</span><span class="p">(</span><span class="n">mostImportantVariables</span><span class="p">)</span><span class="w">
</span><span class="n">mostImportantVariables</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mostImportantVariables</span><span class="p">[</span><span class="n">order</span><span class="p">(</span><span class="o">-</span><span class="n">mostImportantVariables</span><span class="o">$</span><span class="n">Overall</span><span class="p">),]</span><span class="w">
</span><span class="n">print</span><span class="p">(</span><span class="n">head</span><span class="p">(</span><span class="n">mostImportantVariables</span><span class="p">))</span><span class="w">
</span></code></pre>
</div>
<div class="highlighter-rouge"><pre class="highlight"><code>## Variables  Overall    
## charge240  625.5732   
## cityUF     596.4079      
## combinedUF 580.1112  
## displ      434.8038
## cityE      395.3533       
## combA08    322.2910     
</code></pre>
</div>
{% include follow-me.html %}
<p><br /><br />
Next we predict <code class="highlighter-rouge">cylinders</code> using the <code class="highlighter-rouge">predict</code> function on the testing data set. There are two ways to compute predictions, <code class="highlighter-rouge">class</code> or <code class="highlighter-rouge">probs</code>:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">preds1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">cylModel</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s2">"probs"</span><span class="p">,</span><span class="w"> </span><span class="n">newdata</span><span class="o">=</span><span class="n">vehiclesTest</span><span class="p">)</span><span class="w">
</span><span class="n">head</span><span class="p">(</span><span class="n">preds1</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>##                0          2          3         4         5         6
## 30632  1.966e-53  2.770e-38  3.232e-40 3.024e-02 4.728e-02 0.9222608
## 26204  4.310e-33 8.316e-112  5.884e-21 9.297e-01 3.009e-02 0.0401936
## 27378  1.211e-92  7.384e-65  5.948e-75 7.352e-09 2.823e-05 0.2919979
## 12346  2.808e-48  9.065e-29  3.301e-37 4.767e-02 9.357e-02 0.8580807
## 13664  2.428e-27  4.287e-33  8.640e-21 9.643e-01 2.190e-02 0.0137845
## 3357  1.654e-146 2.447e-119 2.731e-111 3.014e-17 2.733e-10 0.0004251
##               8        10        12         16
## 30632 2.198e-04 4.059e-09 2.837e-09  2.457e-89
## 26204 1.523e-06 6.732e-13 3.522e-16  4.859e-95
## 27378 7.019e-01 3.665e-03 2.452e-03  9.845e-46
## 12346 6.820e-04 9.299e-08 1.057e-07  3.385e-87
## 13664 7.224e-08 6.902e-14 7.690e-15 1.406e-111
## 3357  8.994e-01 2.395e-02 7.627e-02  4.517e-45
</code></pre>
</div>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">preds2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">cylModel</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s2">"class"</span><span class="p">,</span><span class="w"> </span><span class="n">newdata</span><span class="o">=</span><span class="n">vehiclesTest</span><span class="p">)</span><span class="w">
</span><span class="n">head</span><span class="p">(</span><span class="n">preds2</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## [1] 6 4 8 6 4 8
## Levels: 0 2 3 4 5 6 8 10 12 16
</code></pre>
</div>

<p>Choosing which of the two predictions will depend on your needs. If you just want your <code class="highlighter-rouge">cylinders</code> predictions, use <code class="highlighter-rouge">class</code>, if you need to do anything more complex, like measure the conviction of each prediction, use the <code class="highlighter-rouge">probs</code> option (every row will add up to 1).
<br /><br /></p>

<p>To check the <b>accuracy</b> of the model, we call the <code class="highlighter-rouge">postResample</code> function from <b>caret</b>. For numeric vectors, it uses the mean squared error and R-squared and for factors, the overall agreement rate and Kappa:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">postResample</span><span class="p">(</span><span class="n">vehiclesTest</span><span class="o">$</span><span class="n">cylinders</span><span class="p">,</span><span class="n">preds2</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## Accuracy    Kappa 
##   0.9034   0.8566
</code></pre>
</div>
<p><br /><br />
As a bonus, lets do some simple repeated cross validation to get a more comprehensive mean accuracy score and understand convergence. The code below will iterate through all the data to give every variable a chance of being <b>test</b> and <b>train</b> data sets. The first time around we set <code class="highlighter-rouge">maxit</code> to only <b>50</b>:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">totalAccuracy</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">()</span><span class="w">
</span><span class="n">cv</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="n">cvDivider</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">floor</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">vehicles</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">cv</span><span class="m">+1</span><span class="p">))</span><span class="w">
 
</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">cv</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">cv</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="c1"># assign chunk to data test
</span><span class="w">  </span><span class="n">dataTestIndex</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">((</span><span class="n">cv</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cvDivider</span><span class="p">)</span><span class="o">:</span><span class="p">(</span><span class="n">cv</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cvDivider</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cvDivider</span><span class="p">))</span><span class="w">
  </span><span class="n">dataTest</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">vehicles</span><span class="p">[</span><span class="n">dataTestIndex</span><span class="p">,]</span><span class="w">
  </span><span class="c1"># everything else to train
</span><span class="w">  </span><span class="n">dataTrain</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">vehicles</span><span class="p">[</span><span class="o">-</span><span class="n">dataTestIndex</span><span class="p">,]</span><span class="w">
 
  </span><span class="n">cylModel</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">multinom</span><span class="p">(</span><span class="n">cylinders</span><span class="o">~</span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">dataTrain</span><span class="p">,</span><span class="w"> </span><span class="n">maxit</span><span class="o">=</span><span class="m">50</span><span class="p">,</span><span class="w"> </span><span class="n">trace</span><span class="o">=</span><span class="nb">T</span><span class="p">)</span><span class="w"> 
 
  </span><span class="n">pred</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">cylModel</span><span class="p">,</span><span class="w"> </span><span class="n">newdata</span><span class="o">=</span><span class="n">dataTest</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s2">"class"</span><span class="p">)</span><span class="w">
 
  </span><span class="c1">#  classification error
</span><span class="w">  </span><span class="n">cv_ac</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">postResample</span><span class="p">(</span><span class="n">dataTest</span><span class="o">$</span><span class="n">cylinders</span><span class="p">,</span><span class="w"> </span><span class="n">pred</span><span class="p">)[[</span><span class="m">1</span><span class="p">]]</span><span class="w">
  </span><span class="n">print</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s1">'Current Accuracy:'</span><span class="p">,</span><span class="n">cv_ac</span><span class="p">,</span><span class="s1">'for CV:'</span><span class="p">,</span><span class="n">cv</span><span class="p">))</span><span class="w">
  </span><span class="n">totalAccuracy</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">totalAccuracy</span><span class="p">,</span><span class="w"> </span><span class="n">cv_ac</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## stopped after 50 iterations
## [1] "Current Accuracy: 0.62559542711972 for CV: 1"
...
## stopped after 50 iterations
## [1] "Current Accuracy: 0.650682756430613 for CV: 2"
...
## stopped after 50 iterations
## [1] "Current Accuracy: 0.613210543029533 for CV: 3"
...
## stopped after 50 iterations
## [1] "Current Accuracy: 0.657669101302001 for CV: 4"
...
## stopped after 50 iterations
## [1] "Current Accuracy: 0.607494442680216 for CV: 5"
...
## stopped after 50 iterations
## [1] "Current Accuracy: 0.644649094950778 for CV: 6"
...
## stopped after 50 iterations
## [1] "Current Accuracy: 0.70593839314068 for CV: 7"
...
## stopped after 50 iterations
## [1] "Current Accuracy: 0.621149571292474 for CV: 8"
...
## stopped after 50 iterations
## [1] "Current Accuracy: 0.59892029215624 for CV: 9"
...
## stopped after 50 iterations
## [1] "Current Accuracy: 0.62432518259765 for CV: 10"
</code></pre>
</div>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">totalAccuracy</span><span class="p">)</span><span class="w">  
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## [1] 0.635
</code></pre>
</div>
<p>The <b>mean accuracy</b> of <b>0.635</b> is much lower than the accuracy of <b>0.9034</b> that we got with the original simple split. You will notice that the log output never prints the word <b>converged</b>. This means the model never reaches the lowest error or global minima and therefore isn’t the best fit.
<br /><br />
Let’s try this again and let the model converge by setting the <code class="highlighter-rouge">maxit</code> to a large number</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">totalAccuracy</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">()</span><span class="w">
</span><span class="n">cv</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="n">cvDivider</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">floor</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">vehicles</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">cv</span><span class="m">+1</span><span class="p">))</span><span class="w">
 
</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">cv</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">cv</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
  </span><span class="c1"># assign chunk to data test
</span><span class="w">  </span><span class="n">dataTestIndex</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">((</span><span class="n">cv</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cvDivider</span><span class="p">)</span><span class="o">:</span><span class="p">(</span><span class="n">cv</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cvDivider</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cvDivider</span><span class="p">))</span><span class="w">
  </span><span class="n">dataTest</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">vehicles</span><span class="p">[</span><span class="n">dataTestIndex</span><span class="p">,]</span><span class="w">
  </span><span class="c1"># everything else to train
</span><span class="w">  </span><span class="n">dataTrain</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">vehicles</span><span class="p">[</span><span class="o">-</span><span class="n">dataTestIndex</span><span class="p">,]</span><span class="w">
 
  </span><span class="n">cylModel</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">multinom</span><span class="p">(</span><span class="n">cylinders</span><span class="o">~</span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">dataTrain</span><span class="p">,</span><span class="w"> </span><span class="n">maxit</span><span class="o">=</span><span class="m">1000</span><span class="p">,</span><span class="w"> </span><span class="n">trace</span><span class="o">=</span><span class="nb">T</span><span class="p">)</span><span class="w"> 
 
  </span><span class="n">pred</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">cylModel</span><span class="p">,</span><span class="w"> </span><span class="n">newdata</span><span class="o">=</span><span class="n">dataTest</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s2">"class"</span><span class="p">)</span><span class="w">
 
  </span><span class="c1">#  classification error
</span><span class="w">  </span><span class="n">cv_ac</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">postResample</span><span class="p">(</span><span class="n">dataTest</span><span class="o">$</span><span class="n">cylinders</span><span class="p">,</span><span class="w"> </span><span class="n">pred</span><span class="p">)[[</span><span class="m">1</span><span class="p">]]</span><span class="w">
  </span><span class="n">print</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s1">'Current Accuracy:'</span><span class="p">,</span><span class="n">cv_ac</span><span class="p">,</span><span class="s1">'for CV:'</span><span class="p">,</span><span class="n">cv</span><span class="p">))</span><span class="w">
  </span><span class="n">totalAccuracy</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">totalAccuracy</span><span class="p">,</span><span class="w"> </span><span class="n">cv_ac</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## converged
## [1] "Current Accuracy: 0.905366783105748 for CV: 1"

## converged
## [1] "Current Accuracy: 0.89838043823436 for CV: 2"

## converged
## [1] "Current Accuracy: 0.909812638932995 for CV: 3"

## converged
## [1] "Current Accuracy: 0.904096538583677 for CV: 4"

## converged
## [1] "Current Accuracy: 0.906637027627818 for CV: 5"
 
## converged
## [1] "Current Accuracy: 0.906001905366783 for CV: 6"

## converged
## [1] "Current Accuracy: 0.911400444585583 for CV: 7"

## converged
## [1] "Current Accuracy: 0.902508732931089 for CV: 8"

## converged
## [1] "Current Accuracy: 0.90377897745316 for CV: 9"
 
## converged
## [1] "Current Accuracy: 0.904414099714195 for CV: 10"
</code></pre>
</div>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">mean</span><span class="p">(</span><span class="n">totalAccuracy</span><span class="p">)</span><span class="w">  

</span><span class="c1">## [1] 0.9052
</span></code></pre>
</div>
<p>The score using the <b>repeated cross validation</b> code is better than the original simple split of <b>0.9304</b> and we let each loop converge. The point of using the <b>repeated cross validation</b> code isn’t that it will return a higher accuracy score (and it doesn’t always) but that it will give you a much more accurate score as it uses all of your data.</p>

<p><br /><br />      <br />
<a id="sourcecode">Full source code (<a href="https://github.com/amunategui/MultinomWalkThru" target="_blank">also on GitHub</a>)</a>:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="w">

</span><span class="n">library</span><span class="p">(</span><span class="n">nnet</span><span class="p">)</span><span class="w">
</span><span class="o">?</span><span class="n">multinom</span><span class="w">

</span><span class="n">library</span><span class="p">(</span><span class="n">caret</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">RCurl</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">Metrics</span><span class="p">)</span><span class="w">

</span><span class="c1">#####################################################################
# Load data from Hadley Wickham on Github 
</span><span class="n">urlfile</span><span class="w"> </span><span class="o">&lt;-</span><span class="s1">'https://raw.githubusercontent.com/hadley/fueleconomy/master/data-raw/vehicles.csv'</span><span class="w">
</span><span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">getURL</span><span class="p">(</span><span class="n">urlfile</span><span class="p">,</span><span class="w"> </span><span class="n">ssl.verifypeer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w">
</span><span class="n">vehicles</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="n">textConnection</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="w">

</span><span class="c1"># clean up the data and only use the first 24 columns
</span><span class="n">vehicles</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">vehicles</span><span class="p">[</span><span class="nf">names</span><span class="p">(</span><span class="n">vehicles</span><span class="p">)[</span><span class="m">1</span><span class="o">:</span><span class="m">24</span><span class="p">]]</span><span class="w">
</span><span class="n">vehicles</span><span class="p">[</span><span class="nf">is.na</span><span class="p">(</span><span class="n">vehicles</span><span class="p">)]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0</span><span class="w">

</span><span class="c1"># use cyclinder column as outcome and cast to factor
</span><span class="n">vehicles</span><span class="o">$</span><span class="n">cylinders</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.factor</span><span class="p">(</span><span class="n">vehicles</span><span class="o">$</span><span class="n">cylinders</span><span class="p">)</span><span class="w">
</span><span class="n">table</span><span class="p">(</span><span class="n">vehicles</span><span class="o">$</span><span class="n">cylinders</span><span class="p">)</span><span class="w">
</span><span class="c1">#####################################################################
</span><span class="w">

</span><span class="c1"># shuffle and split
</span><span class="n">set.seed</span><span class="p">(</span><span class="m">1234</span><span class="p">)</span><span class="w">
</span><span class="n">vehicles</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">vehicles</span><span class="p">[</span><span class="n">sample</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">vehicles</span><span class="p">)),]</span><span class="w">
</span><span class="n">split</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">floor</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">vehicles</span><span class="p">)</span><span class="o">/</span><span class="m">2</span><span class="p">)</span><span class="w">
</span><span class="n">vehiclesTrain</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">vehicles</span><span class="p">[</span><span class="m">0</span><span class="o">:</span><span class="n">split</span><span class="p">,]</span><span class="w">
</span><span class="n">vehiclesTest</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">vehicles</span><span class="p">[(</span><span class="n">split</span><span class="m">+1</span><span class="p">)</span><span class="o">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">vehicles</span><span class="p">),]</span><span class="w">


</span><span class="c1"># see how multinom predicts cylinders
# set the maxit to a large number, enough so the neural net can converge to smallest error
</span><span class="n">cylModel</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">multinom</span><span class="p">(</span><span class="n">cylinders</span><span class="o">~</span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">vehiclesTrain</span><span class="p">,</span><span class="w"> </span><span class="n">maxit</span><span class="o">=</span><span class="m">500</span><span class="p">,</span><span class="w"> </span><span class="n">trace</span><span class="o">=</span><span class="nb">T</span><span class="p">)</span><span class="w">

</span><span class="c1"># Sort by most influential variables
</span><span class="n">topModels</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">varImp</span><span class="p">(</span><span class="n">cylModel</span><span class="p">)</span><span class="w">
</span><span class="n">topModels</span><span class="o">$</span><span class="n">Variables</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">row.names</span><span class="p">(</span><span class="n">topModels</span><span class="p">)</span><span class="w">
</span><span class="n">topModels</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">topModels</span><span class="p">[</span><span class="n">order</span><span class="p">(</span><span class="o">-</span><span class="n">topModels</span><span class="o">$</span><span class="n">Overall</span><span class="p">),]</span><span class="w">

</span><span class="c1"># class/probs (best option, second best option?)
</span><span class="n">preds1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">cylModel</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s2">"probs"</span><span class="p">,</span><span class="w"> </span><span class="n">newdata</span><span class="o">=</span><span class="n">vehiclesTest</span><span class="p">)</span><span class="w">
</span><span class="n">preds2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">cylModel</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s2">"class"</span><span class="p">,</span><span class="w"> </span><span class="n">newdata</span><span class="o">=</span><span class="n">vehiclesTest</span><span class="p">)</span><span class="w">

</span><span class="c1"># resample for accuracy - the mean squared error and R-squared are calculated of forfactors, the overall agreement rate and Kappa
</span><span class="n">postResample</span><span class="p">(</span><span class="n">vehiclesTest</span><span class="o">$</span><span class="n">cylinders</span><span class="p">,</span><span class="n">preds2</span><span class="p">)[[</span><span class="m">1</span><span class="p">]]</span><span class="w">

</span><span class="n">library</span><span class="p">(</span><span class="n">Metrics</span><span class="p">)</span><span class="w">
</span><span class="n">classificationError</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ce</span><span class="p">(</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">vehiclesTest</span><span class="o">$</span><span class="n">cylinders</span><span class="p">),</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">preds2</span><span class="p">))</span><span class="w">

</span><span class="c1"># repeat cross validate by iterating through all the data to give every variable a chance of being test and train portions
</span><span class="n">totalError</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">()</span><span class="w">
</span><span class="n">cv</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">10</span><span class="w">
</span><span class="n">maxiterations</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">500</span><span class="w"> </span><span class="c1"># try it again with a lower value and notice the mean error
</span><span class="n">cvDivider</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">floor</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">vehiclesTrain</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">cv</span><span class="m">+1</span><span class="p">))</span><span class="w">

</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">cv</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">cv</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="c1"># assign chunk to data test
</span><span class="w">        </span><span class="n">dataTestIndex</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">((</span><span class="n">cv</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cvDivider</span><span class="p">)</span><span class="o">:</span><span class="p">(</span><span class="n">cv</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cvDivider</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cvDivider</span><span class="p">))</span><span class="w">
        </span><span class="n">dataTest</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">vehiclesTrain</span><span class="p">[</span><span class="n">dataTestIndex</span><span class="p">,]</span><span class="w">
        </span><span class="c1"># everything else to train
</span><span class="w">        </span><span class="n">dataTrain</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">vehiclesTrain</span><span class="p">[</span><span class="o">-</span><span class="n">dataTestIndex</span><span class="p">,]</span><span class="w">
        
        </span><span class="n">cylModel</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">multinom</span><span class="p">(</span><span class="n">cylinders</span><span class="o">~</span><span class="n">.</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="o">=</span><span class="n">dataTrain</span><span class="p">,</span><span class="w"> </span><span class="n">maxit</span><span class="o">=</span><span class="n">maxiterations</span><span class="p">,</span><span class="w"> </span><span class="n">trace</span><span class="o">=</span><span class="nb">T</span><span class="p">)</span><span class="w"> 
        
        </span><span class="n">pred</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">cylModel</span><span class="p">,</span><span class="w"> </span><span class="n">dataTest</span><span class="p">)</span><span class="w">
        
        </span><span class="c1">#  classification error
</span><span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ce</span><span class="p">(</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">dataTest</span><span class="o">$</span><span class="n">cylinders</span><span class="p">),</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">pred</span><span class="p">))</span><span class="w">
        </span><span class="n">totalError</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">totalError</span><span class="p">,</span><span class="w"> </span><span class="n">err</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="n">print</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s1">'Mean error of all repeated cross validations:'</span><span class="p">,</span><span class="n">mean</span><span class="p">(</span><span class="n">totalError</span><span class="p">)))</span><span class="w">


</span></code></pre>
</div>

		
</div>
<p>Manuel Amunategui - Follow me on Twitter: @amunategui</p>

		</div>		 
	 </div>   

</main>
{% include mid_point_ad.html %}

{% include footer.html %}
  </body>
</html>
