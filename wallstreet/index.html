---
---
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="Machine Learning, R Programming, Statistics, Artificial Intelligence">
    <meta name="author" content="Manuel Amunategui">
    <link rel="icon" href="../favicon.ico">

    <title>Data Exploration & Machine Learning, Hands-on</title>

    {% include externals.html %}
  
</head>

<body>

<main role="main">

{% include header.html %}
  

<div class="container">
  <div class="blog-header">
    <h1 class="blog-title">Let's Get Rich! See how {quantmod} And R Can Enrich Your Knowledge Of The Financial Markets!</h1>
    <p class="lead blog-description">Practical walkthroughs on machine learning, data exploration and finding insight.</p>
  </div>
   
 <p>
 <strong>Resources</strong></p>
<ul>
<li type="square"><a href="https://www.youtube.com/watch?v=lDgvaJFpybU&amp;list=UUq4pm1i_VZqxKVVOz5qRBIA" target="_blank">YouTube Companion Video</a></li>
<li type="square"><a href="#sourcecode">Full Source Code</a></li>
<li type="square"><a href="#sourcecode_gbm">Alternative GBM Source Code &lt;- for those that can't use xgboost!!!</a></li>
</ul>
<p><br />
<strong>Packages Used in this Walkthrough</strong></p>
<ul>
        <li type="square"><b>{quantmod}</b> - financial data and modeling tools</li>
        <li type="square"><b>{xts}</b> - handling of time-based data classes</li>
        <li type="square"><b>{xgboost}</b> - fast modeling algorithm</li>
        <li type="square"><b>{pROC}</b> - Area Under the Curve (AUC) functions</li>
</ul>

<p><br /><br /></p>

<p>This walkthrough has two parts:</p>

<ol type="1">
 <li>The first part is a very basic introduction to <b>quantmod</b> and, if you haven't used it before and need basic access to daily stock market data and charting, then you're in for a <b>huge</b> treat.</li>
<li>The second part goes deeper into quantitative finance by leveraging <b>quantmod</b> to access all the stocks composing the <a href="http://www.nasdaq.com/markets/indices/nasdaq-100.aspx" target="_blank&gt;">NASDAQ 100 Index</a> to build a vocabulary of market moves and attempt to predict whether the following trading day's <b>volumne</b> will be <b>higher</b> or <b>lower</b>.</li>
</ol>

<p><br /><br />
<b>quantmod</b> stands for <i>“Quantitative Financial Modeling and Trading Framework for R”</i>
<br /><br />
It has many features so check out the help file for a full coverage or the <a href="http://www.quantmod.com/" target="_blank">Quantmod’s official website</a>.
<br /><br />
Let’s see how Amazon has been doing lately:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">quantmod</span><span class="p">)</span><span class="w">
</span><span class="n">getSymbols</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"AMZN"</span><span class="p">))</span><span class="w">
</span></code></pre>
</div>
<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">barChart</span><span class="p">(</span><span class="n">AMZN</span><span class="p">,</span><span class="n">theme</span><span class="o">=</span><span class="s1">'white.mono'</span><span class="p">,</span><span class="n">bar.type</span><span class="o">=</span><span class="s1">'hlc'</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>
<p><br /><br />
<img src="img/unnamed-chunk-1.png" alt="plot of chunk unnamed-chunk-1" />
<br /><br />
The <code class="highlighter-rouge">getSymbols</code> function downloaded daily data going all the way back to January 2007. The <code class="highlighter-rouge">barChart</code> function displays the data in a nice clean fashion following a theme-based parameter (<a href="http://www.quantmod.com/" target="_blank">see the help file for more</a>). Not bad for 2 lines of code!!
<br /><br />
It gets better - let’s see how easy it is to display a full stock chart with indicators in just 3 lines of code:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">getSymbols</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"^GSPC"</span><span class="p">))</span><span class="w">
</span><span class="n">chartSeries</span><span class="p">(</span><span class="n">GSPC</span><span class="p">,</span><span class="w"> </span><span class="n">subset</span><span class="o">=</span><span class="s1">'last 3 months'</span><span class="p">)</span><span class="w">
</span><span class="n">addBBands</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="n">sd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">ma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"SMA"</span><span class="p">,</span><span class="w"> </span><span class="n">draw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'bands'</span><span class="p">,</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-1</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>
<p><br /><br />
<img src="img/unnamed-chunk-22.png" alt="plot of chunk unnamed-chunk-22" />
<br /><br />
<b>quantmod</b> uses <b>Yahoo</b> to get it’s financial data. In the above example <code class="highlighter-rouge">^GSPC</code> represents the <b>S&amp;P 500 Index</b>. Most financial product symbols are straightforward like <b>MSFT</b> for <b>Microsoft</b>. For indexes and other esoteric symbols, refer to <a href="http://finance.yahoo.com/lookup" target="_blank">finance.yahoo.com/lookup</a> to see how they abbreviated it.
<br /><br />
<code class="highlighter-rouge">chartSeries</code> is straightforward and will plot whatever symbol has been downloaded to memory using <code class="highlighter-rouge">getSymbols</code>. <code class="highlighter-rouge">addBBands</code> function will plot <b>Bollinger Bands</b> around your price series. There are many ways to customize the display, for some examples check out the <a href="http://www.quantmod.com/gallery/" target="_blank">Quantmod Gallery</a>.
<br /><br />
<strong>Quant Time</strong>
<br /><br />
Moving deeper into quantitative finance, let’s design a pattern-based system to predict whether a particular financial product will see a raise or drop in volume the following trading day.
<br /><br />
We’ll use <b>quantmod</b> to download all the stocks that compose the <b>NASDAQ 100 Index</b>. Then we’ll <code class="highlighter-rouge">merge</code> together all our time series to synchronize them. This will collate the data by time and fill in any missing data with <code class="highlighter-rouge">NA</code>s:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">Nasdaq100_Symbols</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"AAPL"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ADBE"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ADI"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ADP"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ADSK"</span><span class="p">,</span><span class="w"> </span><span class="s2">"AKAM"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ALTR"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ALXN"</span><span class="p">,</span><span class="w">
</span><span class="s2">"AMAT"</span><span class="p">,</span><span class="w"> </span><span class="s2">"AMGN"</span><span class="p">,</span><span class="w"> </span><span class="s2">"AMZN"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ATVI"</span><span class="p">,</span><span class="w"> </span><span class="s2">"AVGO"</span><span class="p">,</span><span class="w"> </span><span class="s2">"BBBY"</span><span class="p">,</span><span class="w"> </span><span class="s2">"BIDU"</span><span class="p">,</span><span class="w"> </span><span class="s2">"BIIB"</span><span class="p">,</span><span class="w">
</span><span class="s2">"BRCM"</span><span class="p">,</span><span class="w"> </span><span class="s2">"CA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"CELG"</span><span class="p">,</span><span class="w"> </span><span class="s2">"CERN"</span><span class="p">,</span><span class="w"> </span><span class="s2">"CHKP"</span><span class="p">,</span><span class="w"> </span><span class="s2">"CHRW"</span><span class="p">,</span><span class="w"> </span><span class="s2">"CHTR"</span><span class="p">,</span><span class="w"> </span><span class="s2">"CMCSA"</span><span class="p">,</span><span class="w">
</span><span class="s2">"COST"</span><span class="p">,</span><span class="w"> </span><span class="s2">"CSCO"</span><span class="p">,</span><span class="w"> </span><span class="s2">"CTRX"</span><span class="p">,</span><span class="w"> </span><span class="s2">"CTSH"</span><span class="p">,</span><span class="w"> </span><span class="s2">"CTXS"</span><span class="p">,</span><span class="w"> </span><span class="s2">"DISCA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"DISCK"</span><span class="p">,</span><span class="w"> </span><span class="s2">"DISH"</span><span class="p">,</span><span class="w">
</span><span class="s2">"DLTR"</span><span class="p">,</span><span class="w"> </span><span class="s2">"DTV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"EBAY"</span><span class="p">,</span><span class="w"> </span><span class="s2">"EQIX"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ESRX"</span><span class="p">,</span><span class="w"> </span><span class="s2">"EXPD"</span><span class="p">,</span><span class="w"> </span><span class="s2">"EXPE"</span><span class="p">,</span><span class="w"> </span><span class="s2">"FAST"</span><span class="p">,</span><span class="w">
</span><span class="s2">"FB"</span><span class="p">,</span><span class="w"> </span><span class="s2">"FFIV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"FISV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"FOXA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"GILD"</span><span class="p">,</span><span class="w"> </span><span class="s2">"GMCR"</span><span class="p">,</span><span class="w"> </span><span class="s2">"GOOG"</span><span class="p">,</span><span class="w"> </span><span class="s2">"GOOGL"</span><span class="p">,</span><span class="w">
</span><span class="s2">"GRMN"</span><span class="p">,</span><span class="w"> </span><span class="s2">"HSIC"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ILMN"</span><span class="p">,</span><span class="w"> </span><span class="s2">"INTC"</span><span class="p">,</span><span class="w"> </span><span class="s2">"INTU"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ISRG"</span><span class="p">,</span><span class="w"> </span><span class="s2">"KLAC"</span><span class="p">,</span><span class="w"> </span><span class="s2">"KRFT"</span><span class="p">,</span><span class="w">
</span><span class="s2">"LBTYA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"LLTC"</span><span class="p">,</span><span class="w"> </span><span class="s2">"LMCA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"LMCK"</span><span class="p">,</span><span class="w"> </span><span class="s2">"LVNTA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"MAR"</span><span class="p">,</span><span class="w"> </span><span class="s2">"MAT"</span><span class="p">,</span><span class="w"> </span><span class="s2">"MDLZ"</span><span class="p">,</span><span class="w">
</span><span class="s2">"MNST"</span><span class="p">,</span><span class="w"> </span><span class="s2">"MSFT"</span><span class="p">,</span><span class="w"> </span><span class="s2">"MU"</span><span class="p">,</span><span class="w"> </span><span class="s2">"MXIM"</span><span class="p">,</span><span class="w"> </span><span class="s2">"MYL"</span><span class="p">,</span><span class="w"> </span><span class="s2">"NFLX"</span><span class="p">,</span><span class="w"> </span><span class="s2">"NTAP"</span><span class="p">,</span><span class="w"> </span><span class="s2">"NVDA"</span><span class="p">,</span><span class="w">
</span><span class="s2">"NXPI"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ORLY"</span><span class="p">,</span><span class="w"> </span><span class="s2">"PAYX"</span><span class="p">,</span><span class="w"> </span><span class="s2">"PCAR"</span><span class="p">,</span><span class="w"> </span><span class="s2">"PCLN"</span><span class="p">,</span><span class="w"> </span><span class="s2">"QCOM"</span><span class="p">,</span><span class="w"> </span><span class="s2">"QVCA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"REGN"</span><span class="p">,</span><span class="w">
</span><span class="s2">"ROST"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SBAC"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SBUX"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SIAL"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SIRI"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SNDK"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SPLS"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SRCL"</span><span class="p">,</span><span class="w">
</span><span class="s2">"STX"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SYMC"</span><span class="p">,</span><span class="w"> </span><span class="s2">"TRIP"</span><span class="p">,</span><span class="w"> </span><span class="s2">"TSCO"</span><span class="p">,</span><span class="w"> </span><span class="s2">"TSLA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"TXN"</span><span class="p">,</span><span class="w"> </span><span class="s2">"VIAB"</span><span class="p">,</span><span class="w"> </span><span class="s2">"VIP"</span><span class="p">,</span><span class="w">
</span><span class="s2">"VOD"</span><span class="p">,</span><span class="w"> </span><span class="s2">"VRSK"</span><span class="p">,</span><span class="w"> </span><span class="s2">"VRTX"</span><span class="p">,</span><span class="w"> </span><span class="s2">"WDC"</span><span class="p">,</span><span class="w"> </span><span class="s2">"WFM"</span><span class="p">,</span><span class="w"> </span><span class="s2">"WYNN"</span><span class="p">,</span><span class="w"> </span><span class="s2">"XLNX"</span><span class="p">,</span><span class="w"> </span><span class="s2">"YHOO"</span><span class="p">)</span><span class="w">
</span><span class="n">getSymbols</span><span class="p">(</span><span class="n">Nasdaq100_Symbols</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## pausing 1 second between requests for more than 5 symbols
...

</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>##   [1] "AAPL"  "ADBE"  "ADI"   "ADP"   "ADSK"  "AKAM"  "ALTR"  "ALXN"
##   [9] "AMAT"  "AMGN"  "AMZN"  "ATVI"  "AVGO"  "BBBY"  "BIDU"  "BIIB"
##  [17] "BRCM"  "CA"    "CELG"  "CERN"  "CHKP"  "CHRW"  "CHTR"  "CMCSA"
##  [25] "COST"  "CSCO"  "CTRX"  "CTSH"  "CTXS"  "DISCA" "DISCK" "DISH"
##  [33] "DLTR"  "DTV"   "EBAY"  "EQIX"  "ESRX"  "EXPD"  "EXPE"  "FAST"
##  [41] "FB"    "FFIV"  "FISV"  "FOXA"  "GILD"  "GMCR"  "GOOG"  "GOOGL"
##  [49] "GRMN"  "HSIC"  "ILMN"  "INTC"  "INTU"  "ISRG"  "KLAC"  "KRFT"
##  [57] "LBTYA" "LLTC"  "LMCA"  "LMCK"  "LVNTA" "MAR"   "MAT"   "MDLZ"
##  [65] "MNST"  "MSFT"  "MU"    "MXIM"  "MYL"   "NFLX"  "NTAP"  "NVDA"
##  [73] "NXPI"  "ORLY"  "PAYX"  "PCAR"  "PCLN"  "QCOM"  "QVCA"  "REGN"
##  [81] "ROST"  "SBAC"  "SBUX"  "SIAL"  "SIRI"  "SNDK"  "SPLS"  "SRCL"
##  [89] "STX"   "SYMC"  "TRIP"  "TSCO"  "TSLA"  "TXN"   "VIAB"  "VIP"  
##  [97] "VOD"   "VRSK"  "VRTX"  "WDC"   "WFM"   "WYNN"  "XLNX"  "YHOO"
</code></pre>
</div>
<p><br /><br />
Be warned, that this does take a little time as <b>quantmod</b> will throttle the download. Each symbol is loaded in memory under the symbol name, therefore we have over 100 new objects loaded in memory each with years of daily market data. As these are independent time series, we have to merge everything together and fill in missing data so everything fits nicely in a data frame. We’ll use the <code class="highlighter-rouge">merge.xts</code> function to merge by time all these objects into one data frame:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">nasdaq100</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">as.xts</span><span class="p">(</span><span class="n">merge</span><span class="p">(</span><span class="n">AAPL</span><span class="p">,</span><span class="w"> </span><span class="n">ADBE</span><span class="p">,</span><span class="w"> </span><span class="n">ADI</span><span class="p">,</span><span class="w"> </span><span class="n">ADP</span><span class="p">,</span><span class="w"> </span><span class="n">ADSK</span><span class="p">,</span><span class="w"> </span><span class="n">AKAM</span><span class="p">,</span><span class="w">
                </span><span class="n">ALTR</span><span class="p">,</span><span class="w"> </span><span class="n">ALXN</span><span class="p">,</span><span class="n">AMAT</span><span class="p">,</span><span class="w"> </span><span class="n">AMGN</span><span class="p">,</span><span class="w"> </span><span class="n">AMZN</span><span class="p">,</span><span class="w"> </span><span class="n">ATVI</span><span class="p">,</span><span class="w"> </span><span class="n">AVGO</span><span class="p">,</span><span class="w"> </span><span class="n">BBBY</span><span class="p">,</span><span class="w"> </span><span class="n">BIDU</span><span class="p">,</span><span class="w"> </span><span class="n">BIIB</span><span class="p">,</span><span class="w">
                 </span><span class="n">BRCM</span><span class="p">,</span><span class="w"> </span><span class="n">CA</span><span class="p">,</span><span class="w"> </span><span class="n">CELG</span><span class="p">,</span><span class="w"> </span><span class="n">CERN</span><span class="p">,</span><span class="w"> </span><span class="n">CHKP</span><span class="p">,</span><span class="w"> </span><span class="n">CHRW</span><span class="p">,</span><span class="w"> </span><span class="n">CHTR</span><span class="p">,</span><span class="w"> </span><span class="n">CMCSA</span><span class="p">,</span><span class="w">
                 </span><span class="n">COST</span><span class="p">,</span><span class="w"> </span><span class="n">CSCO</span><span class="p">,</span><span class="w"> </span><span class="n">CTRX</span><span class="p">,</span><span class="w"> </span><span class="n">CTSH</span><span class="p">,</span><span class="w"> </span><span class="n">CTXS</span><span class="p">,</span><span class="w"> </span><span class="n">DISCA</span><span class="p">,</span><span class="w"> </span><span class="n">DISCK</span><span class="p">,</span><span class="w"> </span><span class="n">DISH</span><span class="p">,</span><span class="w">
                 </span><span class="n">DLTR</span><span class="p">,</span><span class="w"> </span><span class="n">DTV</span><span class="p">,</span><span class="w"> </span><span class="n">EBAY</span><span class="p">,</span><span class="w"> </span><span class="n">EQIX</span><span class="p">,</span><span class="w"> </span><span class="n">ESRX</span><span class="p">,</span><span class="w"> </span><span class="n">EXPD</span><span class="p">,</span><span class="w"> </span><span class="n">EXPE</span><span class="p">,</span><span class="w"> </span><span class="n">FAST</span><span class="p">,</span><span class="w">
                 </span><span class="n">FB</span><span class="p">,</span><span class="w"> </span><span class="n">FFIV</span><span class="p">,</span><span class="w"> </span><span class="n">FISV</span><span class="p">,</span><span class="w"> </span><span class="n">FOXA</span><span class="p">,</span><span class="w"> </span><span class="n">GILD</span><span class="p">,</span><span class="w"> </span><span class="n">GMCR</span><span class="p">,</span><span class="w"> </span><span class="n">GOOG</span><span class="p">,</span><span class="w"> </span><span class="n">GOOGL</span><span class="p">,</span><span class="w">
                 </span><span class="n">GRMN</span><span class="p">,</span><span class="w"> </span><span class="n">HSIC</span><span class="p">,</span><span class="w"> </span><span class="n">ILMN</span><span class="p">,</span><span class="w"> </span><span class="n">INTC</span><span class="p">,</span><span class="w"> </span><span class="n">INTU</span><span class="p">,</span><span class="w"> </span><span class="n">ISRG</span><span class="p">,</span><span class="w"> </span><span class="n">KLAC</span><span class="p">,</span><span class="w"> </span><span class="n">KRFT</span><span class="p">,</span><span class="w">
                 </span><span class="n">LBTYA</span><span class="p">,</span><span class="w"> </span><span class="n">LLTC</span><span class="p">,</span><span class="w"> </span><span class="n">LMCA</span><span class="p">,</span><span class="w"> </span><span class="n">LMCK</span><span class="p">,</span><span class="w"> </span><span class="n">LVNTA</span><span class="p">,</span><span class="w"> </span><span class="n">MAR</span><span class="p">,</span><span class="w"> </span><span class="n">MAT</span><span class="p">,</span><span class="w"> </span><span class="n">MDLZ</span><span class="p">,</span><span class="w">
                 </span><span class="n">MNST</span><span class="p">,</span><span class="w"> </span><span class="n">MSFT</span><span class="p">,</span><span class="w"> </span><span class="n">MU</span><span class="p">,</span><span class="w"> </span><span class="n">MXIM</span><span class="p">,</span><span class="w"> </span><span class="n">MYL</span><span class="p">,</span><span class="w"> </span><span class="n">NFLX</span><span class="p">,</span><span class="w"> </span><span class="n">NTAP</span><span class="p">,</span><span class="w"> </span><span class="n">NVDA</span><span class="p">,</span><span class="w">
                 </span><span class="n">NXPI</span><span class="p">,</span><span class="w"> </span><span class="n">ORLY</span><span class="p">,</span><span class="w"> </span><span class="n">PAYX</span><span class="p">,</span><span class="w"> </span><span class="n">PCAR</span><span class="p">,</span><span class="w"> </span><span class="n">PCLN</span><span class="p">,</span><span class="w"> </span><span class="n">QCOM</span><span class="p">,</span><span class="w"> </span><span class="n">QVCA</span><span class="p">,</span><span class="w"> </span><span class="n">REGN</span><span class="p">,</span><span class="w">
                 </span><span class="n">ROST</span><span class="p">,</span><span class="w"> </span><span class="n">SBAC</span><span class="p">,</span><span class="w"> </span><span class="n">SBUX</span><span class="p">,</span><span class="w"> </span><span class="n">SIAL</span><span class="p">,</span><span class="w"> </span><span class="n">SIRI</span><span class="p">,</span><span class="w"> </span><span class="n">SNDK</span><span class="p">,</span><span class="w"> </span><span class="n">SPLS</span><span class="p">,</span><span class="w"> </span><span class="n">SRCL</span><span class="p">,</span><span class="w">
                 </span><span class="n">STX</span><span class="p">,</span><span class="w"> </span><span class="n">SYMC</span><span class="p">,</span><span class="w"> </span><span class="n">TRIP</span><span class="p">,</span><span class="w"> </span><span class="n">TSCO</span><span class="p">,</span><span class="w"> </span><span class="n">TSLA</span><span class="p">,</span><span class="w"> </span><span class="n">TXN</span><span class="p">,</span><span class="w"> </span><span class="n">VIAB</span><span class="p">,</span><span class="w"> </span><span class="n">VIP</span><span class="p">,</span><span class="w">
                 </span><span class="n">VOD</span><span class="p">,</span><span class="w"> </span><span class="n">VRSK</span><span class="p">,</span><span class="w"> </span><span class="n">VRTX</span><span class="p">,</span><span class="w"> </span><span class="n">WDC</span><span class="p">,</span><span class="w"> </span><span class="n">WFM</span><span class="p">,</span><span class="w"> </span><span class="n">WYNN</span><span class="p">,</span><span class="w"> </span><span class="n">XLNX</span><span class="p">,</span><span class="w"> </span><span class="n">YHOO</span><span class="p">)))</span><span class="w">
</span><span class="n">head</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">[,</span><span class="m">1</span><span class="o">:</span><span class="m">12</span><span class="p">],</span><span class="m">2</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>##            AAPL.Open AAPL.High AAPL.Low AAPL.Close AAPL.Volume
## 2007-01-03     86.29     86.58    81.90      83.80   309579900
## 2007-01-04     84.05     85.95    83.82      85.66   211815100
##            AAPL.Adjusted ADBE.Open ADBE.High ADBE.Low ADBE.Close
## 2007-01-03         11.34     40.72     41.32    38.89      39.92
## 2007-01-04         11.59     39.88     41.00    39.43      40.82
##            ADBE.Volume ADBE.Adjusted
## 2007-01-03     7126000         39.92
## 2007-01-04     4503700         40.82
</code></pre>
</div>
<p><br /><br />
Now that we have a handful of years of market data for every stock currently in the <b>NASDAQ 100 Index</b>, we need to do something with it. We’re going to create a variety of measures between price and volume points. The idea is to quantify stock moves as patterns by subtracting one day versus a previous one. We’ll create a series of differences:</p>
<ul>
<li type="square">1 day versus 2 days ago</li>
<li type="square">1 day versus 3 days ago</li>
<li type="square">1 day versus 5 days ago</li>
<li type="square">1 day versus 20 days ago (akin a 20 day moving average)</li>
</ul>
<p><br /><br />
<strong>Creating The Outcome Variable</strong>
<br /><br />
This is the heart of the system and it’s a bit tedious so hold on. What are we trying to predict?
Whether the next trading day’s volume for a chosen symbol will be higher or lower than the current trading day (this doesn’t have to be the <code class="highlighter-rouge">volume</code> field of <b>FISV</b>, it could be the <code class="highlighter-rouge">high</code> or <code class="highlighter-rouge">close</code> of any other symbol for which we have data):</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">outcomeSymbol</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s1">'FISV.Volume'</span><span class="w">
</span></code></pre>
</div>
<p><br /><br />
Shift the result we’re trying to predict down one trading day using the <code class="highlighter-rouge">lag</code> function. This will add the <code class="highlighter-rouge">volume</code> field of our outcome symbol with a lag of 1 trading day so it’s on the same line as the predictors. We will rely on this value for training and testing purposes. A value of <code class="highlighter-rouge">1</code> means the volume went up, and a <code class="highlighter-rouge">0</code>, that it went down:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">xts</span><span class="p">)</span><span class="w">
</span><span class="n">nasdaq100</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">xts</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">,</span><span class="n">order.by</span><span class="o">=</span><span class="n">as.Date</span><span class="p">(</span><span class="n">rownames</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">)))</span><span class="w">
</span><span class="n">nasdaq100</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.data.frame</span><span class="p">(</span><span class="n">merge</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">,</span><span class="w"> </span><span class="n">lm1</span><span class="o">=</span><span class="n">lag</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">[,</span><span class="n">outcomeSymbol</span><span class="p">],</span><span class="m">-1</span><span class="p">)))</span><span class="w">
</span><span class="n">nasdaq100</span><span class="o">$</span><span class="n">outcome</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">[,</span><span class="n">paste0</span><span class="p">(</span><span class="n">outcomeSymbol</span><span class="p">,</span><span class="s1">'.1'</span><span class="p">)]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">nasdaq100</span><span class="p">[,</span><span class="n">outcomeSymbol</span><span class="p">],</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w">
</span><span class="c1"># remove shifted down volume field as we don't care by the value
</span><span class="n">nasdaq100</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nasdaq100</span><span class="p">[,</span><span class="o">!</span><span class="nf">names</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">)</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">paste0</span><span class="p">(</span><span class="n">outcomeSymbol</span><span class="p">,</span><span class="s1">'.1'</span><span class="p">))]</span><span class="w">
</span></code></pre>
</div>
<p><br /><br />
Cast the date field to type <code class="highlighter-rouge">date</code> as it currently is of type <code class="highlighter-rouge">character</code> and sort by decreasing order:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">nasdaq100</span><span class="o">$</span><span class="n">date</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.Date</span><span class="p">(</span><span class="n">row.names</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">))</span><span class="w">
</span><span class="n">nasdaq100</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nasdaq100</span><span class="p">[</span><span class="n">order</span><span class="p">(</span><span class="n">as.Date</span><span class="p">(</span><span class="n">nasdaq100</span><span class="o">$</span><span class="n">date</span><span class="p">,</span><span class="w"> </span><span class="s2">"%m/%d/%Y"</span><span class="p">),</span><span class="w"> </span><span class="n">decreasing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),]</span><span class="w">
</span></code></pre>
</div>
<p><br /><br />
Here is the pattern maker function. This will take our raw market data and <code class="highlighter-rouge">scale</code> it so that we can compare any symbol with any other symbol. It then subtracts the different day ranges requested by the <code class="highlighter-rouge">days</code> parameter using the <code class="highlighter-rouge">diff</code> and <code class="highlighter-rouge">lag</code> calls and puts them all on the same row along with the outcome. To make things even more compatible, the <code class="highlighter-rouge">roundByScaler</code> parameter can round results.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">GetDiffDays</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">objDF</span><span class="p">,</span><span class="n">days</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">10</span><span class="p">),</span><span class="w"> </span><span class="n">offLimitsSymbols</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s1">'outcome'</span><span class="p">),</span><span class="w"> </span><span class="n">roundByScaler</span><span class="o">=</span><span class="m">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="c1"># needs to be sorted by date in decreasing order
</span><span class="w">        </span><span class="n">ind</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sapply</span><span class="p">(</span><span class="n">objDF</span><span class="p">,</span><span class="w"> </span><span class="n">is.numeric</span><span class="p">)</span><span class="w">
        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">sym</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">objDF</span><span class="p">)[</span><span class="n">ind</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">sym</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">offLimitsSymbols</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="n">print</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s1">'*********'</span><span class="p">,</span><span class="w"> </span><span class="n">sym</span><span class="p">))</span><span class="w">
                        </span><span class="n">objDF</span><span class="p">[,</span><span class="n">sym</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="n">scale</span><span class="p">(</span><span class="n">objDF</span><span class="p">[,</span><span class="n">sym</span><span class="p">]),</span><span class="n">roundByScaler</span><span class="p">)</span><span class="w">

                        </span><span class="n">print</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s1">'theColName'</span><span class="p">,</span><span class="w"> </span><span class="n">sym</span><span class="p">))</span><span class="w">
                        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">day</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">days</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
                                </span><span class="n">objDF</span><span class="p">[</span><span class="n">paste0</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span><span class="s1">'_'</span><span class="p">,</span><span class="n">day</span><span class="p">)]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">diff</span><span class="p">(</span><span class="n">objDF</span><span class="p">[,</span><span class="n">sym</span><span class="p">],</span><span class="n">lag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">day</span><span class="p">),</span><span class="nf">rep</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="n">day</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">-1</span><span class="w">
                        </span><span class="p">}</span><span class="w">
                </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
        </span><span class="n">return</span><span class="w"> </span><span class="p">(</span><span class="n">objDF</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>
<p><br /><br />
Call the function with the following differences and scale it down to 2 decimal points (this takes a little while to run):</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">nasdaq100</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">GetDiffDays</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">,</span><span class="w"> </span><span class="n">days</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">,</span><span class="m">4</span><span class="p">,</span><span class="m">5</span><span class="p">,</span><span class="m">10</span><span class="p">,</span><span class="m">20</span><span class="p">),</span><span class="w"> </span><span class="n">offLimitsSymbols</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s1">'outcome'</span><span class="p">),</span><span class="w"> </span><span class="n">roundByScaler</span><span class="o">=</span><span class="m">2</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## [1] "********* AAPL.Open"
## [1] "theColName AAPL.Open"
## [1] "********* AAPL.High"
## [1] "theColName AAPL.High"
## [1] "********* AAPL.Low"
## [1] "theColName AAPL.Low"
## [1] "********* AAPL.Close"
## [1] "theColName AAPL.Close"
## [1] "********* AAPL.Volume"
## [1] "theColName AAPL.Volume"
## [1] "********* AAPL.Adjusted"
## [1] "theColName AAPL.Adjusted"
...
## [1] "********* YHOO.Open"
## [1] "theColName YHOO.Open"
## [1] "********* YHOO.High"
## [1] "theColName YHOO.High"
## [1] "********* YHOO.Low"
## [1] "theColName YHOO.Low"
## [1] "********* YHOO.Close"
## [1] "theColName YHOO.Close"
## [1] "********* YHOO.Volume"
## [1] "theColName YHOO.Volume"
## [1] "********* YHOO.Adjusted"
## [1] "theColName YHOO.Adjusted"
</code></pre>
</div>
<p><br /><br />
We delete the last row from our data frame as it doesn’t have an <code class="highlighter-rouge">outcome</code> variable (that is in the <b>future</b>):</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">nasdaq100</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nasdaq100</span><span class="p">[</span><span class="m">2</span><span class="o">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">),]</span><span class="w">
</span></code></pre>
</div>
<p><br /><br />
Let’s take a peek at our resulting features for Yahoo:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">dput</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">)[</span><span class="n">grepl</span><span class="p">(</span><span class="s1">'YHOO.'</span><span class="p">,</span><span class="nf">names</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">))])</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## c("YHOO.Open", "YHOO.High", "YHOO.Low", "YHOO.Close", "YHOO.Volume",
## "YHOO.Adjusted", "YHOO.Open_1", "YHOO.Open_2", "YHOO.Open_3",
## "YHOO.Open_4", "YHOO.Open_5", "YHOO.Open_10", "YHOO.Open_20",
## "YHOO.High_1", "YHOO.High_2", "YHOO.High_3", "YHOO.High_4", "YHOO.High_5",
## "YHOO.High_10", "YHOO.High_20", "YHOO.Low_1", "YHOO.Low_2", "YHOO.Low_3",
## "YHOO.Low_4", "YHOO.Low_5", "YHOO.Low_10", "YHOO.Low_20", "YHOO.Close_1",
## "YHOO.Close_2", "YHOO.Close_3", "YHOO.Close_4", "YHOO.Close_5",
## "YHOO.Close_10", "YHOO.Close_20", "YHOO.Volume_1", "YHOO.Volume_2",
## "YHOO.Volume_3", "YHOO.Volume_4", "YHOO.Volume_5", "YHOO.Volume_10",
## "YHOO.Volume_20", "YHOO.Adjusted_1", "YHOO.Adjusted_2", "YHOO.Adjusted_3",
## "YHOO.Adjusted_4", "YHOO.Adjusted_5", "YHOO.Adjusted_10", "YHOO.Adjusted_20"
## )
</code></pre>
</div>
<p><br /><br />
We extract the day of the week, day of the month, day of the year as predictors using <code class="highlighter-rouge">POSIXlt</code>:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">nasdaq100</span><span class="o">$</span><span class="n">wday</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.POSIXlt</span><span class="p">(</span><span class="n">nasdaq100</span><span class="o">$</span><span class="n">date</span><span class="p">)</span><span class="o">$</span><span class="n">wday</span><span class="w">
</span><span class="n">nasdaq100</span><span class="o">$</span><span class="n">yday</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.POSIXlt</span><span class="p">(</span><span class="n">nasdaq100</span><span class="o">$</span><span class="n">date</span><span class="p">)</span><span class="o">$</span><span class="n">mday</span><span class="w">
</span><span class="n">nasdaq100</span><span class="o">$</span><span class="n">mon</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.POSIXlt</span><span class="p">(</span><span class="n">nasdaq100</span><span class="o">$</span><span class="n">date</span><span class="p">)</span><span class="o">$</span><span class="n">mon</span><span class="w">
</span></code></pre>
</div>
<p><br /><br />
Next we remove the date field as it won’t help us as a predictor as they are all unique and we shuffle the data set using the <code class="highlighter-rouge">sample</code> function:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">nasdaq100</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">subset</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">,</span><span class="w"> </span><span class="n">select</span><span class="o">=-</span><span class="nf">c</span><span class="p">(</span><span class="n">date</span><span class="p">))</span><span class="w">
</span><span class="n">nasdaq100</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nasdaq100</span><span class="p">[</span><span class="n">sample</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">)),]</span><span class="w">
</span></code></pre>
</div>
<p><br /><br />
<strong>Let’s Model It!</strong>
<br /><br />
We’ll use a simple <b>xgboost</b> model to get an <code class="highlighter-rouge">AUC</code> score. You can get more details regarding parameter settings for this model at the <a href="https://github.com/tqchen/xgboost/wiki/Parameters" target="_blank">xgboost wiki</a>:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">xgboost</span><span class="p">)</span><span class="w">
</span><span class="n">predictorNames</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">)[</span><span class="nf">names</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">'outcome'</span><span class="p">]</span><span class="w">

</span><span class="n">set.seed</span><span class="p">(</span><span class="m">1234</span><span class="p">)</span><span class="w">
</span><span class="n">split</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sample</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">),</span><span class="w"> </span><span class="nf">floor</span><span class="p">(</span><span class="m">0.7</span><span class="o">*</span><span class="n">nrow</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">)))</span><span class="w">
</span><span class="n">train</span><span class="w"> </span><span class="o">&lt;-</span><span class="n">nasdaq100</span><span class="p">[</span><span class="n">split</span><span class="p">,]</span><span class="w">
</span><span class="n">test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nasdaq100</span><span class="p">[</span><span class="o">-</span><span class="n">split</span><span class="p">,]</span><span class="w">

</span><span class="n">bst</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">xgboost</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.matrix</span><span class="p">(</span><span class="n">train</span><span class="p">[,</span><span class="n">predictorNames</span><span class="p">]),</span><span class="w">
               </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">train</span><span class="o">$</span><span class="n">outcome</span><span class="p">,</span><span class="w">
               </span><span class="n">verbose</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="w">
               </span><span class="n">eta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">,</span><span class="w">
               </span><span class="n">gamma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">50</span><span class="p">,</span><span class="w">
               </span><span class="n">nround</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">50</span><span class="p">,</span><span class="w">
               </span><span class="n">missing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NaN</span><span class="p">,</span><span class="w">
               </span><span class="n">colsample_bytree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">,</span><span class="w">
               </span><span class="n">subsample</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">8.6</span><span class="p">,</span><span class="w">
               </span><span class="n">objective</span><span class="o">=</span><span class="s2">"binary:logistic"</span><span class="p">)</span><span class="w">

</span><span class="n">predictions</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">bst</span><span class="p">,</span><span class="w"> </span><span class="n">as.matrix</span><span class="p">(</span><span class="n">test</span><span class="p">[,</span><span class="n">predictorNames</span><span class="p">]),</span><span class="w"> </span><span class="n">missing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NaN</span><span class="p">,</span><span class="w"> </span><span class="n">outputmargin</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span><span class="w">

</span><span class="n">library</span><span class="p">(</span><span class="n">pROC</span><span class="p">)</span><span class="w">
</span><span class="n">auc</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">roc</span><span class="p">(</span><span class="n">test</span><span class="o">$</span><span class="n">outcome</span><span class="p">,</span><span class="w"> </span><span class="n">predictions</span><span class="p">)</span><span class="w">
</span><span class="n">print</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s1">'AUC score:'</span><span class="p">,</span><span class="w"> </span><span class="n">auc</span><span class="o">$</span><span class="n">auc</span><span class="p">))</span><span class="w">
</span></code></pre>
</div>
<div class="highlighter-rouge"><pre class="highlight"><code>## [1] "AUC score: 0.719931972789116"
</code></pre>
</div>
<p><br /><br />
<strong>Conclusion</strong>
<br /><br /><br />
Not bad, right? An <b>AUC</b> of <b>0.719</b> for very little work (remember that an <b>AUC</b> ranges between <b>0.5</b> and <b>1</b>, where <b>0.5</b> is random and <b>1</b> is perfect). Hopefully this will pique your imagination with the many possibilities of <b>quantmod</b> and <b>R</b>.
<br /><br />      <br />
<a id="sourcecode">Full source code (<a href="https://github.com/amunategui/quantmod-wallstreet" target="_blank">also on GitHub</a>)</a>:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">quantmod</span><span class="p">)</span><span class="w">

</span><span class="c1"># display a simple bar chart
</span><span class="n">getSymbols</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"AMZN"</span><span class="p">))</span><span class="w">
</span><span class="n">barChart</span><span class="p">(</span><span class="n">AMZN</span><span class="p">,</span><span class="n">theme</span><span class="o">=</span><span class="s1">'white.mono'</span><span class="p">,</span><span class="n">bar.type</span><span class="o">=</span><span class="s1">'hlc'</span><span class="p">)</span><span class="w">

</span><span class="c1"># display a complex chart
</span><span class="n">getSymbols</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"^GSPC"</span><span class="p">))</span><span class="w">
</span><span class="n">chartSeries</span><span class="p">(</span><span class="n">GSPC</span><span class="p">,</span><span class="w"> </span><span class="n">subset</span><span class="o">=</span><span class="s1">'last 3 months'</span><span class="p">)</span><span class="w">
</span><span class="n">addBBands</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="n">sd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">ma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"SMA"</span><span class="p">,</span><span class="w"> </span><span class="n">draw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'bands'</span><span class="p">,</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-1</span><span class="p">)</span><span class="w">

</span><span class="c1"># get market data for all symbols making up the NASDAQ 100 Index
</span><span class="n">Nasdaq100_Symbols</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"AAPL"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ADBE"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ADI"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ADP"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ADSK"</span><span class="p">,</span><span class="w"> </span><span class="s2">"AKAM"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ALTR"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ALXN"</span><span class="p">,</span><span class="w">
</span><span class="s2">"AMAT"</span><span class="p">,</span><span class="w"> </span><span class="s2">"AMGN"</span><span class="p">,</span><span class="w"> </span><span class="s2">"AMZN"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ATVI"</span><span class="p">,</span><span class="w"> </span><span class="s2">"AVGO"</span><span class="p">,</span><span class="w"> </span><span class="s2">"BBBY"</span><span class="p">,</span><span class="w"> </span><span class="s2">"BIDU"</span><span class="p">,</span><span class="w"> </span><span class="s2">"BIIB"</span><span class="p">,</span><span class="w">
</span><span class="s2">"BRCM"</span><span class="p">,</span><span class="w"> </span><span class="s2">"CA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"CELG"</span><span class="p">,</span><span class="w"> </span><span class="s2">"CERN"</span><span class="p">,</span><span class="w"> </span><span class="s2">"CHKP"</span><span class="p">,</span><span class="w"> </span><span class="s2">"CHRW"</span><span class="p">,</span><span class="w"> </span><span class="s2">"CHTR"</span><span class="p">,</span><span class="w"> </span><span class="s2">"CMCSA"</span><span class="p">,</span><span class="w">
</span><span class="s2">"COST"</span><span class="p">,</span><span class="w"> </span><span class="s2">"CSCO"</span><span class="p">,</span><span class="w"> </span><span class="s2">"CTRX"</span><span class="p">,</span><span class="w"> </span><span class="s2">"CTSH"</span><span class="p">,</span><span class="w"> </span><span class="s2">"CTXS"</span><span class="p">,</span><span class="w"> </span><span class="s2">"DISCA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"DISCK"</span><span class="p">,</span><span class="w"> </span><span class="s2">"DISH"</span><span class="p">,</span><span class="w">
</span><span class="s2">"DLTR"</span><span class="p">,</span><span class="w"> </span><span class="s2">"DTV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"EBAY"</span><span class="p">,</span><span class="w"> </span><span class="s2">"EQIX"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ESRX"</span><span class="p">,</span><span class="w"> </span><span class="s2">"EXPD"</span><span class="p">,</span><span class="w"> </span><span class="s2">"EXPE"</span><span class="p">,</span><span class="w"> </span><span class="s2">"FAST"</span><span class="p">,</span><span class="w">
</span><span class="s2">"FB"</span><span class="p">,</span><span class="w"> </span><span class="s2">"FFIV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"FISV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"FOXA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"GILD"</span><span class="p">,</span><span class="w"> </span><span class="s2">"GMCR"</span><span class="p">,</span><span class="w"> </span><span class="s2">"GOOG"</span><span class="p">,</span><span class="w"> </span><span class="s2">"GOOGL"</span><span class="p">,</span><span class="w">
</span><span class="s2">"GRMN"</span><span class="p">,</span><span class="w"> </span><span class="s2">"HSIC"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ILMN"</span><span class="p">,</span><span class="w"> </span><span class="s2">"INTC"</span><span class="p">,</span><span class="w"> </span><span class="s2">"INTU"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ISRG"</span><span class="p">,</span><span class="w"> </span><span class="s2">"KLAC"</span><span class="p">,</span><span class="w"> </span><span class="s2">"KRFT"</span><span class="p">,</span><span class="w">
</span><span class="s2">"LBTYA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"LLTC"</span><span class="p">,</span><span class="w"> </span><span class="s2">"LMCA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"LMCK"</span><span class="p">,</span><span class="w"> </span><span class="s2">"LVNTA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"MAR"</span><span class="p">,</span><span class="w"> </span><span class="s2">"MAT"</span><span class="p">,</span><span class="w"> </span><span class="s2">"MDLZ"</span><span class="p">,</span><span class="w">
</span><span class="s2">"MNST"</span><span class="p">,</span><span class="w"> </span><span class="s2">"MSFT"</span><span class="p">,</span><span class="w"> </span><span class="s2">"MU"</span><span class="p">,</span><span class="w"> </span><span class="s2">"MXIM"</span><span class="p">,</span><span class="w"> </span><span class="s2">"MYL"</span><span class="p">,</span><span class="w"> </span><span class="s2">"NFLX"</span><span class="p">,</span><span class="w"> </span><span class="s2">"NTAP"</span><span class="p">,</span><span class="w"> </span><span class="s2">"NVDA"</span><span class="p">,</span><span class="w">
</span><span class="s2">"NXPI"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ORLY"</span><span class="p">,</span><span class="w"> </span><span class="s2">"PAYX"</span><span class="p">,</span><span class="w"> </span><span class="s2">"PCAR"</span><span class="p">,</span><span class="w"> </span><span class="s2">"PCLN"</span><span class="p">,</span><span class="w"> </span><span class="s2">"QCOM"</span><span class="p">,</span><span class="w"> </span><span class="s2">"QVCA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"REGN"</span><span class="p">,</span><span class="w">
</span><span class="s2">"ROST"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SBAC"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SBUX"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SIAL"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SIRI"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SNDK"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SPLS"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SRCL"</span><span class="p">,</span><span class="w">
</span><span class="s2">"STX"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SYMC"</span><span class="p">,</span><span class="w"> </span><span class="s2">"TRIP"</span><span class="p">,</span><span class="w"> </span><span class="s2">"TSCO"</span><span class="p">,</span><span class="w"> </span><span class="s2">"TSLA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"TXN"</span><span class="p">,</span><span class="w"> </span><span class="s2">"VIAB"</span><span class="p">,</span><span class="w"> </span><span class="s2">"VIP"</span><span class="p">,</span><span class="w">
</span><span class="s2">"VOD"</span><span class="p">,</span><span class="w"> </span><span class="s2">"VRSK"</span><span class="p">,</span><span class="w"> </span><span class="s2">"VRTX"</span><span class="p">,</span><span class="w"> </span><span class="s2">"WDC"</span><span class="p">,</span><span class="w"> </span><span class="s2">"WFM"</span><span class="p">,</span><span class="w"> </span><span class="s2">"WYNN"</span><span class="p">,</span><span class="w"> </span><span class="s2">"XLNX"</span><span class="p">,</span><span class="w"> </span><span class="s2">"YHOO"</span><span class="p">)</span><span class="w">
</span><span class="n">getSymbols</span><span class="p">(</span><span class="n">Nasdaq100_Symbols</span><span class="p">)</span><span class="w">

</span><span class="c1"># merge them all together
</span><span class="n">nasdaq100</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">as.xts</span><span class="p">(</span><span class="n">merge</span><span class="p">(</span><span class="n">AAPL</span><span class="p">,</span><span class="w"> </span><span class="n">ADBE</span><span class="p">,</span><span class="w"> </span><span class="n">ADI</span><span class="p">,</span><span class="w"> </span><span class="n">ADP</span><span class="p">,</span><span class="w"> </span><span class="n">ADSK</span><span class="p">,</span><span class="w"> </span><span class="n">AKAM</span><span class="p">,</span><span class="w">
                </span><span class="n">ALTR</span><span class="p">,</span><span class="w"> </span><span class="n">ALXN</span><span class="p">,</span><span class="n">AMAT</span><span class="p">,</span><span class="w"> </span><span class="n">AMGN</span><span class="p">,</span><span class="w"> </span><span class="n">AMZN</span><span class="p">,</span><span class="w"> </span><span class="n">ATVI</span><span class="p">,</span><span class="w"> </span><span class="n">AVGO</span><span class="p">,</span><span class="w"> </span><span class="n">BBBY</span><span class="p">,</span><span class="w"> </span><span class="n">BIDU</span><span class="p">,</span><span class="w"> </span><span class="n">BIIB</span><span class="p">,</span><span class="w">
                 </span><span class="n">BRCM</span><span class="p">,</span><span class="w"> </span><span class="n">CA</span><span class="p">,</span><span class="w"> </span><span class="n">CELG</span><span class="p">,</span><span class="w"> </span><span class="n">CERN</span><span class="p">,</span><span class="w"> </span><span class="n">CHKP</span><span class="p">,</span><span class="w"> </span><span class="n">CHRW</span><span class="p">,</span><span class="w"> </span><span class="n">CHTR</span><span class="p">,</span><span class="w"> </span><span class="n">CMCSA</span><span class="p">,</span><span class="w">
                 </span><span class="n">COST</span><span class="p">,</span><span class="w"> </span><span class="n">CSCO</span><span class="p">,</span><span class="w"> </span><span class="n">CTRX</span><span class="p">,</span><span class="w"> </span><span class="n">CTSH</span><span class="p">,</span><span class="w"> </span><span class="n">CTXS</span><span class="p">,</span><span class="w"> </span><span class="n">DISCA</span><span class="p">,</span><span class="w"> </span><span class="n">DISCK</span><span class="p">,</span><span class="w"> </span><span class="n">DISH</span><span class="p">,</span><span class="w">
                 </span><span class="n">DLTR</span><span class="p">,</span><span class="w"> </span><span class="n">DTV</span><span class="p">,</span><span class="w"> </span><span class="n">EBAY</span><span class="p">,</span><span class="w"> </span><span class="n">EQIX</span><span class="p">,</span><span class="w"> </span><span class="n">ESRX</span><span class="p">,</span><span class="w"> </span><span class="n">EXPD</span><span class="p">,</span><span class="w"> </span><span class="n">EXPE</span><span class="p">,</span><span class="w"> </span><span class="n">FAST</span><span class="p">,</span><span class="w">
                 </span><span class="n">FB</span><span class="p">,</span><span class="w"> </span><span class="n">FFIV</span><span class="p">,</span><span class="w"> </span><span class="n">FISV</span><span class="p">,</span><span class="w"> </span><span class="n">FOXA</span><span class="p">,</span><span class="w"> </span><span class="n">GILD</span><span class="p">,</span><span class="w"> </span><span class="n">GMCR</span><span class="p">,</span><span class="w"> </span><span class="n">GOOG</span><span class="p">,</span><span class="w"> </span><span class="n">GOOGL</span><span class="p">,</span><span class="w">
                 </span><span class="n">GRMN</span><span class="p">,</span><span class="w"> </span><span class="n">HSIC</span><span class="p">,</span><span class="w"> </span><span class="n">ILMN</span><span class="p">,</span><span class="w"> </span><span class="n">INTC</span><span class="p">,</span><span class="w"> </span><span class="n">INTU</span><span class="p">,</span><span class="w"> </span><span class="n">ISRG</span><span class="p">,</span><span class="w"> </span><span class="n">KLAC</span><span class="p">,</span><span class="w"> </span><span class="n">KRFT</span><span class="p">,</span><span class="w">
                 </span><span class="n">LBTYA</span><span class="p">,</span><span class="w"> </span><span class="n">LLTC</span><span class="p">,</span><span class="w"> </span><span class="n">LMCA</span><span class="p">,</span><span class="w"> </span><span class="n">LMCK</span><span class="p">,</span><span class="w"> </span><span class="n">LVNTA</span><span class="p">,</span><span class="w"> </span><span class="n">MAR</span><span class="p">,</span><span class="w"> </span><span class="n">MAT</span><span class="p">,</span><span class="w"> </span><span class="n">MDLZ</span><span class="p">,</span><span class="w">
                 </span><span class="n">MNST</span><span class="p">,</span><span class="w"> </span><span class="n">MSFT</span><span class="p">,</span><span class="w"> </span><span class="n">MU</span><span class="p">,</span><span class="w"> </span><span class="n">MXIM</span><span class="p">,</span><span class="w"> </span><span class="n">MYL</span><span class="p">,</span><span class="w"> </span><span class="n">NFLX</span><span class="p">,</span><span class="w"> </span><span class="n">NTAP</span><span class="p">,</span><span class="w"> </span><span class="n">NVDA</span><span class="p">,</span><span class="w">
                 </span><span class="n">NXPI</span><span class="p">,</span><span class="w"> </span><span class="n">ORLY</span><span class="p">,</span><span class="w"> </span><span class="n">PAYX</span><span class="p">,</span><span class="w"> </span><span class="n">PCAR</span><span class="p">,</span><span class="w"> </span><span class="n">PCLN</span><span class="p">,</span><span class="w"> </span><span class="n">QCOM</span><span class="p">,</span><span class="w"> </span><span class="n">QVCA</span><span class="p">,</span><span class="w"> </span><span class="n">REGN</span><span class="p">,</span><span class="w">
                 </span><span class="n">ROST</span><span class="p">,</span><span class="w"> </span><span class="n">SBAC</span><span class="p">,</span><span class="w"> </span><span class="n">SBUX</span><span class="p">,</span><span class="w"> </span><span class="n">SIAL</span><span class="p">,</span><span class="w"> </span><span class="n">SIRI</span><span class="p">,</span><span class="w"> </span><span class="n">SNDK</span><span class="p">,</span><span class="w"> </span><span class="n">SPLS</span><span class="p">,</span><span class="w"> </span><span class="n">SRCL</span><span class="p">,</span><span class="w">
                 </span><span class="n">STX</span><span class="p">,</span><span class="w"> </span><span class="n">SYMC</span><span class="p">,</span><span class="w"> </span><span class="n">TRIP</span><span class="p">,</span><span class="w"> </span><span class="n">TSCO</span><span class="p">,</span><span class="w"> </span><span class="n">TSLA</span><span class="p">,</span><span class="w"> </span><span class="n">TXN</span><span class="p">,</span><span class="w"> </span><span class="n">VIAB</span><span class="p">,</span><span class="w"> </span><span class="n">VIP</span><span class="p">,</span><span class="w">
                 </span><span class="n">VOD</span><span class="p">,</span><span class="w"> </span><span class="n">VRSK</span><span class="p">,</span><span class="w"> </span><span class="n">VRTX</span><span class="p">,</span><span class="w"> </span><span class="n">WDC</span><span class="p">,</span><span class="w"> </span><span class="n">WFM</span><span class="p">,</span><span class="w"> </span><span class="n">WYNN</span><span class="p">,</span><span class="w"> </span><span class="n">XLNX</span><span class="p">,</span><span class="w"> </span><span class="n">YHOO</span><span class="p">)))</span><span class="w">
</span><span class="n">head</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">[,</span><span class="m">1</span><span class="o">:</span><span class="m">12</span><span class="p">],</span><span class="m">2</span><span class="p">)</span><span class="w">

</span><span class="c1"># set outcome variable
</span><span class="n">outcomeSymbol</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s1">'FISV.Volume'</span><span class="w">

</span><span class="c1"># shift outcome value to be on same line as predictors
</span><span class="n">library</span><span class="p">(</span><span class="n">xts</span><span class="p">)</span><span class="w">
</span><span class="n">nasdaq100</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">xts</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">,</span><span class="n">order.by</span><span class="o">=</span><span class="n">as.Date</span><span class="p">(</span><span class="n">rownames</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">)))</span><span class="w">
</span><span class="n">nasdaq100</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.data.frame</span><span class="p">(</span><span class="n">merge</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">,</span><span class="w"> </span><span class="n">lm1</span><span class="o">=</span><span class="n">lag</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">[,</span><span class="n">outcomeSymbol</span><span class="p">],</span><span class="m">-1</span><span class="p">)))</span><span class="w">
</span><span class="n">nasdaq100</span><span class="o">$</span><span class="n">outcome</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">[,</span><span class="n">paste0</span><span class="p">(</span><span class="n">outcomeSymbol</span><span class="p">,</span><span class="s1">'.1'</span><span class="p">)]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">nasdaq100</span><span class="p">[,</span><span class="n">outcomeSymbol</span><span class="p">],</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w">

</span><span class="c1"># remove shifted down volume field as we don't care by the value
</span><span class="n">nasdaq100</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nasdaq100</span><span class="p">[,</span><span class="o">!</span><span class="nf">names</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">)</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">paste0</span><span class="p">(</span><span class="n">outcomeSymbol</span><span class="p">,</span><span class="s1">'.1'</span><span class="p">))]</span><span class="w">

</span><span class="c1"># cast date to true date and order in decreasing order
</span><span class="n">nasdaq100</span><span class="o">$</span><span class="n">date</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.Date</span><span class="p">(</span><span class="n">row.names</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">))</span><span class="w">
</span><span class="n">nasdaq100</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nasdaq100</span><span class="p">[</span><span class="n">order</span><span class="p">(</span><span class="n">as.Date</span><span class="p">(</span><span class="n">nasdaq100</span><span class="o">$</span><span class="n">date</span><span class="p">,</span><span class="w"> </span><span class="s2">"%m/%d/%Y"</span><span class="p">),</span><span class="w"> </span><span class="n">decreasing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),]</span><span class="w">

</span><span class="c1"># calculate all day differences and populate them on same row
</span><span class="n">GetDiffDays</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">objDF</span><span class="p">,</span><span class="n">days</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">10</span><span class="p">),</span><span class="w"> </span><span class="n">offLimitsSymbols</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s1">'outcome'</span><span class="p">),</span><span class="w"> </span><span class="n">roundByScaler</span><span class="o">=</span><span class="m">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="c1"># needs to be sorted by date in decreasing order
</span><span class="w">        </span><span class="n">ind</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sapply</span><span class="p">(</span><span class="n">objDF</span><span class="p">,</span><span class="w"> </span><span class="n">is.numeric</span><span class="p">)</span><span class="w">
        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">sym</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">objDF</span><span class="p">)[</span><span class="n">ind</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">sym</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">offLimitsSymbols</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="n">print</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s1">'*********'</span><span class="p">,</span><span class="w"> </span><span class="n">sym</span><span class="p">))</span><span class="w">
                        </span><span class="n">objDF</span><span class="p">[,</span><span class="n">sym</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="n">scale</span><span class="p">(</span><span class="n">objDF</span><span class="p">[,</span><span class="n">sym</span><span class="p">]),</span><span class="n">roundByScaler</span><span class="p">)</span><span class="w">

                        </span><span class="n">print</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s1">'theColName'</span><span class="p">,</span><span class="w"> </span><span class="n">sym</span><span class="p">))</span><span class="w">
                        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">day</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">days</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
                                </span><span class="n">objDF</span><span class="p">[</span><span class="n">paste0</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span><span class="s1">'_'</span><span class="p">,</span><span class="n">day</span><span class="p">)]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">diff</span><span class="p">(</span><span class="n">objDF</span><span class="p">[,</span><span class="n">sym</span><span class="p">],</span><span class="n">lag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">day</span><span class="p">),</span><span class="nf">rep</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="n">day</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">-1</span><span class="w">
                        </span><span class="p">}</span><span class="w">
                </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
        </span><span class="n">return</span><span class="w"> </span><span class="p">(</span><span class="n">objDF</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c1"># call the function with the following differences
</span><span class="n">nasdaq100</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">GetDiffDays</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">,</span><span class="w"> </span><span class="n">days</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">,</span><span class="m">4</span><span class="p">,</span><span class="m">5</span><span class="p">,</span><span class="m">10</span><span class="p">,</span><span class="m">20</span><span class="p">),</span><span class="w"> </span><span class="n">offLimitsSymbols</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s1">'outcome'</span><span class="p">),</span><span class="w"> </span><span class="n">roundByScaler</span><span class="o">=</span><span class="m">2</span><span class="p">)</span><span class="w">

</span><span class="c1"># drop most recent entry as we don't have an outcome
</span><span class="n">nasdaq100</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nasdaq100</span><span class="p">[</span><span class="m">2</span><span class="o">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">),]</span><span class="w">

</span><span class="c1"># take a peek at YHOO features:
</span><span class="n">dput</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">)[</span><span class="n">grepl</span><span class="p">(</span><span class="s1">'YHOO.'</span><span class="p">,</span><span class="nf">names</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">))])</span><span class="w">

</span><span class="c1"># well use POSIXlt to add day of the week, day of the month, day of the year
</span><span class="n">nasdaq100</span><span class="o">$</span><span class="n">wday</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.POSIXlt</span><span class="p">(</span><span class="n">nasdaq100</span><span class="o">$</span><span class="n">date</span><span class="p">)</span><span class="o">$</span><span class="n">wday</span><span class="w">
</span><span class="n">nasdaq100</span><span class="o">$</span><span class="n">yday</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.POSIXlt</span><span class="p">(</span><span class="n">nasdaq100</span><span class="o">$</span><span class="n">date</span><span class="p">)</span><span class="o">$</span><span class="n">mday</span><span class="w">
</span><span class="n">nasdaq100</span><span class="o">$</span><span class="n">mon</span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.POSIXlt</span><span class="p">(</span><span class="n">nasdaq100</span><span class="o">$</span><span class="n">date</span><span class="p">)</span><span class="o">$</span><span class="n">mon</span><span class="w">

</span><span class="c1"># remove date field and shuffle data frame
</span><span class="n">nasdaq100</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">subset</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">,</span><span class="w"> </span><span class="n">select</span><span class="o">=-</span><span class="nf">c</span><span class="p">(</span><span class="n">date</span><span class="p">))</span><span class="w">
</span><span class="n">nasdaq100</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nasdaq100</span><span class="p">[</span><span class="n">sample</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">)),]</span><span class="w">

</span><span class="c1"># let's model
</span><span class="n">library</span><span class="p">(</span><span class="n">xgboost</span><span class="p">)</span><span class="w">
</span><span class="n">predictorNames</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">)[</span><span class="nf">names</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">'outcome'</span><span class="p">]</span><span class="w">

</span><span class="n">set.seed</span><span class="p">(</span><span class="m">1234</span><span class="p">)</span><span class="w">
</span><span class="n">split</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sample</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">),</span><span class="w"> </span><span class="nf">floor</span><span class="p">(</span><span class="m">0.7</span><span class="o">*</span><span class="n">nrow</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">)))</span><span class="w">
</span><span class="n">train</span><span class="w"> </span><span class="o">&lt;-</span><span class="n">nasdaq100</span><span class="p">[</span><span class="n">split</span><span class="p">,]</span><span class="w">
</span><span class="n">test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nasdaq100</span><span class="p">[</span><span class="o">-</span><span class="n">split</span><span class="p">,]</span><span class="w">

</span><span class="n">bst</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">xgboost</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">as.matrix</span><span class="p">(</span><span class="n">train</span><span class="p">[,</span><span class="n">predictorNames</span><span class="p">]),</span><span class="w">
               </span><span class="n">label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">train</span><span class="o">$</span><span class="n">outcome</span><span class="p">,</span><span class="w">
               </span><span class="n">verbose</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="w">
               </span><span class="n">eta</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">,</span><span class="w">
               </span><span class="n">gamma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">50</span><span class="p">,</span><span class="w">
               </span><span class="n">missing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NaN</span><span class="p">,</span><span class="w">
               </span><span class="n">nround</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">50</span><span class="p">,</span><span class="w">
               </span><span class="n">colsample_bytree</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">,</span><span class="w">
               </span><span class="n">subsample</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">8.6</span><span class="p">,</span><span class="w">
               </span><span class="n">objective</span><span class="o">=</span><span class="s2">"binary:logistic"</span><span class="p">)</span><span class="w">

</span><span class="n">predictions</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">bst</span><span class="p">,</span><span class="w"> </span><span class="n">as.matrix</span><span class="p">(</span><span class="n">test</span><span class="p">[,</span><span class="n">predictorNames</span><span class="p">]),</span><span class="w"> </span><span class="n">missing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NaN</span><span class="p">,</span><span class="w"> </span><span class="n">outputmargin</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">)</span><span class="w">

</span><span class="n">library</span><span class="p">(</span><span class="n">pROC</span><span class="p">)</span><span class="w">
</span><span class="n">auc</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">roc</span><span class="p">(</span><span class="n">test</span><span class="o">$</span><span class="n">outcome</span><span class="p">,</span><span class="w"> </span><span class="n">predictions</span><span class="p">)</span><span class="w">
</span><span class="n">print</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s1">'AUC score:'</span><span class="p">,</span><span class="w"> </span><span class="n">auc</span><span class="o">$</span><span class="n">auc</span><span class="p">))</span><span class="w">
</span></code></pre>
</div>

<p><br /><br />      <br />
<a id="sourcecode_gbm">GBM source code</a>:
<br /><br /></p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">quantmod</span><span class="p">)</span><span class="w">

</span><span class="c1"># display a simple bar chart
</span><span class="n">getSymbols</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"AMZN"</span><span class="p">))</span><span class="w">
</span><span class="n">barChart</span><span class="p">(</span><span class="n">AMZN</span><span class="p">,</span><span class="n">theme</span><span class="o">=</span><span class="s1">'white.mono'</span><span class="p">,</span><span class="n">bar.type</span><span class="o">=</span><span class="s1">'hlc'</span><span class="p">)</span><span class="w">

</span><span class="c1"># display a complex chart
</span><span class="n">getSymbols</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"^GSPC"</span><span class="p">))</span><span class="w">
</span><span class="n">chartSeries</span><span class="p">(</span><span class="n">GSPC</span><span class="p">,</span><span class="w"> </span><span class="n">subset</span><span class="o">=</span><span class="s1">'last 3 months'</span><span class="p">)</span><span class="w">
</span><span class="n">addBBands</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span><span class="p">,</span><span class="w"> </span><span class="n">sd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">ma</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"SMA"</span><span class="p">,</span><span class="w"> </span><span class="n">draw</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'bands'</span><span class="p">,</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">-1</span><span class="p">)</span><span class="w">

</span><span class="c1"># get market data for all symbols making up the NASDAQ 100 Index
</span><span class="n">Nasdaq100_Symbols</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"AAPL"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ADBE"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ADI"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ADP"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ADSK"</span><span class="p">,</span><span class="w"> </span><span class="s2">"AKAM"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ALTR"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ALXN"</span><span class="p">,</span><span class="w">
</span><span class="s2">"AMAT"</span><span class="p">,</span><span class="w"> </span><span class="s2">"AMGN"</span><span class="p">,</span><span class="w"> </span><span class="s2">"AMZN"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ATVI"</span><span class="p">,</span><span class="w"> </span><span class="s2">"AVGO"</span><span class="p">,</span><span class="w"> </span><span class="s2">"BBBY"</span><span class="p">,</span><span class="w"> </span><span class="s2">"BIDU"</span><span class="p">,</span><span class="w"> </span><span class="s2">"BIIB"</span><span class="p">,</span><span class="w">
</span><span class="s2">"BRCM"</span><span class="p">,</span><span class="w"> </span><span class="s2">"CA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"CELG"</span><span class="p">,</span><span class="w"> </span><span class="s2">"CERN"</span><span class="p">,</span><span class="w"> </span><span class="s2">"CHKP"</span><span class="p">,</span><span class="w"> </span><span class="s2">"CHRW"</span><span class="p">,</span><span class="w"> </span><span class="s2">"CHTR"</span><span class="p">,</span><span class="w"> </span><span class="s2">"CMCSA"</span><span class="p">,</span><span class="w">
</span><span class="s2">"COST"</span><span class="p">,</span><span class="w"> </span><span class="s2">"CSCO"</span><span class="p">,</span><span class="w"> </span><span class="s2">"CTRX"</span><span class="p">,</span><span class="w"> </span><span class="s2">"CTSH"</span><span class="p">,</span><span class="w"> </span><span class="s2">"CTXS"</span><span class="p">,</span><span class="w"> </span><span class="s2">"DISCA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"DISCK"</span><span class="p">,</span><span class="w"> </span><span class="s2">"DISH"</span><span class="p">,</span><span class="w">
</span><span class="s2">"DLTR"</span><span class="p">,</span><span class="w"> </span><span class="s2">"DTV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"EBAY"</span><span class="p">,</span><span class="w"> </span><span class="s2">"EQIX"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ESRX"</span><span class="p">,</span><span class="w"> </span><span class="s2">"EXPD"</span><span class="p">,</span><span class="w"> </span><span class="s2">"EXPE"</span><span class="p">,</span><span class="w"> </span><span class="s2">"FAST"</span><span class="p">,</span><span class="w">
</span><span class="s2">"FB"</span><span class="p">,</span><span class="w"> </span><span class="s2">"FFIV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"FISV"</span><span class="p">,</span><span class="w"> </span><span class="s2">"FOXA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"GILD"</span><span class="p">,</span><span class="w"> </span><span class="s2">"GMCR"</span><span class="p">,</span><span class="w"> </span><span class="s2">"GOOG"</span><span class="p">,</span><span class="w"> </span><span class="s2">"GOOGL"</span><span class="p">,</span><span class="w">
</span><span class="s2">"GRMN"</span><span class="p">,</span><span class="w"> </span><span class="s2">"HSIC"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ILMN"</span><span class="p">,</span><span class="w"> </span><span class="s2">"INTC"</span><span class="p">,</span><span class="w"> </span><span class="s2">"INTU"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ISRG"</span><span class="p">,</span><span class="w"> </span><span class="s2">"KLAC"</span><span class="p">,</span><span class="w"> </span><span class="s2">"KRFT"</span><span class="p">,</span><span class="w">
</span><span class="s2">"LBTYA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"LLTC"</span><span class="p">,</span><span class="w"> </span><span class="s2">"LMCA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"LMCK"</span><span class="p">,</span><span class="w"> </span><span class="s2">"LVNTA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"MAR"</span><span class="p">,</span><span class="w"> </span><span class="s2">"MAT"</span><span class="p">,</span><span class="w"> </span><span class="s2">"MDLZ"</span><span class="p">,</span><span class="w">
</span><span class="s2">"MNST"</span><span class="p">,</span><span class="w"> </span><span class="s2">"MSFT"</span><span class="p">,</span><span class="w"> </span><span class="s2">"MU"</span><span class="p">,</span><span class="w"> </span><span class="s2">"MXIM"</span><span class="p">,</span><span class="w"> </span><span class="s2">"MYL"</span><span class="p">,</span><span class="w"> </span><span class="s2">"NFLX"</span><span class="p">,</span><span class="w"> </span><span class="s2">"NTAP"</span><span class="p">,</span><span class="w"> </span><span class="s2">"NVDA"</span><span class="p">,</span><span class="w">
</span><span class="s2">"NXPI"</span><span class="p">,</span><span class="w"> </span><span class="s2">"ORLY"</span><span class="p">,</span><span class="w"> </span><span class="s2">"PAYX"</span><span class="p">,</span><span class="w"> </span><span class="s2">"PCAR"</span><span class="p">,</span><span class="w"> </span><span class="s2">"PCLN"</span><span class="p">,</span><span class="w"> </span><span class="s2">"QCOM"</span><span class="p">,</span><span class="w"> </span><span class="s2">"QVCA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"REGN"</span><span class="p">,</span><span class="w">
</span><span class="s2">"ROST"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SBAC"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SBUX"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SIAL"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SIRI"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SNDK"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SPLS"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SRCL"</span><span class="p">,</span><span class="w">
</span><span class="s2">"STX"</span><span class="p">,</span><span class="w"> </span><span class="s2">"SYMC"</span><span class="p">,</span><span class="w"> </span><span class="s2">"TRIP"</span><span class="p">,</span><span class="w"> </span><span class="s2">"TSCO"</span><span class="p">,</span><span class="w"> </span><span class="s2">"TSLA"</span><span class="p">,</span><span class="w"> </span><span class="s2">"TXN"</span><span class="p">,</span><span class="w"> </span><span class="s2">"VIAB"</span><span class="p">,</span><span class="w"> </span><span class="s2">"VIP"</span><span class="p">,</span><span class="w">
</span><span class="s2">"VOD"</span><span class="p">,</span><span class="w"> </span><span class="s2">"VRSK"</span><span class="p">,</span><span class="w"> </span><span class="s2">"VRTX"</span><span class="p">,</span><span class="w"> </span><span class="s2">"WDC"</span><span class="p">,</span><span class="w"> </span><span class="s2">"WFM"</span><span class="p">,</span><span class="w"> </span><span class="s2">"WYNN"</span><span class="p">,</span><span class="w"> </span><span class="s2">"XLNX"</span><span class="p">,</span><span class="w"> </span><span class="s2">"YHOO"</span><span class="p">)</span><span class="w">
</span><span class="n">getSymbols</span><span class="p">(</span><span class="n">Nasdaq100_Symbols</span><span class="p">)</span><span class="w">

</span><span class="c1"># merge them all together
</span><span class="n">nasdaq100</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">as.xts</span><span class="p">(</span><span class="n">merge</span><span class="p">(</span><span class="n">AAPL</span><span class="p">,</span><span class="w"> </span><span class="n">ADBE</span><span class="p">,</span><span class="w"> </span><span class="n">ADI</span><span class="p">,</span><span class="w"> </span><span class="n">ADP</span><span class="p">,</span><span class="w"> </span><span class="n">ADSK</span><span class="p">,</span><span class="w"> </span><span class="n">AKAM</span><span class="p">,</span><span class="w">
                </span><span class="n">ALTR</span><span class="p">,</span><span class="w"> </span><span class="n">ALXN</span><span class="p">,</span><span class="n">AMAT</span><span class="p">,</span><span class="w"> </span><span class="n">AMGN</span><span class="p">,</span><span class="w"> </span><span class="n">AMZN</span><span class="p">,</span><span class="w"> </span><span class="n">ATVI</span><span class="p">,</span><span class="w"> </span><span class="n">AVGO</span><span class="p">,</span><span class="w"> </span><span class="n">BBBY</span><span class="p">,</span><span class="w"> </span><span class="n">BIDU</span><span class="p">,</span><span class="w"> </span><span class="n">BIIB</span><span class="p">,</span><span class="w">
                 </span><span class="n">BRCM</span><span class="p">,</span><span class="w"> </span><span class="n">CA</span><span class="p">,</span><span class="w"> </span><span class="n">CELG</span><span class="p">,</span><span class="w"> </span><span class="n">CERN</span><span class="p">,</span><span class="w"> </span><span class="n">CHKP</span><span class="p">,</span><span class="w"> </span><span class="n">CHRW</span><span class="p">,</span><span class="w"> </span><span class="n">CHTR</span><span class="p">,</span><span class="w"> </span><span class="n">CMCSA</span><span class="p">,</span><span class="w">
                 </span><span class="n">COST</span><span class="p">,</span><span class="w"> </span><span class="n">CSCO</span><span class="p">,</span><span class="w"> </span><span class="n">CTRX</span><span class="p">,</span><span class="w"> </span><span class="n">CTSH</span><span class="p">,</span><span class="w"> </span><span class="n">CTXS</span><span class="p">,</span><span class="w"> </span><span class="n">DISCA</span><span class="p">,</span><span class="w"> </span><span class="n">DISCK</span><span class="p">,</span><span class="w"> </span><span class="n">DISH</span><span class="p">,</span><span class="w">
                 </span><span class="n">DLTR</span><span class="p">,</span><span class="w"> </span><span class="n">DTV</span><span class="p">,</span><span class="w"> </span><span class="n">EBAY</span><span class="p">,</span><span class="w"> </span><span class="n">EQIX</span><span class="p">,</span><span class="w"> </span><span class="n">ESRX</span><span class="p">,</span><span class="w"> </span><span class="n">EXPD</span><span class="p">,</span><span class="w"> </span><span class="n">EXPE</span><span class="p">,</span><span class="w"> </span><span class="n">FAST</span><span class="p">,</span><span class="w">
                 </span><span class="n">FB</span><span class="p">,</span><span class="w"> </span><span class="n">FFIV</span><span class="p">,</span><span class="w"> </span><span class="n">FISV</span><span class="p">,</span><span class="w"> </span><span class="n">FOXA</span><span class="p">,</span><span class="w"> </span><span class="n">GILD</span><span class="p">,</span><span class="w"> </span><span class="n">GMCR</span><span class="p">,</span><span class="w"> </span><span class="n">GOOG</span><span class="p">,</span><span class="w"> </span><span class="n">GOOGL</span><span class="p">,</span><span class="w">
                 </span><span class="n">GRMN</span><span class="p">,</span><span class="w"> </span><span class="n">HSIC</span><span class="p">,</span><span class="w"> </span><span class="n">ILMN</span><span class="p">,</span><span class="w"> </span><span class="n">INTC</span><span class="p">,</span><span class="w"> </span><span class="n">INTU</span><span class="p">,</span><span class="w"> </span><span class="n">ISRG</span><span class="p">,</span><span class="w"> </span><span class="n">KLAC</span><span class="p">,</span><span class="w"> </span><span class="n">KRFT</span><span class="p">,</span><span class="w">
                 </span><span class="n">LBTYA</span><span class="p">,</span><span class="w"> </span><span class="n">LLTC</span><span class="p">,</span><span class="w"> </span><span class="n">LMCA</span><span class="p">,</span><span class="w"> </span><span class="n">LMCK</span><span class="p">,</span><span class="w"> </span><span class="n">LVNTA</span><span class="p">,</span><span class="w"> </span><span class="n">MAR</span><span class="p">,</span><span class="w"> </span><span class="n">MAT</span><span class="p">,</span><span class="w"> </span><span class="n">MDLZ</span><span class="p">,</span><span class="w">
                 </span><span class="n">MNST</span><span class="p">,</span><span class="w"> </span><span class="n">MSFT</span><span class="p">,</span><span class="w"> </span><span class="n">MU</span><span class="p">,</span><span class="w"> </span><span class="n">MXIM</span><span class="p">,</span><span class="w"> </span><span class="n">MYL</span><span class="p">,</span><span class="w"> </span><span class="n">NFLX</span><span class="p">,</span><span class="w"> </span><span class="n">NTAP</span><span class="p">,</span><span class="w"> </span><span class="n">NVDA</span><span class="p">,</span><span class="w">
                 </span><span class="n">NXPI</span><span class="p">,</span><span class="w"> </span><span class="n">ORLY</span><span class="p">,</span><span class="w"> </span><span class="n">PAYX</span><span class="p">,</span><span class="w"> </span><span class="n">PCAR</span><span class="p">,</span><span class="w"> </span><span class="n">PCLN</span><span class="p">,</span><span class="w"> </span><span class="n">QCOM</span><span class="p">,</span><span class="w"> </span><span class="n">QVCA</span><span class="p">,</span><span class="w"> </span><span class="n">REGN</span><span class="p">,</span><span class="w">
                 </span><span class="n">ROST</span><span class="p">,</span><span class="w"> </span><span class="n">SBAC</span><span class="p">,</span><span class="w"> </span><span class="n">SBUX</span><span class="p">,</span><span class="w"> </span><span class="n">SIAL</span><span class="p">,</span><span class="w"> </span><span class="n">SIRI</span><span class="p">,</span><span class="w"> </span><span class="n">SNDK</span><span class="p">,</span><span class="w"> </span><span class="n">SPLS</span><span class="p">,</span><span class="w"> </span><span class="n">SRCL</span><span class="p">,</span><span class="w">
                 </span><span class="n">STX</span><span class="p">,</span><span class="w"> </span><span class="n">SYMC</span><span class="p">,</span><span class="w"> </span><span class="n">TRIP</span><span class="p">,</span><span class="w"> </span><span class="n">TSCO</span><span class="p">,</span><span class="w"> </span><span class="n">TSLA</span><span class="p">,</span><span class="w"> </span><span class="n">TXN</span><span class="p">,</span><span class="w"> </span><span class="n">VIAB</span><span class="p">,</span><span class="w"> </span><span class="n">VIP</span><span class="p">,</span><span class="w">
                 </span><span class="n">VOD</span><span class="p">,</span><span class="w"> </span><span class="n">VRSK</span><span class="p">,</span><span class="w"> </span><span class="n">VRTX</span><span class="p">,</span><span class="w"> </span><span class="n">WDC</span><span class="p">,</span><span class="w"> </span><span class="n">WFM</span><span class="p">,</span><span class="w"> </span><span class="n">WYNN</span><span class="p">,</span><span class="w"> </span><span class="n">XLNX</span><span class="p">,</span><span class="w"> </span><span class="n">YHOO</span><span class="p">)))</span><span class="w">
</span><span class="n">head</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">[,</span><span class="m">1</span><span class="o">:</span><span class="m">12</span><span class="p">],</span><span class="m">2</span><span class="p">)</span><span class="w">

</span><span class="c1"># set outcome variable
</span><span class="n">outcomeSymbol</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s1">'FISV.Volume'</span><span class="w">

</span><span class="c1"># shift outcome value to be on same line as predictors
</span><span class="n">library</span><span class="p">(</span><span class="n">xts</span><span class="p">)</span><span class="w">
</span><span class="n">nasdaq100</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">xts</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">,</span><span class="n">order.by</span><span class="o">=</span><span class="n">as.Date</span><span class="p">(</span><span class="n">rownames</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">)))</span><span class="w">
</span><span class="n">nasdaq100</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.data.frame</span><span class="p">(</span><span class="n">merge</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">,</span><span class="w"> </span><span class="n">lm1</span><span class="o">=</span><span class="n">lag</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">[,</span><span class="n">outcomeSymbol</span><span class="p">],</span><span class="m">-1</span><span class="p">)))</span><span class="w">
</span><span class="n">nasdaq100</span><span class="o">$</span><span class="n">outcome</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">[,</span><span class="n">paste0</span><span class="p">(</span><span class="n">outcomeSymbol</span><span class="p">,</span><span class="s1">'.1'</span><span class="p">)]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">nasdaq100</span><span class="p">[,</span><span class="n">outcomeSymbol</span><span class="p">],</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w">

</span><span class="c1"># remove shifted down volume field as we don't care by the value
</span><span class="n">nasdaq100</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nasdaq100</span><span class="p">[,</span><span class="o">!</span><span class="nf">names</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">)</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">paste0</span><span class="p">(</span><span class="n">outcomeSymbol</span><span class="p">,</span><span class="s1">'.1'</span><span class="p">))]</span><span class="w">

</span><span class="c1"># cast date to true date and order in decreasing order
</span><span class="n">nasdaq100</span><span class="o">$</span><span class="n">date</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.Date</span><span class="p">(</span><span class="n">row.names</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">))</span><span class="w">
</span><span class="n">nasdaq100</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nasdaq100</span><span class="p">[</span><span class="n">order</span><span class="p">(</span><span class="n">as.Date</span><span class="p">(</span><span class="n">nasdaq100</span><span class="o">$</span><span class="n">date</span><span class="p">,</span><span class="w"> </span><span class="s2">"%m/%d/%Y"</span><span class="p">),</span><span class="w"> </span><span class="n">decreasing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),]</span><span class="w">

</span><span class="c1"># calculate all day differences and populate them on same row
</span><span class="n">GetDiffDays</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">objDF</span><span class="p">,</span><span class="n">days</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">10</span><span class="p">),</span><span class="w"> </span><span class="n">offLimitsSymbols</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s1">'outcome'</span><span class="p">),</span><span class="w"> </span><span class="n">roundByScaler</span><span class="o">=</span><span class="m">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="c1"># needs to be sorted by date in decreasing order
</span><span class="w">        </span><span class="n">ind</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sapply</span><span class="p">(</span><span class="n">objDF</span><span class="p">,</span><span class="w"> </span><span class="n">is.numeric</span><span class="p">)</span><span class="w">
        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">sym</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">objDF</span><span class="p">)[</span><span class="n">ind</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">sym</span><span class="w"> </span><span class="o">%in%</span><span class="w"> </span><span class="n">offLimitsSymbols</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="n">print</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s1">'*********'</span><span class="p">,</span><span class="w"> </span><span class="n">sym</span><span class="p">))</span><span class="w">
                        </span><span class="n">objDF</span><span class="p">[,</span><span class="n">sym</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="n">scale</span><span class="p">(</span><span class="n">objDF</span><span class="p">[,</span><span class="n">sym</span><span class="p">]),</span><span class="n">roundByScaler</span><span class="p">)</span><span class="w">

                        </span><span class="n">print</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s1">'theColName'</span><span class="p">,</span><span class="w"> </span><span class="n">sym</span><span class="p">))</span><span class="w">
                        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">day</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">days</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
                                </span><span class="n">objDF</span><span class="p">[</span><span class="n">paste0</span><span class="p">(</span><span class="n">sym</span><span class="p">,</span><span class="s1">'_'</span><span class="p">,</span><span class="n">day</span><span class="p">)]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">diff</span><span class="p">(</span><span class="n">objDF</span><span class="p">[,</span><span class="n">sym</span><span class="p">],</span><span class="n">lag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">day</span><span class="p">),</span><span class="nf">rep</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="m">0</span><span class="p">,</span><span class="n">day</span><span class="p">))</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">-1</span><span class="w">
                        </span><span class="p">}</span><span class="w">
                </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
        </span><span class="n">return</span><span class="w"> </span><span class="p">(</span><span class="n">objDF</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c1"># call the function with the following differences
</span><span class="n">nasdaq100</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">GetDiffDays</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">,</span><span class="w"> </span><span class="n">days</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">2</span><span class="p">,</span><span class="m">3</span><span class="p">,</span><span class="m">4</span><span class="p">,</span><span class="m">5</span><span class="p">,</span><span class="m">10</span><span class="p">,</span><span class="m">20</span><span class="p">),</span><span class="w"> </span><span class="n">offLimitsSymbols</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s1">'outcome'</span><span class="p">),</span><span class="w"> </span><span class="n">roundByScaler</span><span class="o">=</span><span class="m">2</span><span class="p">)</span><span class="w">

</span><span class="c1"># drop most recent entry as we don't have an outcome
</span><span class="n">nasdaq100</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nasdaq100</span><span class="p">[</span><span class="m">2</span><span class="o">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">),]</span><span class="w">

</span><span class="c1"># take a peek at YHOO features:
</span><span class="n">dput</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">)[</span><span class="n">grepl</span><span class="p">(</span><span class="s1">'YHOO.'</span><span class="p">,</span><span class="nf">names</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">))])</span><span class="w">

</span><span class="c1"># well use POSIXlt to add day of the week, day of the month, day of the year
</span><span class="n">nasdaq100</span><span class="o">$</span><span class="n">wday</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.POSIXlt</span><span class="p">(</span><span class="n">nasdaq100</span><span class="o">$</span><span class="n">date</span><span class="p">)</span><span class="o">$</span><span class="n">wday</span><span class="w">
</span><span class="n">nasdaq100</span><span class="o">$</span><span class="n">yday</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.POSIXlt</span><span class="p">(</span><span class="n">nasdaq100</span><span class="o">$</span><span class="n">date</span><span class="p">)</span><span class="o">$</span><span class="n">mday</span><span class="w">
</span><span class="n">nasdaq100</span><span class="o">$</span><span class="n">mon</span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.POSIXlt</span><span class="p">(</span><span class="n">nasdaq100</span><span class="o">$</span><span class="n">date</span><span class="p">)</span><span class="o">$</span><span class="n">mon</span><span class="w">

</span><span class="c1"># remove date field and shuffle data frame
</span><span class="n">nasdaq100</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">subset</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">,</span><span class="w"> </span><span class="n">select</span><span class="o">=-</span><span class="nf">c</span><span class="p">(</span><span class="n">date</span><span class="p">))</span><span class="w">
</span><span class="n">nasdaq100</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nasdaq100</span><span class="p">[</span><span class="n">sample</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">)),]</span><span class="w">

</span><span class="c1"># let's model
</span><span class="n">library</span><span class="p">(</span><span class="n">caret</span><span class="p">)</span><span class="w">
</span><span class="n">predictorNames</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">)[</span><span class="nf">names</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">'outcome'</span><span class="p">]</span><span class="w">

</span><span class="n">set.seed</span><span class="p">(</span><span class="m">1234</span><span class="p">)</span><span class="w">
</span><span class="n">split</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sample</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">),</span><span class="w"> </span><span class="nf">floor</span><span class="p">(</span><span class="m">0.7</span><span class="o">*</span><span class="n">nrow</span><span class="p">(</span><span class="n">nasdaq100</span><span class="p">)))</span><span class="w">
</span><span class="n">train</span><span class="w"> </span><span class="o">&lt;-</span><span class="n">nasdaq100</span><span class="p">[</span><span class="n">split</span><span class="p">,]</span><span class="w">
</span><span class="n">test</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">nasdaq100</span><span class="p">[</span><span class="o">-</span><span class="n">split</span><span class="p">,]</span><span class="w">

</span><span class="n">train</span><span class="o">$</span><span class="n">outcome</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">train</span><span class="o">$</span><span class="n">outcome</span><span class="o">==</span><span class="m">1</span><span class="p">,</span><span class="s1">'yes'</span><span class="p">,</span><span class="s1">'nope'</span><span class="p">)</span><span class="w">
</span><span class="c1"># create caret trainControl object to control the number of cross-validations performed
</span><span class="n">objControl</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">trainControl</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">'cv'</span><span class="p">,</span><span class="w"> </span><span class="n">number</span><span class="o">=</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">returnResamp</span><span class="o">=</span><span class="s1">'none'</span><span class="p">,</span><span class="w"> </span><span class="n">summaryFunction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">twoClassSummary</span><span class="p">,</span><span class="w"> </span><span class="n">classProbs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">

</span><span class="c1"># run model
</span><span class="n">bst</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">train</span><span class="p">(</span><span class="n">train</span><span class="p">[,</span><span class="n">predictorNames</span><span class="p">],</span><span class="w">  </span><span class="n">as.factor</span><span class="p">(</span><span class="n">train</span><span class="o">$</span><span class="n">outcome</span><span class="p">),</span><span class="w">
                                   </span><span class="n">method</span><span class="o">=</span><span class="s1">'gbm'</span><span class="p">,</span><span class="w">
                                   </span><span class="n">trControl</span><span class="o">=</span><span class="n">objControl</span><span class="p">,</span><span class="w">
                                   </span><span class="n">metric</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ROC"</span><span class="p">,</span><span class="w">
                                   </span><span class="n">tuneGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expand.grid</span><span class="p">(</span><span class="n">n.trees</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="n">interaction.depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="n">shrinkage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">)</span><span class="w">
</span><span class="p">)</span><span class="w">

</span><span class="n">predictions</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">object</span><span class="o">=</span><span class="n">bst</span><span class="p">,</span><span class="w"> </span><span class="n">train</span><span class="p">[,</span><span class="n">predictorNames</span><span class="p">],</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s1">'prob'</span><span class="p">)</span><span class="w">
</span><span class="n">library</span><span class="p">(</span><span class="n">pROC</span><span class="p">)</span><span class="w">
</span><span class="n">auc</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">auc</span><span class="p">(</span><span class="n">train</span><span class="o">$</span><span class="n">outcome</span><span class="p">,</span><span class="n">predictions</span><span class="p">[[</span><span class="m">2</span><span class="p">]])</span><span class="w">
</span><span class="n">print</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s1">'AUC score:'</span><span class="p">,</span><span class="w"> </span><span class="n">auc</span><span class="p">))</span><span class="w">



</span></code></pre>
</div>
		
</div>
    

		</div>		 
	 </div>   
 
</main>


{% include footer.html %}
  </body>
</html>
