---
---
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="Machine Learning, R Programming, Statistics, Artificial Intelligence">
    <meta name="author" content="Manuel Amunategui">
    <link rel="icon" href="../favicon.ico">

    <title>Data Exploration & Machine Learning, Hands-on</title>

    {% include externals.html %}
  
</head>

<body>

<main role="main">

{% include header.html %}

<div class="container">
  <div class="blog-header">
    <h1 class="blog-title">Yelp, httr and a Romantic Trip Across the United States, One Florist at a Time </h1>
    <p class="lead blog-description">Practical walkthroughs on machine learning, data exploration and finding insight.</p>
  </div>
   
 <p style="text-align:center">
 
    <p><img src="img/cross-country-florist.png" alt="plot of chunk cross-country-florist" />
<br /><br /></p>

<p><strong>Resources</strong></p>
<ul>
<li type="square"><a href="https://www.youtube.com/watch?v=DOKw-MtlxsU" target="_blank">YouTube Companion Video</a></li>
<li type="square"><a href="#sourcecode">Full Source Code</a></li>
</ul>
<p><br />
<strong>Packages Used in this Walkthrough</strong></p>

<ul>
        <li type="square"><b>{httr}</b> - Tools for Working with URLs and HTTP</li>
        <li type="square"><b>{jsonlite}</b> - Robust, High Performance JSON Parser and Generator for R</li>
        <li type="square"><b>{ggplot2}</b> - Implementation of the Grammar of Graphics</li>
        <li type="square"><b>{ggmap}</b> - Spatial visualization with Google Maps and OpenStreetMap</li>
</ul>
<p><br /><br />
Just in time for <b>Valentine’s Day</b>, if you happen to be planning a trip across the United States and want to offer your companion a rose at every degree of latitude traveled, then this walkthrough is for you! The title says it all, we’re going to use the <a href="http://www.yelp.com/" target="_blank">Yelp</a> API to cross the United States from San Francisco, CA to New York City, NY, and be 60 miles from a florist at all times.
<br /><br />
This walkthrough has two parts, first exploring the basics of Yelp and <a href="http://cran.r-project.org/web/packages/httr/vignettes/quickstart.html" target="_blank">httr</a>, and finally looking at a mapping script to hop from florist to florist across the country. The itinerary will be plotted on <a href="http://cran.r-project.org/web/packages/ggmap/index.html" target="_blank">ggmap</a>. <i>If all you need is to pull locations via Yelp, then the first part is all you need.</i>
<br /><br />
<strong>Part 1: Yelp and httr</strong></p>

<p>We’ll look at two different ways of using the <a href="http://www.yelp.com/developers/documentation/v2/search_api" target="_blank">Yelp Search API</a>. For either of them, you will need to sign up for a free <a href="http://www.yelp.com/developers/" target="_blank">Yelp account</a> and request <a href="http://www.yelp.com/developers/manage_api_keys" target="_blank">API keys</a>.</p>

<p>The simplest and probably most common way of using the API, is to request a term for a specific city or address. This is what the URL would look like for the term <code class="highlighter-rouge">food</code> around <code class="highlighter-rouge">San Franciso</code>:</p>

<blockquote>http://api.yelp.com/v2/search?term=food&amp;location=San+Francisco</blockquote>

<p>Unfortunately, its a bit more complicated than simply dropping that in a browser. To authenticate (i.e. be recognized as a registered user), Yelp uses <a href="http://tools.ietf.org/html/rfc5849" target="_blank">OAuth v1.0a protocol</a>.</p>

<p>This is a cleaver of way authenticating you without exposing your account or password. On a very high level, it is done with a two-step process, first we ask Yelp for a signature key through a GET command, then we use that returned temporary key to retrieve our locations. Check out <a href="http://www.yelp.com/developers/documentation/v2/authentication" target="_blank">Yelp’s authentication docs</a> for more details.</p>

<p>This is a lot of work to do manually, but the handy <a href="http://cran.r-project.org/web/packages/httr/index.html" target="_blank">httr package</a> from Hadley Wickham handles a lot of the authentication details automatically. It’s a really cool package as it can ‘shake hands’ with many <b>HTTP</b> API’s (Twitter, Facebook, Linkedin, Google, etc).</p>

<p>After you get your keys from <b>Yelp</b>, swap them for the x’s in the code below:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">consumerKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"xxxx"</span><span class="w">
</span><span class="n">consumerSecret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"xxxx"</span><span class="w">
</span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"xxxx"</span><span class="w">
</span><span class="n">tokenSecret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"xxxx"</span><span class="w">
</span></code></pre>
</div>
<p><br /><br />
Load up the <b>httr</b> library and call the <code class="highlighter-rouge">oauth_app</code> function passing it a name tag (can be anything you want), and your <code class="highlighter-rouge">consumer</code> credentials. Next call up the <code class="highlighter-rouge">sign_oauth1.0</code>, pass it the <code class="highlighter-rouge">myapp</code> object along with your <code class="highlighter-rouge">token</code> credentials:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">require</span><span class="p">(</span><span class="n">httr</span><span class="p">)</span><span class="w">
</span><span class="n">myApp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">oauth_app</span><span class="p">(</span><span class="s2">"YELP"</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="o">=</span><span class="n">consumerKey</span><span class="p">,</span><span class="w"> </span><span class="n">secret</span><span class="o">=</span><span class="n">consumerSecret</span><span class="p">)</span><span class="w">
</span><span class="n">mySignature</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sign_oauth1.0</span><span class="p">(</span><span class="n">myApp</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span><span class="w"> </span><span class="n">token_secret</span><span class="o">=</span><span class="n">tokenSecret</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>
<p><br /><br />
** Searching by Locations**</p>

<p>Your signature is ready to be used on a <b>Yelp</b> search query:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">yelpURL</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="s2">"http://api.yelp.com/v2/search/?limit=3&amp;term=food&amp;location=San%20Francisco"</span><span class="p">)</span><span class="w">
</span><span class="n">locationData</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">GET</span><span class="p">(</span><span class="n">yelpURL</span><span class="p">,</span><span class="w"> </span><span class="n">mySignature</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>
<p><br /><br />
That is it! We entered the term <b>food</b> in <b>San Francisco</b> and asked to limit it to <code class="highlighter-rouge">3</code> result. Let’s use the JSON parser, <a href="http://cran.r-project.org/web/packages/jsonlite/index.html" target="_blank">jsonlite</a> to extract the results the results:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">require</span><span class="p">(</span><span class="n">jsonlite</span><span class="p">)</span><span class="w">
</span><span class="n">locationDataContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">content</span><span class="p">(</span><span class="n">locationData</span><span class="p">)</span><span class="w">
</span><span class="n">locationList</span><span class="o">=</span><span class="n">jsonlite</span><span class="o">::</span><span class="n">fromJSON</span><span class="p">(</span><span class="n">toJSON</span><span class="p">(</span><span class="n">locationDataContent</span><span class="p">))</span><span class="w">
</span><span class="n">results</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">locationList</span><span class="p">)</span><span class="w">
</span><span class="n">results</span><span class="o">$</span><span class="n">businesses.name</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## [[1]]
## [1] "Ike's Place"
## 
## [[2]]
## [1] "The Italian Homemade Company"
## 
## [[3]]
## [1] "The Codmother Fish and Chips"
</code></pre>
</div>
<p><br /><br />
<code class="highlighter-rouge">results$businesses.name</code> returned 3 businesses, but offers a whole lot more:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="nf">names</span><span class="p">(</span><span class="n">results</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>##  [1] "region.span.latitude_delta"      "region.span.longitude_delta"    
##  [3] "region.center.latitude"          "region.center.longitude"        
##  [5] "total"                           "businesses.is_claimed"          
##  [7] "businesses.rating"               "businesses.mobile_url"          
##  [9] "businesses.rating_img_url"       "businesses.review_count"        
## [11] "businesses.name"                 "businesses.snippet_image_url"   
## [13] "businesses.rating_img_url_small" "businesses.url"                 
## [15] "businesses.menu_date_updated"    "businesses.phone"               
## [17] "businesses.snippet_text"         "businesses.image_url"           
## [19] "businesses.categories"           "businesses.display_phone"       
## [21] "businesses.rating_img_url_large" "businesses.menu_provider"       
## [23] "businesses.id"                   "businesses.is_closed"           
## [25] "businesses.location"
</code></pre>
</div>
<p><br /><br />
Obviously, the terms <b>food</b> and <b>San Francisco</b> are way too vague, but you get the idea. Next we’ll search by geo-spatial coordinates.
<br /><br />
** Searching by Geo-Spatial Coordinates**</p>

<p>This is very close to what we did above except we specify the location down to the latitude and longitude of the desired area. How about 3 bars by Montgomery and Market Streets in San Francisco:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">yelpURL</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="s2">"http://api.yelp.com/v2/search/?limit=3&amp;ll=37.788022,-122.399797&amp;term=bar"</span><span class="p">)</span><span class="w">
</span><span class="n">locationData</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">GET</span><span class="p">(</span><span class="n">yelpURL</span><span class="p">,</span><span class="w"> </span><span class="n">mySignature</span><span class="p">)</span><span class="w">
</span><span class="n">require</span><span class="p">(</span><span class="n">jsonlite</span><span class="p">)</span><span class="w">
</span><span class="n">locationDataContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">content</span><span class="p">(</span><span class="n">locationData</span><span class="p">)</span><span class="w">
</span><span class="n">locationList</span><span class="o">=</span><span class="n">jsonlite</span><span class="o">::</span><span class="n">fromJSON</span><span class="p">(</span><span class="n">toJSON</span><span class="p">(</span><span class="n">locationDataContent</span><span class="p">))</span><span class="w">
</span><span class="n">results</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="n">locationList</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">results</span><span class="o">$</span><span class="n">businesses.name</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## [[1]]
## [1] "83 Proof"
## 
## [[2]]
## [1] "Topsy's Fun House"
## 
## [[3]]
## [1] "Rickhouse"
</code></pre>
</div>
<p><br /><br />
The difference is syntactical, instead of building the URL with <code class="highlighter-rouge">location</code>, we do it with <code class="highlighter-rouge">ll</code>. We’ll use a third way of pulling locations in part 2 - geo-spatial bounded boxes. That’s it for part 1.
<br /><br /></p>

<p><strong>Part 2: Hoping from Florist to Florist Across the United States</strong></p>

<p>Let me tell you, this was a blast to design and build! I’ll go over the pertinent parts but if you want to see this in action yourself, copy the code at the end of the walkthrough and replace the Yelp credentials with yours and you’re good to go!</p>

<p>Though not a full-proof application (matter of fact it can only travel west to east), it will take a departure and destination set of latitudes and longitudes, a search term and attempt to link both points with a path using your search term every 60 miles (approximately 1 geo-coordinate degree). Here, we will go from San Francisco, CA to New York City, NY, florist by florist.</p>

<p><code class="highlighter-rouge">ggmap</code> has a handy function called <code class="highlighter-rouge">geocode</code>. You can give it addresses, zip codes, even famous monuments, and it will return latitude and longitude coordinates.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">require</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span><span class="w">
</span><span class="n">require</span><span class="p">(</span><span class="n">ggmap</span><span class="p">)</span><span class="w">
</span><span class="n">startingpoint</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">geocode</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"Fishersman's Wharf, San Francisco, CA"</span><span class="p">))</span><span class="w">
</span><span class="n">print</span><span class="p">(</span><span class="n">startingpoint</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>##      lon   lat
## 1 -122.4 37.81
</code></pre>
</div>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">endingpoint</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">geocode</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"Chelsea Piers, NY"</span><span class="p">))</span><span class="w">
</span><span class="n">print</span><span class="p">(</span><span class="n">endingpoint</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>##      lon   lat
## 1 -74.01 40.75
</code></pre>
</div>
<p><br /><br />
Now that we know our starting and ending points, let’s start our first point manually then generalize the tasks through functions.</p>

<p>We’ll use <code class="highlighter-rouge">ggmap</code> to import a map of the United States from Google (see <a href="http://amunategui.github.io/ggmap-example/" target="_blank">Mapping The United States Census With {ggmap}</a> for more details on <code class="highlighter-rouge">ggmap</code>). <code class="highlighter-rouge">ggplot2</code> accepts a data frame, let’s make one with our start and end points and see the journey that lies ahead. We’ll assign them large sizes to differentiate them from the traveling points:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">latitudes</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">startingpoint</span><span class="o">$</span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="n">endingpoint</span><span class="o">$</span><span class="n">lat</span><span class="p">)</span><span class="w">
</span><span class="n">longitudes</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">startingpoint</span><span class="o">$</span><span class="n">lon</span><span class="p">,</span><span class="w"> </span><span class="n">endingpoint</span><span class="o">$</span><span class="n">lon</span><span class="p">)</span><span class="w">

</span><span class="n">objdf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="s1">'latitude'</span><span class="o">=</span><span class="n">latitudes</span><span class="p">,</span><span class="w">
                    </span><span class="s1">'longitude'</span><span class="o">=</span><span class="n">longitudes</span><span class="p">,</span><span class="w">
                    </span><span class="s1">'size'</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">10</span><span class="p">,</span><span class="m">10</span><span class="p">),</span><span class="w">
                    </span><span class="s1">'color'</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="s1">'red'</span><span class="p">,</span><span class="s1">'red'</span><span class="p">))</span><span class="w">

</span><span class="c1"># get a Google map
</span><span class="n">map</span><span class="o">&lt;-</span><span class="n">get_map</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="s1">'united states'</span><span class="p">,</span><span class="w"> </span><span class="n">zoom</span><span class="o">=</span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">maptype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"terrain"</span><span class="p">,</span><span class="w">
             </span><span class="n">source</span><span class="o">=</span><span class="s1">'google'</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">'color'</span><span class="p">)</span><span class="w">

</span><span class="n">objMap</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggmap</span><span class="p">(</span><span class="n">map</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">geom_point</span><span class="p">(</span><span class="w">
        </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">longitude</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">latitude</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span><span class="w"> 
            </span><span class="n">show_guide</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">color</span><span class="p">),</span><span class="w"> 
        </span><span class="n">data</span><span class="o">=</span><span class="n">objdf</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="m">.8</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">)</span><span class="w"> 

</span><span class="c1"># call the objMap object to see the plot 
</span><span class="n">objMap</span><span class="w">
</span></code></pre>
</div>

<p><img src="img/startendpoint.png" alt="plot of chunk startendpoint" />
<br /><br />
I will keep the details short on the next few functions. <code class="highlighter-rouge">MapIt</code> takes geo-spatial coordinates, a size, and the <code class="highlighter-rouge">ggmap</code> object. The function will return the <code class="highlighter-rouge">ggmap</code> object and we need to always pass the same <code class="highlighter-rouge">ggmap</code> back if we want to update and track the journey’s history.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">MapIt</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">latitude</span><span class="p">,</span><span class="w"> </span><span class="n">longitude</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">objggmap</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">objdf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="s1">'latitude'</span><span class="o">=</span><span class="n">latitude</span><span class="p">,</span><span class="w">
                            </span><span class="s1">'longitude'</span><span class="o">=</span><span class="n">longitude</span><span class="p">,</span><span class="w">
                            </span><span class="s1">'tsize'</span><span class="o">=</span><span class="n">size</span><span class="p">)</span><span class="w">
        
        </span><span class="c1"># add new point to ggmap
</span><span class="w">        </span><span class="n">require</span><span class="p">(</span><span class="s2">"ggplot2"</span><span class="p">)</span><span class="w">
        </span><span class="n">require</span><span class="p">(</span><span class="s2">"ggmap"</span><span class="p">)</span><span class="w">
        </span><span class="n">objggmap</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">objggmap</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">geom_point</span><span class="p">(</span><span class="w">
                </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">longitude</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">latitude</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="n">tsize</span><span class="p">,</span><span class="w"> 
                    </span><span class="n">show_guide</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w"> 
                </span><span class="n">data</span><span class="o">=</span><span class="n">objdf</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="m">.8</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">)</span><span class="w">  
        </span><span class="n">return</span><span class="w"> </span><span class="p">(</span><span class="n">objggmap</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>
<p><br /><br />
<code class="highlighter-rouge">GetBestYelpLocation</code>, as its name implies, takes a vector of two sets of geo-spatial coordinates, the upper left point and the lower right one, along with the search term and sends it to Yelp. It returns a data frame with the <code class="highlighter-rouge">name</code>, <code class="highlighter-rouge">city</code>, <code class="highlighter-rouge">rating</code>, <code class="highlighter-rouge">state</code>, <code class="highlighter-rouge">latitude</code> and <code class="highlighter-rouge">longitude</code> of the top location using the search term.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">GetBestYelpLocation</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">boundedcoordinates</span><span class="p">,</span><span class="w"> </span><span class="n">term</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">limit</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="w">
        
        </span><span class="n">YelpUrl</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="s2">"http://api.yelp.com/v2/search/?limit=20&amp;bounds="</span><span class="p">,</span><span class="w">
                          </span><span class="n">boundedcoordinates</span><span class="p">[</span><span class="m">1</span><span class="p">],</span><span class="s2">","</span><span class="p">,</span><span class="n">boundedcoordinates</span><span class="p">[</span><span class="m">2</span><span class="p">],</span><span class="w">
                          </span><span class="s2">"|"</span><span class="p">,</span><span class="n">boundedcoordinates</span><span class="p">[</span><span class="m">3</span><span class="p">],</span><span class="s2">","</span><span class="p">,</span><span class="n">boundedcoordinates</span><span class="p">[</span><span class="m">4</span><span class="p">],</span><span class="s2">"&amp;term="</span><span class="p">,</span><span class="n">term</span><span class="p">)</span><span class="w">
         
        </span><span class="n">locationdata</span><span class="o">=</span><span class="n">GET</span><span class="p">(</span><span class="n">YelpUrl</span><span class="p">,</span><span class="w"> </span><span class="n">mySignature</span><span class="p">)</span><span class="w">
        </span><span class="n">listMembersContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">content</span><span class="p">(</span><span class="n">locationdata</span><span class="p">)</span><span class="w">
        </span><span class="n">listMembers</span><span class="o">=</span><span class="n">jsonlite</span><span class="o">::</span><span class="n">fromJSON</span><span class="p">(</span><span class="n">toJSON</span><span class="p">(</span><span class="n">listMembersContent</span><span class="p">))</span><span class="w">
        
        </span><span class="n">yelpResults</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tryCatch</span><span class="p">({</span><span class="w">
                </span><span class="n">data.frame</span><span class="p">(</span><span class="n">listMembers</span><span class="p">)</span><span class="w">
        </span><span class="p">},</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> 
                </span><span class="kc">NULL</span><span class="w">
        </span><span class="p">})</span><span class="w">
        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nf">is.null</span><span class="p">(</span><span class="n">yelpResults</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="n">set1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="s2">"name"</span><span class="o">=</span><span class="n">yelpResults</span><span class="o">$</span><span class="n">businesses.name</span><span class="p">,</span><span class="w">
                   </span><span class="s1">'city'</span><span class="o">=</span><span class="n">yelpResults</span><span class="o">$</span><span class="n">businesses.location</span><span class="o">$</span><span class="n">city</span><span class="p">,</span><span class="w">
                   </span><span class="s1">'rating'</span><span class="o">=</span><span class="n">yelpResults</span><span class="o">$</span><span class="n">businesses.rating</span><span class="p">,</span><span class="w"> 
                   </span><span class="s1">'latitude'</span><span class="o">=</span><span class="n">yelpResults</span><span class="o">$</span><span class="n">businesses.location</span><span class="o">$</span><span class="n">coordinate</span><span class="o">$</span><span class="n">latitude</span><span class="p">,</span><span class="w">
                   </span><span class="s1">'longitude'</span><span class="o">=</span><span class="n">yelpResults</span><span class="o">$</span><span class="n">businesses.location</span><span class="o">$</span><span class="n">coordinate</span><span class="o">$</span><span class="n">longitude</span><span class="p">,</span><span class="w">
                   </span><span class="s1">'state'</span><span class="o">=</span><span class="n">yelpResults</span><span class="o">$</span><span class="n">businesses.location</span><span class="o">$</span><span class="n">state_code</span><span class="p">)</span><span class="w">
                 
                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ind</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">set1</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">set1</span><span class="o">$</span><span class="n">latitude</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">boundedcoordinates</span><span class="p">[</span><span class="m">1</span><span class="p">])</span><span class="w"> </span><span class="o">&amp;</span><span class="w">
                                </span><span class="p">(</span><span class="n">set1</span><span class="o">$</span><span class="n">latitude</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">boundedcoordinates</span><span class="p">[</span><span class="m">3</span><span class="p">])</span><span class="w"> </span><span class="o">&amp;</span><span class="w">
                                </span><span class="p">(</span><span class="n">set1</span><span class="o">$</span><span class="n">longitude</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">boundedcoordinates</span><span class="p">[</span><span class="m">2</span><span class="p">])</span><span class="w"> </span><span class="o">&amp;</span><span class="w">
                                </span><span class="p">(</span><span class="n">set1</span><span class="o">$</span><span class="n">longitude</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">boundedcoordinates</span><span class="p">[</span><span class="m">4</span><span class="p">]))</span><span class="w">
                                </span><span class="nf">return</span><span class="p">(</span><span class="n">set1</span><span class="p">[</span><span class="n">ind</span><span class="p">,])</span><span class="w">
                </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
        </span><span class="nf">return</span><span class="p">(</span><span class="kc">NULL</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>
<p><br /><br />
<code class="highlighter-rouge">GetPossibleCoordinates</code> takes the current position of our traveler and calculates its bounded box. The default bounded box unit is 1 degree (equates loosely around 60 miles), so we add 30 miles in all four directions from the current point to created the bounded square (making it a 1x1 degree box, or 60x60 miles box).</p>

<p><img src="img/nextmove.png" alt="plot of chunk newmove" />
<br /><br />
It returns the next two possible moves, both forward but one higher and one lower (see image below).</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">GetPossibleCoordinates</span><span class="o">&lt;-</span><span class="k">function</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="n">lon</span><span class="p">,</span><span class="w"> </span><span class="n">area</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="c1"># this is hard to keep track but each location's next move
</span><span class="w">        </span><span class="c1"># equates attempting to move forward one square, the same area
</span><span class="w">        </span><span class="c1"># as the previous one but half-way above and half-way below the
</span><span class="w">        </span><span class="c1"># previous one.
</span><span class="w">        </span><span class="n">halfarea</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">area</span><span class="o">/</span><span class="m">2</span><span class="w">
    
        </span><span class="c1"># new forward top square area
</span><span class="w">        </span><span class="n">topArea_upperleft_latitude</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lat</span><span class="o">+</span><span class="n">area</span><span class="w">
        </span><span class="n">topArea_upperleft_longitude</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lon</span><span class="o">+</span><span class="n">halfarea</span><span class="w">
        
        </span><span class="n">topArea_lowerright_latitude</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lat</span><span class="w">
        </span><span class="n">topArea_lowerright_longitude</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lon</span><span class="o">+</span><span class="p">(</span><span class="n">halfarea</span><span class="o">+</span><span class="n">area</span><span class="p">)</span><span class="w">
        
        </span><span class="c1"># new forward bottom square area
</span><span class="w">        </span><span class="n">bottomArea_upperleft_latitude</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lat</span><span class="w">
        </span><span class="n">bottomArea_upperleft_longitude</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lon</span><span class="o">+</span><span class="n">halfarea</span><span class="w">
        
        </span><span class="n">bottomArea_lowerright_latitude</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lat</span><span class="o">-</span><span class="n">area</span><span class="w">
        </span><span class="n">bottomArea_lowerright_longitude</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lon</span><span class="o">+</span><span class="p">(</span><span class="n">halfarea</span><span class="o">+</span><span class="n">area</span><span class="p">)</span><span class="w">
          
        
        </span><span class="n">rownames</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'new_top_area'</span><span class="p">,</span><span class="s1">'new_bottom_area'</span><span class="p">)</span><span class="w">
        </span><span class="n">latitude_point1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">topArea_upperleft_latitude</span><span class="p">,</span><span class="w"> </span><span class="n">bottomArea_upperleft_latitude</span><span class="p">)</span><span class="w">
        </span><span class="n">longitude_point1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">topArea_upperleft_longitude</span><span class="p">,</span><span class="w"> </span><span class="n">bottomArea_upperleft_longitude</span><span class="p">)</span><span class="w">
        </span><span class="n">latitude_point2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">topArea_lowerright_latitude</span><span class="p">,</span><span class="w"> </span><span class="n">bottomArea_lowerright_latitude</span><span class="p">)</span><span class="w">
        </span><span class="n">longitude_point2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">topArea_lowerright_longitude</span><span class="p">,</span><span class="w"> </span><span class="n">bottomArea_lowerright_longitude</span><span class="p">)</span><span class="w">
        
        </span><span class="n">return</span><span class="w"> </span><span class="p">(</span><span class="n">data.frame</span><span class="p">(</span><span class="s1">'direction'</span><span class="o">=</span><span class="n">rownames</span><span class="p">,</span><span class="w">
                </span><span class="s1">'latitude_point1'</span><span class="o">=</span><span class="n">latitude_point1</span><span class="p">,</span><span class="w">
                           </span><span class="s1">'longitude_point1'</span><span class="o">=</span><span class="n">longitude_point1</span><span class="p">,</span><span class="w">
                           </span><span class="s1">'latitude_point2'</span><span class="o">=</span><span class="n">latitude_point2</span><span class="p">,</span><span class="w">
                           </span><span class="s1">'longitude_point2'</span><span class="o">=</span><span class="n">longitude_point2</span><span class="p">))</span><span class="w">
         
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>
<p><br /><br />
Finally, <code class="highlighter-rouge">MakeAMove</code> is the central relay that communicates with the other functions. It will get the next coordinates via <code class="highlighter-rouge">GetPossibleCoordinates</code>, figure out if it should try up or down first depending on where it is in relation to the end point’s latitude, and call on the Yelp API. If it finds a florist, it will report back the pertinent information such as the florist’s name, state, and coordinates. If it can’t find one, it will report so by returning <code class="highlighter-rouge">NULL</code>.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">MakeAMove</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span><span class="n">lon</span><span class="p">,</span><span class="n">sizebox</span><span class="p">,</span><span class="w"> </span><span class="n">searchTerm</span><span class="p">,</span><span class="w"> </span><span class="n">lat_endPoint</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">possibleCoordinates</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">GetPossibleCoordinates</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span><span class="n">lon</span><span class="p">,</span><span class="n">sizebox</span><span class="p">)</span><span class="w">
        
        </span><span class="c1"># go up or down first depending on latitude of end point
</span><span class="w">        </span><span class="n">searchOrder</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'new_top_area'</span><span class="p">,</span><span class="s1">'new_bottom_area'</span><span class="p">)</span><span class="w">
        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lat</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">lat_endPoint</span><span class="p">)</span><span class="w">
                </span><span class="n">searchOrder</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'new_bottom_area'</span><span class="p">,</span><span class="s1">'new_top_area'</span><span class="p">)</span><span class="w">
        
        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">directiontogo</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">searchOrder</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="n">coords</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">possibleCoordinates</span><span class="p">[</span><span class="n">possibleCoordinates</span><span class="o">$</span><span class="n">direction</span><span class="o">==</span><span class="n">directiontogo</span><span class="p">,]</span><span class="w">
                </span><span class="n">print</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s1">'Scanning'</span><span class="p">,</span><span class="n">directiontogo</span><span class="p">,</span><span class="w"> </span><span class="s1">'for'</span><span class="p">,</span><span class="w"> </span><span class="n">searchTerm</span><span class="p">,</span><span class="s1">'...'</span><span class="p">))</span><span class="w">
                </span><span class="n">foundLocation</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">GetBestYelpLocation</span><span class="p">(</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">as.vector</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="m">2</span><span class="o">:</span><span class="m">5</span><span class="p">])),</span><span class="w"> </span><span class="n">searchTerm</span><span class="p">)</span><span class="w">
                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nf">is.null</span><span class="p">(</span><span class="n">foundLocation</span><span class="p">))</span><span class="w">
                        </span><span class="n">return</span><span class="w"> </span><span class="p">(</span><span class="n">foundLocation</span><span class="p">)</span><span class="w">
        </span><span class="p">}</span><span class="w">
        </span><span class="n">return</span><span class="w"> </span><span class="p">(</span><span class="kc">NULL</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>
<p><br /><br />
Let’s finally look at the main logic. Here we set a search term <code class="highlighter-rouge">florist</code>, and a bounded square size unit, <code class="highlighter-rouge">1</code> degree in this case. <code class="highlighter-rouge">madeIt</code> is the boolean flag that keeps the while loop going until we make it close to our final destination (or if we fail after 100 tries). <code class="highlighter-rouge">Sys.sleep(0.5)</code> will pause the code between each loop, this is critical so you don’t flood the Yelp server and get yourself banned.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">searchTerm</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s1">'florist'</span><span class="w">
</span><span class="n">squareSize</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c1"># setting the bounded area to a square 
</span><span class="w">
</span><span class="c1"># start trip info vectors - we need to remember where we've been!
</span><span class="n">currentLatitude</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">startingpoint</span><span class="o">$</span><span class="n">lat</span><span class="w">
</span><span class="n">currentLongitude</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">startingpoint</span><span class="o">$</span><span class="n">lon</span><span class="w">

</span><span class="c1"># let ggmap keep track of where we've been
</span><span class="n">objMap</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">MapIt</span><span class="p">(</span><span class="n">currentLatitude</span><span class="p">,</span><span class="w"> </span><span class="n">currentLongitude</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">objMap</span><span class="p">)</span><span class="w">

</span><span class="n">madeIt</span><span class="o">=</span><span class="kc">FALSE</span><span class="w">
</span><span class="n">safetyCount</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0</span><span class="w">
</span><span class="n">foundCount</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0</span><span class="w">
</span><span class="k">while</span><span class="p">(</span><span class="n">madeIt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">safetyCount</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">safetyCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="w">
        </span><span class="n">foundLocation</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">MakeAMove</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="n">currentLatitude</span><span class="p">,</span><span class="w">
                                   </span><span class="n">lon</span><span class="o">=</span><span class="n">currentLongitude</span><span class="p">,</span><span class="w">
                                   </span><span class="n">sizebox</span><span class="o">=</span><span class="n">squareSize</span><span class="p">,</span><span class="w">
                                   </span><span class="n">searchTerm</span><span class="o">=</span><span class="n">searchTerm</span><span class="p">,</span><span class="w">
                                   </span><span class="n">endingpoint</span><span class="o">$</span><span class="n">lat</span><span class="p">)</span><span class="w">
        
        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nf">is.null</span><span class="p">(</span><span class="n">foundLocation</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="n">print</span><span class="w"> </span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s1">'Our new'</span><span class="p">,</span><span class="n">searchTerm</span><span class="p">,</span><span class="w"> </span><span class="s1">'is'</span><span class="p">,</span><span class="w"> </span><span class="n">foundLocation</span><span class="o">$</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s1">'in'</span><span class="p">,</span><span class="w"> 
                             </span><span class="n">foundLocation</span><span class="o">$</span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="n">foundLocation</span><span class="o">$</span><span class="n">state</span><span class="p">,</span><span class="w">
                             </span><span class="s1">'with a'</span><span class="p">,</span><span class="w"> </span><span class="n">foundLocation</span><span class="o">$</span><span class="n">rating</span><span class="p">,</span><span class="w"> </span><span class="s1">'start rating'</span><span class="p">))</span><span class="w">
                </span><span class="n">currentLatitude</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">foundLocation</span><span class="o">$</span><span class="n">latitude</span><span class="w">
                </span><span class="n">currentLongitude</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">foundLocation</span><span class="o">$</span><span class="n">longitude</span><span class="w">
                
                </span><span class="c1"># reset temporary setting
</span><span class="w">                </span><span class="n">squareSize</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="w">
                
                </span><span class="c1"># let ggmap keep track of where we've been
</span><span class="w">                </span><span class="n">objMap</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">MapIt</span><span class="p">(</span><span class="n">currentLatitude</span><span class="p">,</span><span class="w"> </span><span class="n">currentLongitude</span><span class="p">,</span><span class="w"> </span><span class="n">squareSize</span><span class="m">+3</span><span class="p">,</span><span class="w"> </span><span class="n">objMap</span><span class="p">)</span><span class="w">
                
                </span><span class="c1"># let's keep track how our successes!
</span><span class="w">                </span><span class="n">foundCount</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">foundCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="w">
        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="c1"># increase squareSize
</span><span class="w">                </span><span class="n">print</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s2">"Can't find any"</span><span class="p">,</span><span class="w"> </span><span class="n">searchTerm</span><span class="p">,</span><span class="s2">", enlarging square search area to"</span><span class="p">,</span><span class="n">squareSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">))</span><span class="w">
                
                </span><span class="c1"># temporary settings to get us out of desert
</span><span class="w">                </span><span class="n">squareSize</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">squareSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="w">
        </span><span class="p">}</span><span class="w">  
        
        </span><span class="c1"># have we arrived at our end point
</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">currentLongitude</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">endingpoint</span><span class="o">$</span><span class="n">lon</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">squareSize</span><span class="p">))</span><span class="w"> 
                </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">currentLongitude</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">endingpoint</span><span class="o">$</span><span class="n">lon</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">squareSize</span><span class="p">)))</span><span class="w">
        </span><span class="p">{</span><span class="w">
                </span><span class="n">print</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s1">'We made it!! It took'</span><span class="p">,</span><span class="n">foundCount</span><span class="p">,</span><span class="s1">'hops...'</span><span class="p">))</span><span class="w">
                </span><span class="k">break</span><span class="w">
        </span><span class="p">}</span><span class="w">
        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">safetyCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">100</span><span class="p">)</span><span class="w"> 
        </span><span class="p">{</span><span class="w">
                </span><span class="n">print</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s1">'Giving up!! Failed after'</span><span class="p">,</span><span class="n">foundCount</span><span class="p">,</span><span class="s1">'hops'</span><span class="p">))</span><span class="w">
                </span><span class="k">break</span><span class="w">
        </span><span class="p">}</span><span class="w">
                  
        </span><span class="c1"># be considerate with your Yelp requests
</span><span class="w">        </span><span class="n">Sys.sleep</span><span class="p">(</span><span class="m">0.5</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>
<p><br /><br />
This is the output you will see when you run the code. It will log each point traveled and print the name of the florist. In case it cannot find one in either the upper or lower forward areas, the system will increase the square size by a degree (making it a 2x2 box instead of a 1x1 box) until it can find a florist. This is why in the final map below you will see gaps in deserted or mountainous zones.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="c1">## [1] "Scanning new_top_area for florist ..."
## [1]   40.46699 -118.28123   39.46699 -117.28123
## [1] "Scanning new_bottom_area for florist ..."
## [1]   39.46699 -118.28123   38.46699 -117.28123
## [1] "Can't find any florist , enlarging square search area to 2"
## [1] "Scanning new_top_area for florist ..."
## [1]   41.46699 -117.78123   39.46699 -115.78123
## [1] "Our new florist is Second Street Seasonals in Winnemucca NV with a 4 start rating"
</span><span class="w">
</span><span class="n">...</span><span class="w">

</span><span class="c1">## [1] "Our new florist is Achin' Back Garden Center in Pottstown PA with a 4.5 start rating"
## [1] "Scanning new_top_area for florist ..."
## [1]  41.24341 -75.06065  40.24341 -74.06065
## [1] "Our new florist is Monday Morning Flower and Balloon Co. in Princeton NJ with a 4.5 start rating"
## [1] "We made it!! It took 41 hops..."
</span></code></pre>
</div>
<p><br /><br />
<img src="img/crosscountryplot.png" alt="plot of chunk crosscountryplot" />
<br /><br /></p>

<p><strong>Conclusion</strong></p>

<p>So, I didn’t quite deliver on my promise of being within 60 miles of a florist at all times, it may or may not be possible (and we certainly won’t find out with the state of my current code). Yet, we managed to be within those parameters during most of the journey. You can try with with different terms, different locations, even upgrade the algorithm to do cooler things - just don’t abuse the API as it may end the party for all of us.</p>

<p>A special thanks to <b>Nathan Yau</b>; this walkthrough was loosely based but strongly inspired by his <a href="http://flowingdata.com/2013/08/27/in-search-of-food-deserts/" target="_blank">In search of food deserts</a>.</p>

<p><br /><br />            <br />
<a id="sourcecode">Full source code (<a href="https://github.com/amunategui/cross-country-trip-with-yelp" target="_blank">also on GitHub</a>)</a>:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="w">
</span><span class="c1">######################## functions ################################
</span><span class="n">MapIt</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">latitude</span><span class="p">,</span><span class="w"> </span><span class="n">longitude</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">objggmap</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">objdf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="s1">'latitude'</span><span class="o">=</span><span class="n">latitude</span><span class="p">,</span><span class="w">
                            </span><span class="s1">'longitude'</span><span class="o">=</span><span class="n">longitude</span><span class="p">,</span><span class="w">
                            </span><span class="s1">'tsize'</span><span class="o">=</span><span class="n">size</span><span class="p">)</span><span class="w">
        
        </span><span class="c1"># add new point to ggmap
</span><span class="w">        </span><span class="n">require</span><span class="p">(</span><span class="s2">"ggplot2"</span><span class="p">)</span><span class="w">
        </span><span class="n">require</span><span class="p">(</span><span class="s2">"ggmap"</span><span class="p">)</span><span class="w">
        </span><span class="n">objggmap</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">objggmap</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">geom_point</span><span class="p">(</span><span class="w">
                </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">longitude</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">latitude</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="n">tsize</span><span class="p">,</span><span class="w"> 
                    </span><span class="n">show_guide</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),</span><span class="w"> 
                </span><span class="n">data</span><span class="o">=</span><span class="n">objdf</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="m">.8</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">)</span><span class="w">  
        </span><span class="n">return</span><span class="w"> </span><span class="p">(</span><span class="n">objggmap</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c1"># yelp rest API call
</span><span class="n">GetBestYelpLocation</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">boundedcoordinates</span><span class="p">,</span><span class="w"> </span><span class="n">term</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">limit</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="w">
        </span><span class="n">print</span><span class="p">(</span><span class="n">boundedcoordinates</span><span class="p">)</span><span class="w">
        </span><span class="c1"># Pick first florist in San Francisco, CA
</span><span class="w">        </span><span class="c1">#YelpUrl &lt;- paste0("http://api.yelp.com/v2/search/?limit=",limit,
</span><span class="w">        </span><span class="c1">#                  "&amp;location=San%20Francisco%20CA&amp;term=florist")
</span><span class="w">        </span><span class="c1"># or 10 bars by geo-coordinates
</span><span class="w">        </span><span class="c1">#YelpUrl &lt;- paste0("http://api.yelp.com/v2/search/?limit=",
</span><span class="w">        </span><span class="c1">#       limit,"&amp;ll=",latitude,",",longitude,"&amp;term=florist")
</span><span class="w">        </span><span class="c1"># or by bounded geo-spatial coordinates
</span><span class="w">        </span><span class="n">YelpUrl</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">paste0</span><span class="p">(</span><span class="s2">"http://api.yelp.com/v2/search/?limit=20&amp;bounds="</span><span class="p">,</span><span class="w">
                          </span><span class="n">boundedcoordinates</span><span class="p">[</span><span class="m">1</span><span class="p">],</span><span class="s2">","</span><span class="p">,</span><span class="n">boundedcoordinates</span><span class="p">[</span><span class="m">2</span><span class="p">],</span><span class="w">
                          </span><span class="s2">"|"</span><span class="p">,</span><span class="n">boundedcoordinates</span><span class="p">[</span><span class="m">3</span><span class="p">],</span><span class="s2">","</span><span class="p">,</span><span class="n">boundedcoordinates</span><span class="p">[</span><span class="m">4</span><span class="p">],</span><span class="s2">"&amp;term="</span><span class="p">,</span><span class="n">term</span><span class="p">)</span><span class="w">
         
        </span><span class="n">locationdata</span><span class="o">=</span><span class="n">GET</span><span class="p">(</span><span class="n">YelpUrl</span><span class="p">,</span><span class="w"> </span><span class="n">mySignature</span><span class="p">)</span><span class="w">
        </span><span class="n">listMembersContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">content</span><span class="p">(</span><span class="n">locationdata</span><span class="p">)</span><span class="w">
        </span><span class="n">listMembers</span><span class="o">=</span><span class="n">jsonlite</span><span class="o">::</span><span class="n">fromJSON</span><span class="p">(</span><span class="n">toJSON</span><span class="p">(</span><span class="n">listMembersContent</span><span class="p">))</span><span class="w">
        
        </span><span class="n">yelpResults</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tryCatch</span><span class="p">({</span><span class="w">
                </span><span class="n">data.frame</span><span class="p">(</span><span class="n">listMembers</span><span class="p">)</span><span class="w">
        </span><span class="p">},</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> 
                </span><span class="kc">NULL</span><span class="w">
        </span><span class="p">})</span><span class="w">
        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nf">is.null</span><span class="p">(</span><span class="n">yelpResults</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="n">set1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="s2">"name"</span><span class="o">=</span><span class="n">yelpResults</span><span class="o">$</span><span class="n">businesses.name</span><span class="p">,</span><span class="s1">'city'</span><span class="o">=</span><span class="n">yelpResults</span><span class="o">$</span><span class="n">businesses.location</span><span class="o">$</span><span class="n">city</span><span class="p">,</span><span class="w">
                                   </span><span class="s1">'rating'</span><span class="o">=</span><span class="n">yelpResults</span><span class="o">$</span><span class="n">businesses.rating</span><span class="p">,</span><span class="w"> 
                                   </span><span class="s1">'latitude'</span><span class="o">=</span><span class="n">yelpResults</span><span class="o">$</span><span class="n">businesses.location</span><span class="o">$</span><span class="n">coordinate</span><span class="o">$</span><span class="n">latitude</span><span class="p">,</span><span class="w">
                                   </span><span class="s1">'longitude'</span><span class="o">=</span><span class="n">yelpResults</span><span class="o">$</span><span class="n">businesses.location</span><span class="o">$</span><span class="n">coordinate</span><span class="o">$</span><span class="n">longitude</span><span class="p">,</span><span class="w">
                                   </span><span class="s1">'state'</span><span class="o">=</span><span class="n">yelpResults</span><span class="o">$</span><span class="n">businesses.location</span><span class="o">$</span><span class="n">state_code</span><span class="p">)</span><span class="w">
                 
                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">ind</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">seq</span><span class="p">(</span><span class="m">1</span><span class="o">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">set1</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w">
                        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">set1</span><span class="o">$</span><span class="n">latitude</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">boundedcoordinates</span><span class="p">[</span><span class="m">1</span><span class="p">])</span><span class="w"> </span><span class="o">&amp;</span><span class="w">
                                </span><span class="p">(</span><span class="n">set1</span><span class="o">$</span><span class="n">latitude</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">boundedcoordinates</span><span class="p">[</span><span class="m">3</span><span class="p">])</span><span class="w"> </span><span class="o">&amp;</span><span class="w">
                                </span><span class="p">(</span><span class="n">set1</span><span class="o">$</span><span class="n">longitude</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">boundedcoordinates</span><span class="p">[</span><span class="m">2</span><span class="p">])</span><span class="w"> </span><span class="o">&amp;</span><span class="w">
                                </span><span class="p">(</span><span class="n">set1</span><span class="o">$</span><span class="n">longitude</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">boundedcoordinates</span><span class="p">[</span><span class="m">4</span><span class="p">]))</span><span class="w">
                                </span><span class="nf">return</span><span class="p">(</span><span class="n">set1</span><span class="p">[</span><span class="n">ind</span><span class="p">,])</span><span class="w">
                </span><span class="p">}</span><span class="w">
        </span><span class="p">}</span><span class="w">
        </span><span class="nf">return</span><span class="p">(</span><span class="kc">NULL</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
 
</span><span class="c1"># Movement controls
</span><span class="n">GetPossibleCoordinates</span><span class="o">&lt;-</span><span class="k">function</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="n">lon</span><span class="p">,</span><span class="w"> </span><span class="n">area</span><span class="o">=</span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="c1"># this is hard to keep track but each location's next move
</span><span class="w">        </span><span class="c1"># equates attempting to move forward one square, the same area
</span><span class="w">        </span><span class="c1"># as the previous one but half-way above and half-way below the
</span><span class="w">        </span><span class="c1"># previous one.
</span><span class="w">        </span><span class="n">halfarea</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">area</span><span class="o">/</span><span class="m">2</span><span class="w">
    
        </span><span class="c1"># new forward top square area
</span><span class="w">        </span><span class="n">topArea_upperleft_latitude</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lat</span><span class="o">+</span><span class="n">area</span><span class="w">
        </span><span class="n">topArea_upperleft_longitude</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lon</span><span class="o">+</span><span class="n">halfarea</span><span class="w">
        
        </span><span class="n">topArea_lowerright_latitude</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lat</span><span class="w">
        </span><span class="n">topArea_lowerright_longitude</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lon</span><span class="o">+</span><span class="p">(</span><span class="n">halfarea</span><span class="o">+</span><span class="n">area</span><span class="p">)</span><span class="w">
        
        </span><span class="c1"># new forward bottom square area
</span><span class="w">        </span><span class="n">bottomArea_upperleft_latitude</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lat</span><span class="w">
        </span><span class="n">bottomArea_upperleft_longitude</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lon</span><span class="o">+</span><span class="n">halfarea</span><span class="w">
        
        </span><span class="n">bottomArea_lowerright_latitude</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lat</span><span class="o">-</span><span class="n">area</span><span class="w">
        </span><span class="n">bottomArea_lowerright_longitude</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lon</span><span class="o">+</span><span class="p">(</span><span class="n">halfarea</span><span class="o">+</span><span class="n">area</span><span class="p">)</span><span class="w">
          
        
        </span><span class="n">rownames</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'new_top_area'</span><span class="p">,</span><span class="s1">'new_bottom_area'</span><span class="p">)</span><span class="w">
        </span><span class="n">latitude_point1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">topArea_upperleft_latitude</span><span class="p">,</span><span class="w"> </span><span class="n">bottomArea_upperleft_latitude</span><span class="p">)</span><span class="w">
        </span><span class="n">longitude_point1</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">topArea_upperleft_longitude</span><span class="p">,</span><span class="w"> </span><span class="n">bottomArea_upperleft_longitude</span><span class="p">)</span><span class="w">
        </span><span class="n">latitude_point2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">topArea_lowerright_latitude</span><span class="p">,</span><span class="w"> </span><span class="n">bottomArea_lowerright_latitude</span><span class="p">)</span><span class="w">
        </span><span class="n">longitude_point2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">topArea_lowerright_longitude</span><span class="p">,</span><span class="w"> </span><span class="n">bottomArea_lowerright_longitude</span><span class="p">)</span><span class="w">
        
        </span><span class="n">return</span><span class="w"> </span><span class="p">(</span><span class="n">data.frame</span><span class="p">(</span><span class="s1">'direction'</span><span class="o">=</span><span class="n">rownames</span><span class="p">,</span><span class="w">
                </span><span class="s1">'latitude_point1'</span><span class="o">=</span><span class="n">latitude_point1</span><span class="p">,</span><span class="w">
                           </span><span class="s1">'longitude_point1'</span><span class="o">=</span><span class="n">longitude_point1</span><span class="p">,</span><span class="w">
                           </span><span class="s1">'latitude_point2'</span><span class="o">=</span><span class="n">latitude_point2</span><span class="p">,</span><span class="w">
                           </span><span class="s1">'longitude_point2'</span><span class="o">=</span><span class="n">longitude_point2</span><span class="p">))</span><span class="w">
         
</span><span class="p">}</span><span class="w">
 
</span><span class="n">MakeAMove</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span><span class="n">lon</span><span class="p">,</span><span class="n">sizebox</span><span class="p">,</span><span class="w"> </span><span class="n">searchTerm</span><span class="p">,</span><span class="w"> </span><span class="n">lat_endPoint</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">possibleCoordinates</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">GetPossibleCoordinates</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span><span class="n">lon</span><span class="p">,</span><span class="n">sizebox</span><span class="p">)</span><span class="w">
        
        </span><span class="c1"># go up or down first depending on latitude of end point
</span><span class="w">        </span><span class="n">searchOrder</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'new_top_area'</span><span class="p">,</span><span class="s1">'new_bottom_area'</span><span class="p">)</span><span class="w">
        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lat</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">lat_endPoint</span><span class="p">)</span><span class="w">
                </span><span class="n">searchOrder</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s1">'new_bottom_area'</span><span class="p">,</span><span class="s1">'new_top_area'</span><span class="p">)</span><span class="w">
        
        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">directiontogo</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">searchOrder</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="n">coords</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">possibleCoordinates</span><span class="p">[</span><span class="n">possibleCoordinates</span><span class="o">$</span><span class="n">direction</span><span class="o">==</span><span class="n">directiontogo</span><span class="p">,]</span><span class="w">
                </span><span class="n">print</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s1">'Scanning'</span><span class="p">,</span><span class="n">directiontogo</span><span class="p">,</span><span class="w"> </span><span class="s1">'for'</span><span class="p">,</span><span class="w"> </span><span class="n">searchTerm</span><span class="p">,</span><span class="s1">'...'</span><span class="p">))</span><span class="w">
                </span><span class="n">foundLocation</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">GetBestYelpLocation</span><span class="p">(</span><span class="nf">as.numeric</span><span class="p">(</span><span class="n">as.vector</span><span class="p">(</span><span class="n">coords</span><span class="p">[</span><span class="m">2</span><span class="o">:</span><span class="m">5</span><span class="p">])),</span><span class="w"> </span><span class="n">searchTerm</span><span class="p">)</span><span class="w">
                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nf">is.null</span><span class="p">(</span><span class="n">foundLocation</span><span class="p">))</span><span class="w">
                        </span><span class="n">return</span><span class="w"> </span><span class="p">(</span><span class="n">foundLocation</span><span class="p">)</span><span class="w">
        </span><span class="p">}</span><span class="w">
        </span><span class="n">return</span><span class="w"> </span><span class="p">(</span><span class="kc">NULL</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">

</span><span class="c1">############################## YELP SETUP ###############################
# yelp credentials
</span><span class="n">consumerKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"xxxxx"</span><span class="w">
</span><span class="n">consumerSecret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"xxxxx"</span><span class="w">
</span><span class="n">token</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"xxxxx"</span><span class="w">
</span><span class="n">tokenSecret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"xxxxx"</span><span class="w">

</span><span class="n">require</span><span class="p">(</span><span class="n">httr</span><span class="p">)</span><span class="w">
</span><span class="n">require</span><span class="p">(</span><span class="n">jsonlite</span><span class="p">)</span><span class="w">

</span><span class="c1"># authorization
</span><span class="n">myapp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">oauth_app</span><span class="p">(</span><span class="s2">"Yelp"</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="o">=</span><span class="n">consumerKey</span><span class="p">,</span><span class="w"> </span><span class="n">secret</span><span class="o">=</span><span class="n">consumerSecret</span><span class="p">)</span><span class="w">
</span><span class="n">mySignature</span><span class="o">=</span><span class="n">sign_oauth1.0</span><span class="p">(</span><span class="n">myapp</span><span class="p">,</span><span class="w"> </span><span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span><span class="n">token_secret</span><span class="o">=</span><span class="n">tokenSecret</span><span class="p">)</span><span class="w">

</span><span class="c1">############################### Manual Code ###############################
</span><span class="n">require</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span><span class="w">
</span><span class="n">require</span><span class="p">(</span><span class="n">ggmap</span><span class="p">)</span><span class="w">

</span><span class="c1"># Get our starting and ending points
# Fisherman's Wharf, San Francisco, CA 94109
</span><span class="n">startingpoint</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">geocode</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"Fishersman's Wharf, San Francisco, CA"</span><span class="p">))</span><span class="w">
</span><span class="c1"># Chelsea Piers 10011
</span><span class="n">endingpoint</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">geocode</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="s2">"Chelsea Piers, NY"</span><span class="p">))</span><span class="w">

</span><span class="c1"># ggplots accepts a data frame, let's make with with start and end points
</span><span class="n">latitudes</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">startingpoint</span><span class="o">$</span><span class="n">lat</span><span class="p">,</span><span class="w"> </span><span class="n">endingpoint</span><span class="o">$</span><span class="n">lat</span><span class="p">)</span><span class="w">
</span><span class="n">longitudes</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">startingpoint</span><span class="o">$</span><span class="n">lon</span><span class="p">,</span><span class="w"> </span><span class="n">endingpoint</span><span class="o">$</span><span class="n">lon</span><span class="p">)</span><span class="w">
</span><span class="c1"># importance holds the size and color (we'll leave it up to ggplot to choose)
</span><span class="n">objdf</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="s1">'latitude'</span><span class="o">=</span><span class="n">latitudes</span><span class="p">,</span><span class="w">
                    </span><span class="s1">'longitude'</span><span class="o">=</span><span class="n">longitudes</span><span class="p">,</span><span class="w">
                    </span><span class="s1">'importance'</span><span class="o">=</span><span class="nf">c</span><span class="p">(</span><span class="m">10</span><span class="p">,</span><span class="m">10</span><span class="p">))</span><span class="w">

</span><span class="c1"># sample ggplot/ggmap with start and end locations
# get a Google map
</span><span class="n">require</span><span class="p">(</span><span class="n">ggmap</span><span class="p">)</span><span class="w">
</span><span class="n">map</span><span class="o">&lt;-</span><span class="n">get_map</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="s1">'united states'</span><span class="p">,</span><span class="w"> </span><span class="n">zoom</span><span class="o">=</span><span class="m">4</span><span class="p">,</span><span class="w"> </span><span class="n">maptype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"terrain"</span><span class="p">,</span><span class="w">
             </span><span class="n">source</span><span class="o">=</span><span class="s1">'google'</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">'color'</span><span class="p">)</span><span class="w">

</span><span class="c1"># plot it with ggplot2
</span><span class="n">require</span><span class="p">(</span><span class="s2">"ggplot2"</span><span class="p">)</span><span class="w">
</span><span class="n">objMap</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">NULL</span><span class="w">
</span><span class="n">objMap</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ggmap</span><span class="p">(</span><span class="n">map</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">geom_point</span><span class="p">(</span><span class="w">
        </span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">longitude</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="n">latitude</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="o">=</span><span class="n">importance</span><span class="p">,</span><span class="w"> 
            </span><span class="n">show_guide</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">importance</span><span class="p">),</span><span class="w"> 
        </span><span class="n">data</span><span class="o">=</span><span class="n">objdf</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="o">=</span><span class="m">.8</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">T</span><span class="p">)</span><span class="w">  
 

</span><span class="c1">################################### Logic #####################################
</span><span class="w">
</span><span class="n">searchTerm</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s1">'florist'</span><span class="w">
</span><span class="n">squareSize</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c1"># setting the bounded area to a square 
</span><span class="w">
</span><span class="c1"># start trip info vectors - we need to remember where we've been!
</span><span class="n">currentLatitude</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">startingpoint</span><span class="o">$</span><span class="n">lat</span><span class="w">
</span><span class="n">currentLongitude</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">startingpoint</span><span class="o">$</span><span class="n">lon</span><span class="w">

</span><span class="c1"># let ggmap keep track of where we've been
</span><span class="n">objMap</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">MapIt</span><span class="p">(</span><span class="n">currentLatitude</span><span class="p">,</span><span class="w"> </span><span class="n">currentLongitude</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">objMap</span><span class="p">)</span><span class="w">

</span><span class="n">madeIt</span><span class="o">=</span><span class="kc">FALSE</span><span class="w">
</span><span class="n">safetyCount</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0</span><span class="w">
</span><span class="n">foundCount</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0</span><span class="w">
</span><span class="k">while</span><span class="p">(</span><span class="n">madeIt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">FALSE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">safetyCount</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">safetyCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="w">
        </span><span class="n">foundLocation</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">MakeAMove</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="n">currentLatitude</span><span class="p">,</span><span class="w">
                                   </span><span class="n">lon</span><span class="o">=</span><span class="n">currentLongitude</span><span class="p">,</span><span class="w">
                                   </span><span class="n">sizebox</span><span class="o">=</span><span class="n">squareSize</span><span class="p">,</span><span class="w">
                                   </span><span class="n">searchTerm</span><span class="o">=</span><span class="n">searchTerm</span><span class="p">,</span><span class="w">
                                   </span><span class="n">endingpoint</span><span class="o">$</span><span class="n">lat</span><span class="p">)</span><span class="w">
        
        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nf">is.null</span><span class="p">(</span><span class="n">foundLocation</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="n">print</span><span class="w"> </span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s1">'Our new'</span><span class="p">,</span><span class="n">searchTerm</span><span class="p">,</span><span class="w"> </span><span class="s1">'is'</span><span class="p">,</span><span class="w"> </span><span class="n">foundLocation</span><span class="o">$</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="s1">'in'</span><span class="p">,</span><span class="w"> 
                             </span><span class="n">foundLocation</span><span class="o">$</span><span class="n">city</span><span class="p">,</span><span class="w"> </span><span class="n">foundLocation</span><span class="o">$</span><span class="n">state</span><span class="p">,</span><span class="w">
                             </span><span class="s1">'with a'</span><span class="p">,</span><span class="w"> </span><span class="n">foundLocation</span><span class="o">$</span><span class="n">rating</span><span class="p">,</span><span class="w"> </span><span class="s1">'start rating'</span><span class="p">))</span><span class="w">
                </span><span class="n">currentLatitude</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">foundLocation</span><span class="o">$</span><span class="n">latitude</span><span class="w">
                </span><span class="n">currentLongitude</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">foundLocation</span><span class="o">$</span><span class="n">longitude</span><span class="w">
                
                </span><span class="c1"># reset temporary setting
</span><span class="w">                </span><span class="n">squareSize</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="w">
                
                </span><span class="c1"># let ggmap keep track of where we've been
</span><span class="w">                </span><span class="n">objMap</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">MapIt</span><span class="p">(</span><span class="n">currentLatitude</span><span class="p">,</span><span class="w"> </span><span class="n">currentLongitude</span><span class="p">,</span><span class="w"> </span><span class="n">squareSize</span><span class="m">+3</span><span class="p">,</span><span class="w"> </span><span class="n">objMap</span><span class="p">)</span><span class="w">
                
                </span><span class="c1"># let's keep track how our successes!
</span><span class="w">                </span><span class="n">foundCount</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">foundCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="w">
        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="c1"># increase squareSize
</span><span class="w">                </span><span class="n">print</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s2">"Can't find any"</span><span class="p">,</span><span class="w"> </span><span class="n">searchTerm</span><span class="p">,</span><span class="s2">", enlarging square search area to"</span><span class="p">,</span><span class="n">squareSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">))</span><span class="w">
                
                </span><span class="c1"># temporary settings to get us out of desert
</span><span class="w">                </span><span class="n">squareSize</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">squareSize</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="w">
        </span><span class="p">}</span><span class="w">  
        
        </span><span class="c1"># have we arrived at our end point
</span><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">currentLongitude</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="n">endingpoint</span><span class="o">$</span><span class="n">lon</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">squareSize</span><span class="p">))</span><span class="w"> 
                </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">currentLongitude</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">endingpoint</span><span class="o">$</span><span class="n">lon</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">squareSize</span><span class="p">)))</span><span class="w">
        </span><span class="p">{</span><span class="w">
                </span><span class="n">print</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s1">'We made it!! It took'</span><span class="p">,</span><span class="n">foundCount</span><span class="p">,</span><span class="s1">'hops...'</span><span class="p">))</span><span class="w">
                </span><span class="k">break</span><span class="w">
        </span><span class="p">}</span><span class="w">
        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">safetyCount</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">100</span><span class="p">)</span><span class="w"> 
        </span><span class="p">{</span><span class="w">
                </span><span class="n">print</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s1">'Giving up!! Failed after'</span><span class="p">,</span><span class="n">foundCount</span><span class="p">,</span><span class="s1">'hops'</span><span class="p">))</span><span class="w">
                </span><span class="k">break</span><span class="w">
        </span><span class="p">}</span><span class="w">
                  
        </span><span class="c1"># be considerate with your Yelp requests
</span><span class="w">        </span><span class="n">Sys.sleep</span><span class="p">(</span><span class="m">0.5</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
 
</span><span class="n">objMap</span><span class="w">

    


</span></code></pre>
</div>
		
</div>
    

		</div>		 
	 </div>   
 	
</main>


{% include footer.html %}
  </body>
</html>
