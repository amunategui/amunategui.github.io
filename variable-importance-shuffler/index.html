---
---
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="Machine Learning, R Programming, Statistics, Artificial Intelligence">
    <meta name="author" content="Manuel Amunategui">
    <link rel="icon" href="favicon.ico">

    <title>Data Exploration & Machine Learning, Hands-on</title>

    <!-- Bootstrap core CSS -->
 
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/css/bootstrap.min.css" integrity="sha384-9gVQ4dYFwwWSjIDZnLEWnxCjeSWFphJiwGPXr1jddIhOegiu1FwO5qRGvFXOdJZ4" crossorigin="anonymous">
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- Custom styles for this template -->
    <link href="https://getbootstrap.com/docs/4.1/examples/album/album.css" rel="stylesheet">
  </head>

     <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-55202104-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-55202104-1');
  </script>

  

<body>

<main role="main">

{% include header.html %}
  

<div class="container">
  <div class="blog-header">
    <h1 class="blog-title">Find Variable Importance for any Model - Prediction Shuffling with R</h1>
    <p class="lead blog-description">Practical walkthroughs on machine learning, data exploration and finding insight.</p>
  </div>
   


    <p><strong>Resources</strong></p>
<ul>
<li type="square"><a href="https://www.youtube.com/watch?v=tD8HZuWqIQw&amp;list=UUq4pm1i_VZqxKVVOz5qRBIA&amp;index=1" target="_blank">YouTube Companion Video</a></li>
<li type="square"><a href="#sourcecode">Full Source Code</a></li>
</ul>
<p><br />
<strong>Packages Used in this Walkthrough</strong></p>

<ul>
        <li type="square"><a href="http://cran.r-project.org/web/packages/caret/index.html" target="_blank">{caret}</a> - Classification and Regression Training</li>
        <li type="square"><a href="http://cran.r-project.org/web/packages/mRMRe/index.html" target="_blank">{mRMRe}</a> - R package for parallelized mRMR ensemble feature selection</li>
</ul>

<p><br /><br />
My colleague showed me a nifty concept to easily calculate variable importance for any model. He did not invent it, actually many forms of it abound in the literature and on the Internet. <a href="http://www.plottingsuccess.com/3-predictive-model-accuracy-tests-0114/" target="_blank">John Elder is one of the authors</a>.</p>

<p><img src="img/shuffler.png" alt="plot of chunk variable-importance-shuffler" /></p>

<p>The idea is so simple, its brilliant; you model once, predict once to get a benchmark score, and finally predict hundreds of times for each variable in the model while randomizing that variable. If the variable being randomized hurts the model’s benchmark score, then its an important variable. If, on the other hand, nothing changes, or it beats the benchmark, then its a useless variable. By running this hundreds of times for each variable, you can paint a clear picture of what variable is affecting the model and to what degree. The beauty of this approach is that it is model agnostic as everything happens after the modeling phase.</p>

<p><strong>Let’s code!</strong></p>

<p>We’ll use the good old Titanic dataset from the University of Colorado Denver that I’ve used in many of my walkthroughs. This is a classic data set often seen in online courses and walkthroughs. The outcome is passenger survivorship (i.e. can you predict who will survive based on various features). We drop the passenger names as they are all unique but keep the passenger titles. We also impute the missing ‘Age’ variables with the mean and <a href="http://amunategui.github.io/dummyVar-Walkthrough/" target="_blank">binarize all non-numerical data</a>:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="c1"># using dataset from the UCI Machine Learning Repository (http://archive.ics.uci.edu/ml/)
</span><span class="n">titanicDF</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="s1">'http://math.ucdenver.edu/RTutorial/titanic.txt'</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">'\t'</span><span class="p">)</span><span class="w">

</span><span class="c1"># creating new title feature
</span><span class="n">titanicDF</span><span class="o">$</span><span class="n">Title</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">grepl</span><span class="p">(</span><span class="s1">'Mr '</span><span class="p">,</span><span class="n">titanicDF</span><span class="o">$</span><span class="n">Name</span><span class="p">),</span><span class="s1">'Mr'</span><span class="p">,</span><span class="n">ifelse</span><span class="p">(</span><span class="n">grepl</span><span class="p">(</span><span class="s1">'Mrs '</span><span class="p">,</span><span class="n">titanicDF</span><span class="o">$</span><span class="n">Name</span><span class="p">),</span><span class="s1">'Mrs'</span><span class="p">,</span><span class="n">ifelse</span><span class="p">(</span><span class="n">grepl</span><span class="p">(</span><span class="s1">'Miss'</span><span class="p">,</span><span class="n">titanicDF</span><span class="o">$</span><span class="n">Name</span><span class="p">),</span><span class="s1">'Miss'</span><span class="p">,</span><span class="s1">'Nothing'</span><span class="p">)))</span><span class="w">
</span><span class="n">titanicDF</span><span class="o">$</span><span class="n">Title</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.factor</span><span class="p">(</span><span class="n">titanicDF</span><span class="o">$</span><span class="n">Title</span><span class="p">)</span><span class="w">
 
</span><span class="c1"># impute age to remove NAs
</span><span class="n">titanicDF</span><span class="o">$</span><span class="n">Age</span><span class="p">[</span><span class="nf">is.na</span><span class="p">(</span><span class="n">titanicDF</span><span class="o">$</span><span class="n">Age</span><span class="p">)]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">median</span><span class="p">(</span><span class="n">titanicDF</span><span class="o">$</span><span class="n">Age</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="o">=</span><span class="nb">T</span><span class="p">)</span><span class="w">
 
</span><span class="c1"># reorder data set so target is last column
</span><span class="n">titanicDF</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">titanicDF</span><span class="p">[</span><span class="nf">c</span><span class="p">(</span><span class="s1">'PClass'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Age'</span><span class="p">,</span><span class="w">    </span><span class="s1">'Sex'</span><span class="p">,</span><span class="w">   </span><span class="s1">'Title'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Survived'</span><span class="p">)]</span><span class="w">
 
</span><span class="c1"># binarize all factors
</span><span class="n">library</span><span class="p">(</span><span class="n">caret</span><span class="p">)</span><span class="w">
</span><span class="n">titanicDummy</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">dummyVars</span><span class="p">(</span><span class="s2">"~."</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">titanicDF</span><span class="p">,</span><span class="w"> </span><span class="n">fullRank</span><span class="o">=</span><span class="nb">F</span><span class="p">)</span><span class="w">
</span><span class="n">titanicDF</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.data.frame</span><span class="p">(</span><span class="n">predict</span><span class="p">(</span><span class="n">titanicDummy</span><span class="p">,</span><span class="n">titanicDF</span><span class="p">))</span><span class="w">
</span></code></pre>
</div>

<p>Let’s take a peek at our data:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">str</span><span class="p">(</span><span class="n">titanicDF</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## 'data.frame':	1313 obs. of  11 variables:
##  $ PClass.1st   : num  1 1 1 1 1 1 1 1 1 1 ...
##  $ PClass.2nd   : num  0 0 0 0 0 0 0 0 0 0 ...
##  $ PClass.3rd   : num  0 0 0 0 0 0 0 0 0 0 ...
##  $ Age          : num  29 2 30 25 0.92 47 63 39 58 71 ...
##  $ Sex.female   : num  1 1 0 1 0 0 1 0 1 0 ...
##  $ Sex.male     : num  0 0 1 0 1 1 0 1 0 1 ...
##  $ Title.Miss   : num  1 1 0 0 0 0 1 0 0 0 ...
##  $ Title.Mr     : num  0 0 1 0 0 1 0 1 0 1 ...
##  $ Title.Mrs    : num  0 0 0 1 0 0 0 0 1 0 ...
##  $ Title.Nothing: num  0 0 0 0 1 0 0 0 0 0 ...
##  $ Survived     : num  1 0 0 0 1 1 1 0 1 0 ...
</code></pre>
</div>
<p><br /><br />
We’ll start by running a simple Gradient Boosted Machine (GBM) model on the data in order to get our benchmark area-under-the-curve (AUC) score. First we need to split the data into a training and testing portion, generalize our outcome and predictor names, and <a href="http://amunategui.github.io/binary-outcome-modeling/" target="_blank">fix the outcome variable for classification</a>:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="c1"># split data set into train and test portion
</span><span class="n">set.seed</span><span class="p">(</span><span class="m">1234</span><span class="p">)</span><span class="w">
</span><span class="n">splitIndex</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sample</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">titanicDF</span><span class="p">),</span><span class="w"> </span><span class="nf">floor</span><span class="p">(</span><span class="m">0.5</span><span class="o">*</span><span class="n">nrow</span><span class="p">(</span><span class="n">titanicDF</span><span class="p">)))</span><span class="w">
</span><span class="n">trainDF</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">titanicDF</span><span class="p">[</span><span class="w"> </span><span class="n">splitIndex</span><span class="p">,]</span><span class="w">
</span><span class="n">testDF</span><span class="w">  </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">titanicDF</span><span class="p">[</span><span class="o">-</span><span class="n">splitIndex</span><span class="p">,]</span><span class="w">
 
</span><span class="n">outcomeName</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s1">'Survived'</span><span class="w">
</span><span class="n">predictorNames</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">setdiff</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">trainDF</span><span class="p">),</span><span class="n">outcomeName</span><span class="p">)</span><span class="w">
 
</span><span class="c1"># transform outcome variable to text as this is required in caret for classification 
</span><span class="n">trainDF</span><span class="p">[,</span><span class="n">outcomeName</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">trainDF</span><span class="p">[,</span><span class="n">outcomeName</span><span class="p">]</span><span class="o">==</span><span class="m">1</span><span class="p">,</span><span class="s1">'yes'</span><span class="p">,</span><span class="s1">'nope'</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>
<p><br /><br />
Now we’re ready to run a simple GBM model:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="c1"># create caret trainControl object to control the number of cross-validations performed
</span><span class="n">objControl</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">trainControl</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">'cv'</span><span class="p">,</span><span class="w"> </span><span class="n">number</span><span class="o">=</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">returnResamp</span><span class="o">=</span><span class="s1">'none'</span><span class="p">,</span><span class="w"> </span><span class="n">summaryFunction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">twoClassSummary</span><span class="p">,</span><span class="w"> </span><span class="n">classProbs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
 
</span><span class="n">objGBM</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">train</span><span class="p">(</span><span class="n">trainDF</span><span class="p">[,</span><span class="n">predictorNames</span><span class="p">],</span><span class="w">  </span><span class="n">as.factor</span><span class="p">(</span><span class="n">trainDF</span><span class="p">[,</span><span class="n">outcomeName</span><span class="p">]),</span><span class="w">
                </span><span class="n">method</span><span class="o">=</span><span class="s1">'gbm'</span><span class="p">,</span><span class="w">
                </span><span class="n">trControl</span><span class="o">=</span><span class="n">objControl</span><span class="p">,</span><span class="w">
                </span><span class="n">metric</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ROC"</span><span class="p">,</span><span class="w">
                </span><span class="n">tuneGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expand.grid</span><span class="p">(</span><span class="n">n.trees</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="n">interaction.depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="n">shrinkage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">)</span><span class="w">
</span><span class="p">)</span><span class="w">

</span><span class="n">predictions</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">object</span><span class="o">=</span><span class="n">objGBM</span><span class="p">,</span><span class="w"> </span><span class="n">testDF</span><span class="p">[,</span><span class="n">predictorNames</span><span class="p">],</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s1">'prob'</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>
<p><br /><br />
Here I introduce a very fast AUC approximation function found on <a href="http://stackoverflow.com/questions/4903092/calculate-auc-in-r" target="_blank">stackoverflow</a> that will allow us to calculate the AUC thousands of times with minimal processing:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">GetROC_AUC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span><span class="w"> </span><span class="n">true_Y</span><span class="p">){</span><span class="w">
        </span><span class="c1"># AUC approximation
</span><span class="w">        </span><span class="c1"># http://stackoverflow.com/questions/4903092/calculate-auc-in-r
</span><span class="w">        </span><span class="c1"># ty AGS
</span><span class="w">        </span><span class="n">probsSort</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sort</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span><span class="w"> </span><span class="n">decreasing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">index.return</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
        </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unlist</span><span class="p">(</span><span class="n">probsSort</span><span class="o">$</span><span class="n">x</span><span class="p">)</span><span class="w">
        </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unlist</span><span class="p">(</span><span class="n">probsSort</span><span class="o">$</span><span class="n">ix</span><span class="p">)</span><span class="w"> 
        
        </span><span class="n">roc_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">true_Y</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span><span class="w">
        </span><span class="n">stack_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">cumsum</span><span class="p">(</span><span class="n">roc_y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="o">/</span><span class="nf">sum</span><span class="p">(</span><span class="n">roc_y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w">
        </span><span class="n">stack_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">cumsum</span><span class="p">(</span><span class="n">roc_y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="o">/</span><span class="nf">sum</span><span class="p">(</span><span class="n">roc_y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">   
        
        </span><span class="n">auc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">((</span><span class="n">stack_x</span><span class="p">[</span><span class="m">2</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">roc_y</span><span class="p">)]</span><span class="o">-</span><span class="n">stack_x</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">roc_y</span><span class="p">)</span><span class="m">-1</span><span class="p">])</span><span class="o">*</span><span class="n">stack_y</span><span class="p">[</span><span class="m">2</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">roc_y</span><span class="p">)])</span><span class="w">
        </span><span class="nf">return</span><span class="p">(</span><span class="n">auc</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
 
</span><span class="n">refAUC</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">GetROC_AUC</span><span class="p">(</span><span class="n">predictions</span><span class="p">[[</span><span class="m">2</span><span class="p">]],</span><span class="n">testDF</span><span class="p">[,</span><span class="n">outcomeName</span><span class="p">])</span><span class="w">
</span><span class="n">print</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s1">'AUC score:'</span><span class="p">,</span><span class="w"> </span><span class="n">refAUC</span><span class="p">))</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## [1] "AUC score: 0.855016305004227"
</code></pre>
</div>
<p><br /><br />
<strong>Shuffling with GBM</strong></p>

<p>Now we have a benchmark AUC score of <code class="highlighter-rouge">0.85</code>. We will use this score during every iteration of the shuffler to determine the effect of the scrambled variable:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="c1"># Shuffle predictions for variable importance
</span><span class="n">AUCShuffle</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">NULL</span><span class="w">
</span><span class="n">shuffletimes</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">500</span><span class="w">
 
</span><span class="n">featuresMeanAUCs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">()</span><span class="w">
</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">feature</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">predictorNames</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">featureAUCs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">()</span><span class="w">
        </span><span class="n">shuffledData</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">testDF</span><span class="p">[,</span><span class="n">predictorNames</span><span class="p">]</span><span class="w">
        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">iter</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">shuffletimes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="n">shuffledData</span><span class="p">[,</span><span class="n">feature</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sample</span><span class="p">(</span><span class="n">shuffledData</span><span class="p">[,</span><span class="n">feature</span><span class="p">],</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">shuffledData</span><span class="p">[,</span><span class="n">feature</span><span class="p">]))</span><span class="w">
                </span><span class="n">predictions</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">object</span><span class="o">=</span><span class="n">objGBM</span><span class="p">,</span><span class="w"> </span><span class="n">shuffledData</span><span class="p">[,</span><span class="n">predictorNames</span><span class="p">],</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s1">'prob'</span><span class="p">)</span><span class="w">
               </span><span class="n">featureAUCs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">featureAUCs</span><span class="p">,</span><span class="n">GetROC_AUC</span><span class="p">(</span><span class="n">predictions</span><span class="p">[[</span><span class="m">2</span><span class="p">]],</span><span class="w"> </span><span class="n">testDF</span><span class="p">[,</span><span class="n">outcomeName</span><span class="p">]))</span><span class="w">
        </span><span class="p">}</span><span class="w">
        </span><span class="n">featuresMeanAUCs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">featuresMeanAUCs</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">featureAUCs</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">refAUC</span><span class="p">))</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="n">AUCShuffle</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="s1">'feature'</span><span class="o">=</span><span class="n">predictorNames</span><span class="p">,</span><span class="w"> </span><span class="s1">'importance'</span><span class="o">=</span><span class="n">featuresMeanAUCs</span><span class="p">)</span><span class="w">
</span><span class="n">AUCShuffle</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">AUCShuffle</span><span class="p">[</span><span class="n">order</span><span class="p">(</span><span class="n">AUCShuffle</span><span class="o">$</span><span class="n">importance</span><span class="p">,</span><span class="w"> </span><span class="n">decreasing</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">),]</span><span class="w">
</span><span class="n">print</span><span class="p">(</span><span class="n">AUCShuffle</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>##          feature importance
## 3     PClass.3rd      1.000
## 5     Sex.female      1.000
## 8       Title.Mr      1.000
## 1     PClass.1st      0.924
## 4            Age      0.866
## 9      Title.Mrs      0.218
## 2     PClass.2nd      0.000
## 6       Sex.male      0.000
## 7     Title.Miss      0.000
## 10 Title.Nothing      0.000
</code></pre>
</div>

<p>There you have it, by iterating through each variable and scrambling them 200 times, the following 3 variables proved most important:<b>PClass.3rd, Sex.female, Title.Mr</b>.</p>

<p>Let’s put this in words one more time; we started by modeling our Titanic data set once with a GBM model and used the saved model to predict a reference (or benchmark) AUC score. With the saved benchmark and model, we created a loop to cycle through every variable in the set and predict the test set 200 times while scrambling the values of that variable each time.</p>

<p>The above code can easily be used with any other tree-based classifiers such as random forests.</p>

<p><strong>Shuffling with GLM</strong></p>

<p>Now let’s try this with a GLM model. You’ll see that the code is similar except we’ll be using the Root Mean Square Error (RMSE) score instead of an AUC score.</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="c1"># change a few things for a linear model
</span><span class="n">objControl</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">trainControl</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">'cv'</span><span class="p">,</span><span class="w"> </span><span class="n">number</span><span class="o">=</span><span class="m">2</span><span class="p">)</span><span class="w">
</span><span class="n">trainDF</span><span class="p">[,</span><span class="n">outcomeName</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">trainDF</span><span class="p">[,</span><span class="n">outcomeName</span><span class="p">]</span><span class="o">==</span><span class="s1">'yes'</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w">
 
</span><span class="c1"># shuffling with GLM
</span><span class="n">objGLM</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">train</span><span class="p">(</span><span class="n">trainDF</span><span class="p">[,</span><span class="n">predictorNames</span><span class="p">],</span><span class="w">  </span><span class="n">trainDF</span><span class="p">[,</span><span class="n">outcomeName</span><span class="p">],</span><span class="w">
                </span><span class="n">method</span><span class="o">=</span><span class="s1">'glm'</span><span class="p">,</span><span class="w">
                </span><span class="n">trControl</span><span class="o">=</span><span class="n">objControl</span><span class="p">,</span><span class="w">
                </span><span class="n">preProc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"center"</span><span class="p">,</span><span class="w"> </span><span class="s2">"scale"</span><span class="p">))</span><span class="w">

</span><span class="n">predictions</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">object</span><span class="o">=</span><span class="n">objGLM</span><span class="p">,</span><span class="w"> </span><span class="n">testDF</span><span class="p">[,</span><span class="n">predictorNames</span><span class="p">])</span><span class="w">
</span><span class="n">refRMSE</span><span class="o">=</span><span class="nf">sqrt</span><span class="p">((</span><span class="nf">sum</span><span class="p">((</span><span class="n">testDF</span><span class="p">[,</span><span class="n">outcomeName</span><span class="p">]</span><span class="o">-</span><span class="n">predictions</span><span class="p">[[</span><span class="m">2</span><span class="p">]])</span><span class="o">^</span><span class="m">2</span><span class="p">))</span><span class="o">/</span><span class="n">nrow</span><span class="p">(</span><span class="n">testDF</span><span class="p">))</span><span class="w">
</span><span class="n">print</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s1">'Reference RMSE:'</span><span class="p">,</span><span class="n">refRMSE</span><span class="p">))</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>## [1] "Reference RMSE: 0.4803244"
</code></pre>
</div>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="c1"># Shuffle predictions for variable importance
</span><span class="n">VariableImportanceShuffle</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">NULL</span><span class="w">
</span><span class="n">shuffletimes</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">500</span><span class="w">
</span><span class="n">featuresMeanRMSEs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">()</span><span class="w">
</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">feature</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">predictorNames</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
     </span><span class="n">featureRMSEs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">()</span><span class="w">
     </span><span class="n">shuffledData</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">testDF</span><span class="p">[,</span><span class="n">predictorNames</span><span class="p">]</span><span class="w">
     </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">iter</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">shuffletimes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="n">shuffledData</span><span class="p">[,</span><span class="n">feature</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sample</span><span class="p">(</span><span class="n">shuffledData</span><span class="p">[,</span><span class="n">feature</span><span class="p">],</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">shuffledData</span><span class="p">[,</span><span class="n">feature</span><span class="p">]))</span><span class="w">
          </span><span class="n">predictions</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">object</span><span class="o">=</span><span class="n">objGLM</span><span class="p">,</span><span class="w"> </span><span class="n">shuffledData</span><span class="p">[,</span><span class="n">predictorNames</span><span class="p">])</span><span class="w">
          </span><span class="n">featureRMSEs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">featureRMSEs</span><span class="p">,</span><span class="w"> </span><span class="nf">sqrt</span><span class="p">((</span><span class="nf">sum</span><span class="p">((</span><span class="n">testDF</span><span class="p">[,</span><span class="n">outcomeName</span><span class="p">]</span><span class="o">-</span><span class="n">predictions</span><span class="p">[[</span><span class="m">2</span><span class="p">]])</span><span class="o">^</span><span class="m">2</span><span class="p">))</span><span class="o">/</span><span class="n">nrow</span><span class="p">(</span><span class="n">testDF</span><span class="p">)))</span><span class="w">
     </span><span class="p">}</span><span class="w">
     </span><span class="n">featuresMeanRMSEs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">featuresMeanRMSEs</span><span class="p">,</span><span class="w">  </span><span class="n">mean</span><span class="p">((</span><span class="n">featureRMSEs</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">refRMSE</span><span class="p">)</span><span class="o">/</span><span class="n">refRMSE</span><span class="p">))</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre>
</div>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">VariableImportanceShuffle</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="s1">'feature'</span><span class="o">=</span><span class="n">predictorNames</span><span class="p">,</span><span class="w"> </span><span class="s1">'RMSE_Importance'</span><span class="o">=</span><span class="n">featuresMeanRMSEs</span><span class="p">)</span><span class="w">
</span><span class="n">VariableImportanceShuffle</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">VariableImportanceShuffle</span><span class="p">[</span><span class="n">order</span><span class="p">(</span><span class="n">VariableImportanceShuffle</span><span class="o">$</span><span class="n">RMSE_Importance</span><span class="p">,</span><span class="n">decreasing</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">),]</span><span class="w">
</span><span class="n">print</span><span class="p">(</span><span class="n">VariableImportanceShuffle</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>##          feature RMSE_Importance
## 1     PClass.1st    0.2334582971
## 8       Title.Mr    0.0338742797
## 5     Sex.female    0.0301143113
## 2     PClass.2nd    0.0161501428
## 4            Age    0.0080605542
## 7     Title.Miss    0.0017299712
## 9      Title.Mrs    0.0007030486
## 3     PClass.3rd    0.0000000000
## 6       Sex.male    0.0000000000
## 10 Title.Nothing    0.0000000000
</code></pre>
</div>
<p><br /><br />
The code is almost the same (except for the scoring formula) but the results are different which is to be expected when using two different models (tree based versus linear).</p>

<p>As a bonus, here is a great package for quick variable importance. I won’t go into any details but I recommend it for its speed!</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="c1"># bonus - great package for fast variable importance
</span><span class="n">library</span><span class="p">(</span><span class="n">mRMRe</span><span class="p">)</span><span class="w">
</span><span class="n">ind</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sapply</span><span class="p">(</span><span class="n">titanicDF</span><span class="p">,</span><span class="w"> </span><span class="n">is.integer</span><span class="p">)</span><span class="w">
</span><span class="n">titanicDF</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lapply</span><span class="p">(</span><span class="n">titanicDF</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span><span class="w"> </span><span class="n">as.numeric</span><span class="p">)</span><span class="w">
</span><span class="n">dd</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mRMR.data</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">titanicDF</span><span class="p">)</span><span class="w">
</span><span class="n">feats</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mRMR.classic</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dd</span><span class="p">,</span><span class="w"> </span><span class="n">target_indices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">ncol</span><span class="p">(</span><span class="n">titanicDF</span><span class="p">)),</span><span class="w"> </span><span class="n">feature_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">)</span><span class="w">
</span><span class="n">variableImportance</span><span class="w"> </span><span class="o">&lt;-</span><span class="n">data.frame</span><span class="p">(</span><span class="s1">'importance'</span><span class="o">=</span><span class="n">feats</span><span class="o">@</span><span class="n">mi_matrix</span><span class="p">[</span><span class="n">nrow</span><span class="p">(</span><span class="n">feats</span><span class="o">@</span><span class="n">mi_matrix</span><span class="p">),])</span><span class="w">
</span><span class="n">variableImportance</span><span class="o">$</span><span class="n">feature</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rownames</span><span class="p">(</span><span class="n">variableImportance</span><span class="p">)</span><span class="w">
</span><span class="n">row.names</span><span class="p">(</span><span class="n">variableImportance</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">NULL</span><span class="w">
</span><span class="n">variableImportance</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">na.omit</span><span class="p">(</span><span class="n">variableImportance</span><span class="p">)</span><span class="w">
</span><span class="n">variableImportance</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">variableImportance</span><span class="p">[</span><span class="n">order</span><span class="p">(</span><span class="n">variableImportance</span><span class="o">$</span><span class="n">importance</span><span class="p">,</span><span class="w"> </span><span class="n">decreasing</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">),]</span><span class="w">
</span><span class="n">print</span><span class="p">(</span><span class="n">variableImportance</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code>##     importance       feature
## 5   0.50289113    Sex.female
## 9   0.35928727     Title.Mrs
## 1   0.30824025    PClass.1st
## 7   0.24287839    Title.Miss
## 2   0.09024881    PClass.2nd
## 10  0.05892875 Title.Nothing
## 4  -0.02888115           Age
## 3  -0.34033536    PClass.3rd
## 8  -0.48448426      Title.Mr
## 6  -0.50289113      Sex.male
</code></pre>
</div>
<p><br /><br />
Enjoy!!
<br /><br />      <br />
<a id="sourcecode">Full source code (<a href=" https://github.com/amunategui/variable-importance-shuffling" target="_blank">also on GitHub</a>)</a>:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="w">
</span><span class="c1"># using dataset from the UCI Machine Learning Repository (http://archive.ics.uci.edu/ml/)
</span><span class="n">titanicDF</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">read.csv</span><span class="p">(</span><span class="s1">'http://math.ucdenver.edu/RTutorial/titanic.txt'</span><span class="p">,</span><span class="n">sep</span><span class="o">=</span><span class="s1">'\t'</span><span class="p">)</span><span class="w">

</span><span class="c1"># creating new title feature
</span><span class="n">titanicDF</span><span class="o">$</span><span class="n">Title</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">grepl</span><span class="p">(</span><span class="s1">'Mr '</span><span class="p">,</span><span class="n">titanicDF</span><span class="o">$</span><span class="n">Name</span><span class="p">),</span><span class="s1">'Mr'</span><span class="p">,</span><span class="n">ifelse</span><span class="p">(</span><span class="n">grepl</span><span class="p">(</span><span class="s1">'Mrs '</span><span class="p">,</span><span class="n">titanicDF</span><span class="o">$</span><span class="n">Name</span><span class="p">),</span><span class="s1">'Mrs'</span><span class="p">,</span><span class="n">ifelse</span><span class="p">(</span><span class="n">grepl</span><span class="p">(</span><span class="s1">'Miss'</span><span class="p">,</span><span class="n">titanicDF</span><span class="o">$</span><span class="n">Name</span><span class="p">),</span><span class="s1">'Miss'</span><span class="p">,</span><span class="s1">'Nothing'</span><span class="p">)))</span><span class="w">
</span><span class="n">titanicDF</span><span class="o">$</span><span class="n">Title</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.factor</span><span class="p">(</span><span class="n">titanicDF</span><span class="o">$</span><span class="n">Title</span><span class="p">)</span><span class="w">
 
</span><span class="c1"># impute age to remove NAs
</span><span class="n">titanicDF</span><span class="o">$</span><span class="n">Age</span><span class="p">[</span><span class="nf">is.na</span><span class="p">(</span><span class="n">titanicDF</span><span class="o">$</span><span class="n">Age</span><span class="p">)]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">median</span><span class="p">(</span><span class="n">titanicDF</span><span class="o">$</span><span class="n">Age</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="o">=</span><span class="nb">T</span><span class="p">)</span><span class="w">
 
</span><span class="c1"># reorder data set so target is last column
</span><span class="n">titanicDF</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">titanicDF</span><span class="p">[</span><span class="nf">c</span><span class="p">(</span><span class="s1">'PClass'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Age'</span><span class="p">,</span><span class="w">    </span><span class="s1">'Sex'</span><span class="p">,</span><span class="w">   </span><span class="s1">'Title'</span><span class="p">,</span><span class="w"> </span><span class="s1">'Survived'</span><span class="p">)]</span><span class="w">
 
</span><span class="c1"># binarize all factors
</span><span class="n">library</span><span class="p">(</span><span class="n">caret</span><span class="p">)</span><span class="w">
</span><span class="n">titanicDummy</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">dummyVars</span><span class="p">(</span><span class="s2">"~."</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">titanicDF</span><span class="p">,</span><span class="w"> </span><span class="n">fullRank</span><span class="o">=</span><span class="nb">F</span><span class="p">)</span><span class="w">
</span><span class="n">titanicDF</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">as.data.frame</span><span class="p">(</span><span class="n">predict</span><span class="p">(</span><span class="n">titanicDummy</span><span class="p">,</span><span class="n">titanicDF</span><span class="p">))</span><span class="w">

</span><span class="c1"># Let's take a peek at our data:
</span><span class="n">str</span><span class="p">(</span><span class="n">titanicDF</span><span class="p">)</span><span class="w">
 
</span><span class="c1"># split data set into train and test portion
</span><span class="n">set.seed</span><span class="p">(</span><span class="m">1234</span><span class="p">)</span><span class="w">
</span><span class="n">splitIndex</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sample</span><span class="p">(</span><span class="n">nrow</span><span class="p">(</span><span class="n">titanicDF</span><span class="p">),</span><span class="w"> </span><span class="nf">floor</span><span class="p">(</span><span class="m">0.5</span><span class="o">*</span><span class="n">nrow</span><span class="p">(</span><span class="n">titanicDF</span><span class="p">)))</span><span class="w">
</span><span class="n">trainDF</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">titanicDF</span><span class="p">[</span><span class="w"> </span><span class="n">splitIndex</span><span class="p">,]</span><span class="w">
</span><span class="n">testDF</span><span class="w">  </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">titanicDF</span><span class="p">[</span><span class="o">-</span><span class="n">splitIndex</span><span class="p">,]</span><span class="w">
 
</span><span class="n">outcomeName</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s1">'Survived'</span><span class="w">
</span><span class="n">predictorNames</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">setdiff</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">trainDF</span><span class="p">),</span><span class="n">outcomeName</span><span class="p">)</span><span class="w">
 
</span><span class="c1"># transform outcome variable to text as this is required in caret for classification 
</span><span class="n">trainDF</span><span class="p">[,</span><span class="n">outcomeName</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">trainDF</span><span class="p">[,</span><span class="n">outcomeName</span><span class="p">]</span><span class="o">==</span><span class="m">1</span><span class="p">,</span><span class="s1">'yes'</span><span class="p">,</span><span class="s1">'nope'</span><span class="p">)</span><span class="w">
 
</span><span class="c1"># create caret trainControl object to control the number of cross-validations performed
</span><span class="n">objControl</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">trainControl</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">'cv'</span><span class="p">,</span><span class="w"> </span><span class="n">number</span><span class="o">=</span><span class="m">2</span><span class="p">,</span><span class="w"> </span><span class="n">returnResamp</span><span class="o">=</span><span class="s1">'none'</span><span class="p">,</span><span class="w"> </span><span class="n">summaryFunction</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">twoClassSummary</span><span class="p">,</span><span class="w"> </span><span class="n">classProbs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
 
</span><span class="c1"># shuffling with GBM
</span><span class="n">objGBM</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">train</span><span class="p">(</span><span class="n">trainDF</span><span class="p">[,</span><span class="n">predictorNames</span><span class="p">],</span><span class="w">  </span><span class="n">as.factor</span><span class="p">(</span><span class="n">trainDF</span><span class="p">[,</span><span class="n">outcomeName</span><span class="p">]),</span><span class="w">
                </span><span class="n">method</span><span class="o">=</span><span class="s1">'gbm'</span><span class="p">,</span><span class="w">
                </span><span class="n">trControl</span><span class="o">=</span><span class="n">objControl</span><span class="p">,</span><span class="w">
                </span><span class="n">metric</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"ROC"</span><span class="p">,</span><span class="w">
                </span><span class="n">tuneGrid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">expand.grid</span><span class="p">(</span><span class="n">n.trees</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="n">interaction.depth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="n">shrinkage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">)</span><span class="w">
</span><span class="p">)</span><span class="w">

</span><span class="n">predictions</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">object</span><span class="o">=</span><span class="n">objGBM</span><span class="p">,</span><span class="w"> </span><span class="n">testDF</span><span class="p">[,</span><span class="n">predictorNames</span><span class="p">],</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s1">'prob'</span><span class="p">)</span><span class="w">

</span><span class="n">GetROC_AUC</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span><span class="w"> </span><span class="n">true_Y</span><span class="p">){</span><span class="w">
        </span><span class="c1"># AUC approximation
</span><span class="w">        </span><span class="c1"># http://stackoverflow.com/questions/4903092/calculate-auc-in-r
</span><span class="w">        </span><span class="c1"># ty AGS
</span><span class="w">        </span><span class="n">probsSort</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sort</span><span class="p">(</span><span class="n">probs</span><span class="p">,</span><span class="w"> </span><span class="n">decreasing</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">index.return</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w">
        </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unlist</span><span class="p">(</span><span class="n">probsSort</span><span class="o">$</span><span class="n">x</span><span class="p">)</span><span class="w">
        </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">unlist</span><span class="p">(</span><span class="n">probsSort</span><span class="o">$</span><span class="n">ix</span><span class="p">)</span><span class="w"> 
        
        </span><span class="n">roc_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">true_Y</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span><span class="w">
        </span><span class="n">stack_x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">cumsum</span><span class="p">(</span><span class="n">roc_y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="o">/</span><span class="nf">sum</span><span class="p">(</span><span class="n">roc_y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w">
        </span><span class="n">stack_y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">cumsum</span><span class="p">(</span><span class="n">roc_y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="o">/</span><span class="nf">sum</span><span class="p">(</span><span class="n">roc_y</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w">   
        
        </span><span class="n">auc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">sum</span><span class="p">((</span><span class="n">stack_x</span><span class="p">[</span><span class="m">2</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">roc_y</span><span class="p">)]</span><span class="o">-</span><span class="n">stack_x</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">roc_y</span><span class="p">)</span><span class="m">-1</span><span class="p">])</span><span class="o">*</span><span class="n">stack_y</span><span class="p">[</span><span class="m">2</span><span class="o">:</span><span class="nf">length</span><span class="p">(</span><span class="n">roc_y</span><span class="p">)])</span><span class="w">
        </span><span class="nf">return</span><span class="p">(</span><span class="n">auc</span><span class="p">)</span><span class="w">
</span><span class="p">}</span><span class="w">
 
</span><span class="n">refAUC</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">GetROC_AUC</span><span class="p">(</span><span class="n">predictions</span><span class="p">[[</span><span class="m">2</span><span class="p">]],</span><span class="n">testDF</span><span class="p">[,</span><span class="n">outcomeName</span><span class="p">])</span><span class="w">
</span><span class="n">print</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s1">'AUC score:'</span><span class="p">,</span><span class="w"> </span><span class="n">refAUC</span><span class="p">))</span><span class="w">
  
</span><span class="c1"># Shuffle predictions for variable importance
</span><span class="n">AUCShuffle</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">NULL</span><span class="w">
</span><span class="n">shuffletimes</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">500</span><span class="w">
 
</span><span class="n">featuresMeanAUCs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">()</span><span class="w">
</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">feature</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">predictorNames</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="n">featureAUCs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">()</span><span class="w">
        </span><span class="n">shuffledData</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">testDF</span><span class="p">[,</span><span class="n">predictorNames</span><span class="p">]</span><span class="w">
        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">iter</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">shuffletimes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
                </span><span class="n">shuffledData</span><span class="p">[,</span><span class="n">feature</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sample</span><span class="p">(</span><span class="n">shuffledData</span><span class="p">[,</span><span class="n">feature</span><span class="p">],</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">shuffledData</span><span class="p">[,</span><span class="n">feature</span><span class="p">]))</span><span class="w">
                </span><span class="n">predictions</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">object</span><span class="o">=</span><span class="n">objGBM</span><span class="p">,</span><span class="w"> </span><span class="n">shuffledData</span><span class="p">[,</span><span class="n">predictorNames</span><span class="p">],</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s1">'prob'</span><span class="p">)</span><span class="w">
               </span><span class="n">featureAUCs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">featureAUCs</span><span class="p">,</span><span class="n">GetROC_AUC</span><span class="p">(</span><span class="n">predictions</span><span class="p">[[</span><span class="m">2</span><span class="p">]],</span><span class="w"> </span><span class="n">testDF</span><span class="p">[,</span><span class="n">outcomeName</span><span class="p">]))</span><span class="w">
        </span><span class="p">}</span><span class="w">
        </span><span class="n">featuresMeanAUCs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">featuresMeanAUCs</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="p">(</span><span class="n">featureAUCs</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">refAUC</span><span class="p">))</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="n">AUCShuffle</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="s1">'feature'</span><span class="o">=</span><span class="n">predictorNames</span><span class="p">,</span><span class="w"> </span><span class="s1">'importance'</span><span class="o">=</span><span class="n">featuresMeanAUCs</span><span class="p">)</span><span class="w">
</span><span class="n">AUCShuffle</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">AUCShuffle</span><span class="p">[</span><span class="n">order</span><span class="p">(</span><span class="n">AUCShuffle</span><span class="o">$</span><span class="n">importance</span><span class="p">,</span><span class="w"> </span><span class="n">decreasing</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">),]</span><span class="w">
</span><span class="n">print</span><span class="p">(</span><span class="n">AUCShuffle</span><span class="p">)</span><span class="w">
 
</span><span class="c1"># shuffling with GLM
# change a few things for a linear model
</span><span class="n">objControl</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">trainControl</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">'cv'</span><span class="p">,</span><span class="w"> </span><span class="n">number</span><span class="o">=</span><span class="m">2</span><span class="p">)</span><span class="w">
</span><span class="n">trainDF</span><span class="p">[,</span><span class="n">outcomeName</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">ifelse</span><span class="p">(</span><span class="n">trainDF</span><span class="p">[,</span><span class="n">outcomeName</span><span class="p">]</span><span class="o">==</span><span class="s1">'yes'</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w">
 
</span><span class="c1"># GLM
</span><span class="n">objGLM</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">train</span><span class="p">(</span><span class="n">trainDF</span><span class="p">[,</span><span class="n">predictorNames</span><span class="p">],</span><span class="w">  </span><span class="n">trainDF</span><span class="p">[,</span><span class="n">outcomeName</span><span class="p">],</span><span class="w">
                </span><span class="n">method</span><span class="o">=</span><span class="s1">'glm'</span><span class="p">,</span><span class="w">
                </span><span class="n">trControl</span><span class="o">=</span><span class="n">objControl</span><span class="p">,</span><span class="w">
                </span><span class="n">preProc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s2">"center"</span><span class="p">,</span><span class="w"> </span><span class="s2">"scale"</span><span class="p">))</span><span class="w">
 
</span><span class="n">predictions</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">object</span><span class="o">=</span><span class="n">objGLM</span><span class="p">,</span><span class="w"> </span><span class="n">testDF</span><span class="p">[,</span><span class="n">predictorNames</span><span class="p">])</span><span class="w">
</span><span class="n">refRMSE</span><span class="o">=</span><span class="nf">sqrt</span><span class="p">((</span><span class="nf">sum</span><span class="p">((</span><span class="n">testDF</span><span class="p">[,</span><span class="n">outcomeName</span><span class="p">]</span><span class="o">-</span><span class="n">predictions</span><span class="p">[[</span><span class="m">2</span><span class="p">]])</span><span class="o">^</span><span class="m">2</span><span class="p">))</span><span class="o">/</span><span class="n">nrow</span><span class="p">(</span><span class="n">testDF</span><span class="p">))</span><span class="w">
 
</span><span class="n">VariableImportanceShuffle</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">NULL</span><span class="w">
 
</span><span class="n">print</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s1">'Reference RMSE:'</span><span class="p">,</span><span class="n">refRMSE</span><span class="p">))</span><span class="w">
 
</span><span class="n">shuffletimes</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">500</span><span class="w">
</span><span class="n">featuresMeanRMSEs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">()</span><span class="w">
</span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">feature</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">predictorNames</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
     </span><span class="n">featureRMSEs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">()</span><span class="w">
     </span><span class="n">shuffledData</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">testDF</span><span class="p">[,</span><span class="n">predictorNames</span><span class="p">]</span><span class="w">
     </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">iter</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="m">1</span><span class="o">:</span><span class="n">shuffletimes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="n">shuffledData</span><span class="p">[,</span><span class="n">feature</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sample</span><span class="p">(</span><span class="n">shuffledData</span><span class="p">[,</span><span class="n">feature</span><span class="p">],</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">shuffledData</span><span class="p">[,</span><span class="n">feature</span><span class="p">]))</span><span class="w">
          </span><span class="n">predictions</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">predict</span><span class="p">(</span><span class="n">object</span><span class="o">=</span><span class="n">objGLM</span><span class="p">,</span><span class="w"> </span><span class="n">shuffledData</span><span class="p">[,</span><span class="n">predictorNames</span><span class="p">])</span><span class="w">
          </span><span class="n">featureRMSEs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">featureRMSEs</span><span class="p">,</span><span class="w"> </span><span class="nf">sqrt</span><span class="p">((</span><span class="nf">sum</span><span class="p">((</span><span class="n">testDF</span><span class="p">[,</span><span class="n">outcomeName</span><span class="p">]</span><span class="o">-</span><span class="n">predictions</span><span class="p">[[</span><span class="m">2</span><span class="p">]])</span><span class="o">^</span><span class="m">2</span><span class="p">))</span><span class="o">/</span><span class="n">nrow</span><span class="p">(</span><span class="n">testDF</span><span class="p">)))</span><span class="w">
     </span><span class="p">}</span><span class="w">
     </span><span class="n">featuresMeanRMSEs</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">featuresMeanRMSEs</span><span class="p">,</span><span class="w">  </span><span class="n">mean</span><span class="p">((</span><span class="n">featureRMSEs</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">refRMSE</span><span class="p">)</span><span class="o">/</span><span class="n">refRMSE</span><span class="p">))</span><span class="w">
</span><span class="p">}</span><span class="w">
</span><span class="n">VariableImportanceShuffle</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data.frame</span><span class="p">(</span><span class="s1">'feature'</span><span class="o">=</span><span class="n">predictorNames</span><span class="p">,</span><span class="w"> </span><span class="s1">'RMSE_Importance'</span><span class="o">=</span><span class="n">featuresMeanRMSEs</span><span class="p">)</span><span class="w">
</span><span class="n">VariableImportanceShuffle</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> 
        </span><span class="n">VariableImportanceShuffle</span><span class="p">[</span><span class="n">order</span><span class="p">(</span><span class="n">VariableImportanceShuffle</span><span class="o">$</span><span class="n">RMSE_Importance</span><span class="p">,</span><span class="n">decreasing</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">),]</span><span class="w">
</span><span class="n">print</span><span class="p">(</span><span class="n">VariableImportanceShuffle</span><span class="p">)</span><span class="w">


</span><span class="c1"># bonus - great package for fast variable importance
</span><span class="n">library</span><span class="p">(</span><span class="n">mRMRe</span><span class="p">)</span><span class="w">
</span><span class="n">ind</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sapply</span><span class="p">(</span><span class="n">titanicDF</span><span class="p">,</span><span class="w"> </span><span class="n">is.integer</span><span class="p">)</span><span class="w">
</span><span class="n">titanicDF</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">lapply</span><span class="p">(</span><span class="n">titanicDF</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span><span class="w"> </span><span class="n">as.numeric</span><span class="p">)</span><span class="w">
</span><span class="n">dd</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mRMR.data</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">titanicDF</span><span class="p">)</span><span class="w">
</span><span class="n">feats</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mRMR.classic</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dd</span><span class="p">,</span><span class="w"> </span><span class="n">target_indices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="n">ncol</span><span class="p">(</span><span class="n">titanicDF</span><span class="p">)),</span><span class="w"> </span><span class="n">feature_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">)</span><span class="w">
</span><span class="n">variableImportance</span><span class="w"> </span><span class="o">&lt;-</span><span class="n">data.frame</span><span class="p">(</span><span class="s1">'importance'</span><span class="o">=</span><span class="n">feats</span><span class="o">@</span><span class="n">mi_matrix</span><span class="p">[</span><span class="n">nrow</span><span class="p">(</span><span class="n">feats</span><span class="o">@</span><span class="n">mi_matrix</span><span class="p">),])</span><span class="w">
</span><span class="n">variableImportance</span><span class="o">$</span><span class="n">feature</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rownames</span><span class="p">(</span><span class="n">variableImportance</span><span class="p">)</span><span class="w">
</span><span class="n">row.names</span><span class="p">(</span><span class="n">variableImportance</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">NULL</span><span class="w">
</span><span class="n">variableImportance</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">na.omit</span><span class="p">(</span><span class="n">variableImportance</span><span class="p">)</span><span class="w">
</span><span class="n">variableImportance</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">variableImportance</span><span class="p">[</span><span class="n">order</span><span class="p">(</span><span class="n">variableImportance</span><span class="o">$</span><span class="n">importance</span><span class="p">,</span><span class="w"> </span><span class="n">decreasing</span><span class="o">=</span><span class="kc">TRUE</span><span class="p">),]</span><span class="w">
</span><span class="n">print</span><span class="p">(</span><span class="n">variableImportance</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>

		
</div>
    

		</div>		 
	 </div>   
 
</main>


    <BR><BR>
    <footer class="text-muted">
      <div class="container">
        <p class="float-right">
          <a href="#">Back to top</a>
        </p>
        <p>&copy; Manuel Amunategui</p>
        <p>All articles and walkthroughs are posted for entertainment and education only - use at your own risk. I unfortunately don't have time to respond to support questions, please post them on Stackoverflow or in the comments of the corresponding YouTube videos and the community may help you out. Happy learning!</p>
      </div>
    </footer>

    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.0/umd/popper.min.js" integrity="sha384-cs/chFZiN24E4KMATLdqdvsezGxaGsi4hLGOzlXwp5UZB1LY//20VyM2taTB4QvJ" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.0/js/bootstrap.min.js" integrity="sha384-uefMccjFJAIv6A+rW+L4AHf99KvxDjWSu1z9VI8SKNVmz4sk7buKt/6v9KI65qnm" crossorigin="anonymous"></script>
     <script src="http://holderjs.com/holder.js"></script>
  </body>
</html>
